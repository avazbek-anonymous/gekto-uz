<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BPS.system ‚Äî Kassa</title>

    <style>
        :root {
            --bg: #07121b;
            --card: rgba(255, 255, 255, .06);
            --line: rgba(255, 255, 255, .10);
            --text: rgba(255, 255, 255, .92);
            --muted: rgba(255, 255, 255, .65);
            --ok: #10b981;
            --bad: #f16262;
            /* –º—è–≥–∫–∏–π –∫—Ä–∞—Å–Ω—ã–π */
            --shadow: 0 10px 30px rgba(0, 0, 0, .25);
            --r: 16px;
            --gap: 12px;
            --sidebar-collapsed: 64px;
            --sidebar-expanded: 230px;
            --topH: 35vh;
            --bottomH: 65vh;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background:
                radial-gradient(1000px 520px at 18% 12%, rgba(16, 185, 129, .18), transparent 60%),
                radial-gradient(900px 520px at 88% 38%, rgba(59, 130, 246, .14), transparent 55%),
                var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            overflow: hidden;
        }

        .appShell {
            height: 100vh;
            display: flex;
            min-height: 0;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-collapsed);
            transition: width .22s ease;
            border-right: 1px solid rgba(255, 255, 255, .10);
            background: rgba(255, 255, 255, .04);
            backdrop-filter: blur(10px);
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
        }

        .sidebar:hover {
            width: var(--sidebar-expanded);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 10px;
            border-radius: 14px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid rgba(255, 255, 255, .10);
        }

        .brandLogo {
            width: 34px;
            height: 34px;
            border-radius: 12px;
            background: rgba(16, 185, 129, .18);
            border: 1px solid rgba(16, 185, 129, .30);
            display: grid;
            place-items: center;
            font-weight: 900;
            color: rgba(16, 185, 129, .95);
            flex: 0 0 34px;
        }

        .brandText {
            font-weight: 900;
            letter-spacing: .2px;
            white-space: nowrap;
            overflow: hidden;
            opacity: 0;
            transform: translateX(-4px);
            transition: opacity .16s ease, transform .16s ease;
        }

        .sidebar:hover .brandText {
            opacity: 1;
            transform: translateX(0);
        }

        .nav {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding-top: 6px;
            min-height: 0;
        }

        .navItem {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 10px;
            border-radius: 14px;
            color: rgba(255, 255, 255, .85);
            text-decoration: none;
            border: 1px solid transparent;
        }

        .navItem:hover {
            background: rgba(255, 255, 255, .05);
            border-color: rgba(255, 255, 255, .08);
        }

        .navItem.active {
            background: rgba(16, 185, 129, .12);
            border-color: rgba(16, 185, 129, .28);
            color: rgba(255, 255, 255, .95);
        }

        .navIcon {
            width: 22px;
            height: 22px;
            display: grid;
            place-items: center;
            flex: 0 0 22px;
        }

        .navText {
            white-space: nowrap;
            overflow: hidden;
            opacity: 0;
            transform: translateX(-4px);
            transition: opacity .16s ease, transform .16s ease;
        }

        .sidebar:hover .navText {
            opacity: 1;
            transform: translateX(0);
        }

        /* Main */
        .main {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .topHeader {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 12px 14px;
            border-bottom: 1px solid rgba(255, 255, 255, .08);
            background: rgba(255, 255, 255, .03);
            backdrop-filter: blur(10px);
        }

        .hdrLeft {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .hdrTitle {
            font-weight: 1000;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .hdrSub {
            font-size: 12px;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .hdrRight {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 9px 12px;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, .04);
            color: var(--muted);
            font-size: 13px;
            white-space: nowrap;
        }

        .pill.ok {
            color: rgba(16, 185, 129, .95);
            border-color: rgba(16, 185, 129, .30);
            background: rgba(16, 185, 129, .10);
        }

        .pill.err {
            color: rgba(241, 98, 98, .95);
            border-color: rgba(241, 98, 98, .28);
            background: rgba(241, 98, 98, .10);
        }

        .btn {
            border: 0;
            border-radius: 12px;
            padding: 9px 12px;
            font-weight: 900;
            cursor: pointer;
            background: rgba(255, 255, 255, .08);
            color: rgba(255, 255, 255, .92);
            border: 1px solid rgba(255, 255, 255, .10);
            white-space: nowrap;
        }

        .btn.primary {
            background: var(--ok);
            color: #062a1b;
            border-color: rgba(16, 185, 129, .35);
            box-shadow: var(--shadow);
        }

        .btn.danger {
            background: rgba(241, 98, 98, .14);
            border-color: rgba(241, 98, 98, .28);
        }

        .btn:disabled {
            opacity: .7;
            cursor: not-allowed;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, .18);
            border-top-color: rgba(255, 255, 255, .75);
            animation: spin .8s linear infinite;
            flex: 0 0 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .content {
            flex: 1;
            min-height: 0;
            padding: var(--gap);
            display: flex;
            flex-direction: column;
            gap: var(--gap);
            overflow: hidden;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--r);
            min-height: 0;
        }

        .topArea {
            height: var(--topH);
            min-height: 260px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--gap);
            min-height: 0;
        }

        .balancesCard,
        .filtersCard,
        .catCard {
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
        }

        .cardTitleRow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .cardTitle {
            font-weight: 1000;
            font-size: 14px;
        }

        .muted {
            color: rgba(255, 255, 255, .62);
            font-size: 12px;
        }

        /* balances list */
        .balList {
            display: grid;
            gap: 10px;
            overflow: auto;
            padding-right: 2px;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, .22) transparent;
        }

        .balList::-webkit-scrollbar {
            width: 10px;
        }

        .balList::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .12);
            border-radius: 999px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .balList:hover::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .30);
            background-clip: content-box;
        }

        .balItem {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(255, 255, 255, .04);
        }

        .balItem .w {
            font-weight: 900;
        }

        .nums {
            text-align: right;
            font-family: ui-monospace, Menlo, Consolas, monospace;
            line-height: 1.25;
        }

        /* filters */
        .filtersGrid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .filtersGrid .full {
            grid-column: 1 / -1;
        }

        .field {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(255, 255, 255, .04);
            min-height: 40px;
        }

        .field label {
            font-size: 12px;
            color: var(--muted);
            white-space: nowrap;
        }

        .field input,
        .field select {
            width: 100%;
            min-width: 0;
            border: 0;
            outline: none;
            background: transparent;
            color: rgba(255, 255, 255, .92);
            font-size: 13px;
            padding: 0;
        }

        input[type="date"] {
            color: rgba(255, 255, 255, .92);
        }

        /* readable selects */
        select {
            background: rgba(10, 18, 26, .65);
            border-radius: 10px;
            padding: 6px 10px;
            color: rgba(255, 255, 255, .92);
            border: 1px solid rgba(255, 255, 255, .12);
        }

        option {
            color: #0b1220;
            background: #fff;
        }

        /* datalist input style */
        .combo {
            background: rgba(10, 18, 26, .65);
            border-radius: 10px;
            padding: 6px 10px;
            border: 1px solid rgba(255, 255, 255, .12);
            color: rgba(255, 255, 255, .92);
            font-size: 13px;
            width: 100%;
            outline: none;
        }

        /* category summary */
        .catTotals {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .totBox {
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(255, 255, 255, .04);
            min-height: 54px;
        }

        .totLbl {
            font-size: 11px;
            color: rgba(255, 255, 255, .68);
            text-transform: uppercase;
            font-weight: 900;
        }

        .totVal {
            margin-top: 6px;
            font-weight: 1000;
            font-size: 13px;
            font-family: ui-monospace, Menlo, Consolas, monospace;
        }

        .in {
            color: rgba(16, 185, 129, .95);
        }

        .out {
            color: rgba(241, 98, 98, .95);
        }

        .catListWrap {
            overflow: auto;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(255, 255, 255, .03);
            border-radius: 12px;
            min-height: 0;
            flex: 1;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, .22) transparent;
        }

        .catListWrap::-webkit-scrollbar {
            width: 10px;
        }

        .catListWrap::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .12);
            border-radius: 999px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .catListWrap:hover::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .30);
            background-clip: content-box;
        }

        .catTable {
            width: 100%;
            border-collapse: collapse;
        }

        .catTable thead th {
            position: sticky;
            top: 0;
            z-index: 2;
            text-align: left;
            padding: 10px 10px;
            font-size: 11px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, .72);
            background: rgba(10, 18, 26, .96);
            border-bottom: 1px solid rgba(255, 255, 255, .10);
            white-space: nowrap;
        }

        .catTable tbody td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, .06);
            font-size: 12px;
            white-space: nowrap;
        }

        .catName {
            font-weight: 900;
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* bottom table */
        .bottomArea {
            height: var(--bottomH);
            min-height: 320px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .tableScroll {
            flex: 1;
            min-height: 0;
            overflow: auto;
            scrollbar-gutter: stable;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, .22) transparent;
        }

        .tableScroll::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        .tableScroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .12);
            border-radius: 999px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .tableScroll:hover::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .30);
            background-clip: content-box;
        }

        table.opsTable {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }

        table.opsTable thead th {
            position: sticky;
            top: 0;
            z-index: 2;
            text-align: left;
            padding: 10px 12px;
            font-size: 11px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, .72);
            background: rgba(10, 18, 26, .96);
            border-bottom: 1px solid rgba(255, 255, 255, .10);
            white-space: nowrap;
        }

        table.opsTable tbody td {
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, .06);
            font-size: 13px;
            white-space: nowrap;
            max-width: 420px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        table.opsTable tbody tr:hover td {
            background: rgba(255, 255, 255, .03);
        }

        .mono {
            font-family: ui-monospace, Menlo, Consolas, monospace;
        }

        .amtIn {
            color: rgba(16, 185, 129, .95);
            font-weight: 900;
        }

        .amtOut {
            color: rgba(241, 98, 98, .95);
            font-weight: 900;
        }

        .empty {
            padding: 16px 12px;
            color: var(--muted);
            font-size: 13px;
        }

        /* Mobile –º–µ–Ω—é */
        .burger {
            display: none;
            width: 42px;
            height: 38px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .06);
            color: rgba(255, 255, 255, .92);
            cursor: pointer;
        }

        .mobileMenuOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .45);
            z-index: 70;
            display: none;
        }

        .mobileMenu {
            width: 78%;
            max-width: 320px;
            height: 100%;
            background: rgba(8, 16, 24, .95);
            border-right: 1px solid rgba(255, 255, 255, .12);
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mNav a {
            display: block;
            padding: 12px 12px;
            border-radius: 14px;
            text-decoration: none;
            color: rgba(255, 255, 255, .92);
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(255, 255, 255, .05);
            font-weight: 900;
        }

        .mNav a.active {
            background: rgba(16, 185, 129, .12);
            border-color: rgba(16, 185, 129, .30);
        }

        /* mobile ops cards */
        .opsCards {
            display: none;
            padding: 12px;
            gap: 10px;
        }

        .opCard {
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(255, 255, 255, .04);
            border-radius: 14px;
            padding: 12px;
            display: grid;
            gap: 6px;
        }

        .opTop {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            font-weight: 900;
        }

        .opMid {
            color: rgba(255, 255, 255, .78);
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .opNote {
            color: rgba(255, 255, 255, .70);
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .opAmts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 4px;
            font-family: ui-monospace, Menlo, Consolas, monospace;
            font-size: 12px;
        }

        .opAmts .box {
            border: 1px solid rgba(255, 255, 255, .10);
            border-radius: 12px;
            padding: 8px 10px;
            background: rgba(255, 255, 255, .03);
        }

        .opAmts .lbl {
            color: rgba(255, 255, 255, .62);
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 900;
        }

        .opAmts .val {
            margin-top: 4px;
            font-weight: 1000;
        }

        /* =======================
   MOBILE FIX v2 (—Ç–æ–ª—å–∫–æ –º–æ–±–∏–ª–∫–∞)
   –ü–ö –ù–ï —Ç—Ä–æ–≥–∞–µ–º ‚Äî –≤—Å—ë —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ media
   ======================= */
        @media (max-width: 980px) {

            html,
            body {
                height: auto;
            }

            body {
                overflow: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                -webkit-text-size-adjust: 100%;
            }

            /* –í–ê–ñ–ù–û: —É–±–∏—Ä–∞–µ–º 100vh-–ª–æ–≤—É—à–∫—É iOS */
            .appShell {
                height: auto !important;
                min-height: 100vh;
                display: block;
            }

            .main {
                display: block;
                min-height: 100vh;
            }

            .sidebar {
                display: none;
            }

            .burger {
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

            /* –•–µ–¥–µ—Ä + –∫–æ–Ω—Ç–µ–Ω—Ç –æ–¥–Ω–æ–π —à–∏—Ä–∏–Ω—ã */
            .topHeader,
            .content {
                width: 100%;
                max-width: 100%;
                padding-left: calc(12px + env(safe-area-inset-left));
                padding-right: calc(12px + env(safe-area-inset-right));
            }

            /* –•–µ–¥–µ—Ä: –∞–∫–∫—É—Ä–∞—Ç–Ω–æ, –±–µ–∑ –Ω–∞–ª–æ–∂–µ–Ω–∏–π */
            .topHeader {
                position: sticky;
                top: 0;
                z-index: 999;

                flex-direction: column;
                align-items: stretch;
                gap: 10px;

                backdrop-filter: none;
                -webkit-backdrop-filter: none;
                background: rgba(8, 16, 24, .94);

                padding-top: calc(12px + env(safe-area-inset-top));
                padding-bottom: 12px;
            }

            .hdrLeft {
                width: 100%;
            }

            .hdrRight {
                width: 100%;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                justify-content: stretch;
            }

            /* user –∏ status ‚Äî –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
            #userPill {
                grid-column: 1 / -1;
                justify-content: center;
            }

            #status {
                grid-column: 1 / -1;
                justify-content: center;
            }

            /* –∫–Ω–æ–ø–∫–∏ –≤ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ */
            #btnReload,
            #btnLogout {
                width: 100%;
            }

            /* –±—É—Ä–≥–µ—Ä —Å–ø—Ä–∞–≤–∞ */
            #burger {
                justify-self: end;
                width: 46px;
            }

            .content {
                padding-top: 12px;
                padding-bottom: calc(12px + env(safe-area-inset-bottom));
                overflow: visible;
                gap: 10px;
            }

            /* –í–µ—Ä—Ö–Ω—è—è –∑–æ–Ω–∞: —Å—Ç—Ä–æ–≥–æ –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ */
            .topArea {
                height: auto;
                min-height: 0;
                grid-template-columns: 1fr;
                gap: 10px;
                align-content: start;
            }

            .balancesCard,
            .filtersCard,
            .catCard {
                padding: 12px;
                min-height: auto;
            }

            /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ sticky –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü –Ω–∞ iOS –¥–∞—é—Ç "–ø—Ä–∏–∑—Ä–∞–∫–∏" -> –æ—Ç–∫–ª—é—á–∞–µ–º */
            .catTable thead th {
                position: static !important;
            }

            /* –§–∏–ª—å—Ç—Ä—ã: –≤ 1 –∫–æ–ª–æ–Ω–∫—É, –¥–∞—Ç–∞ ‚Äî –≤ 2 –∫–æ–ª–æ–Ω–∫–∏ */
            .filtersGrid {
                grid-template-columns: 1fr;
            }

            .filtersGrid .full {
                grid-column: 1 / -1;
            }

            /* –ø–æ–ª–µ "–î–∞—Ç–∞ –æ—Ç/–¥–æ" –¥–µ–ª–∞–µ–º —Å–µ—Ç–∫–æ–π, —É–±–∏—Ä–∞–µ–º "‚Äî" */
            .filtersCard .field.full {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                align-items: start;
            }

            .filtersCard .field.full>label {
                grid-column: 1 / -1;
                margin-bottom: 2px;
            }

            .filtersCard .field.full>.muted {
                display: none;
            }

            .filtersCard .field {
                display: flex;
                flex-direction: column;
                align-items: stretch;
                gap: 6px;
                padding: 12px;
                min-height: auto;
            }

            .filtersCard .field label {
                width: 100%;
                white-space: normal;
                line-height: 1.2;
            }

            /* iPhone zoom fix */
            .filtersCard .field input,
            .filtersCard .field select,
            .filtersCard .field .combo {
                font-size: 16px;
            }

            /* –ö–∞—Ç–µ–≥–æ—Ä–∏—è totals ‚Äî 2 –≤ —Ä—è–¥ */
            .catTotals {
                grid-template-columns: 1fr 1fr;
            }

            /* –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏, —Å–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É */
            .bottomArea {
                height: auto;
                min-height: 0;
                overflow: visible;
            }

            .tableScroll {
                display: none;
            }

            .opsCards {
                display: grid;
                padding: 0;
                gap: 10px;
            }

            /* === –û–ø–µ—Ä–∞—Ü–∏–∏ (–∫–∞—Ä—Ç–æ—á–∫–∏): —É–±–∏—Ä–∞–µ–º –Ω—É–ª–∏ –∏ "/" —Ç–æ–ª—å–∫–æ CSS === */
            .opAmts {
                grid-template-columns: 1fr;
                /* —á—Ç–æ–±—ã —á–∏—Ç–∞–±–µ–ª—å–Ω–æ */
            }

            /* —É–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ (&nbsp;/&nbsp;) —á–µ—Ä–µ–∑ font-size:0 */
            .opAmts .val {
                font-size: 0;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }

            .opAmts .val span {
                font-size: 12px;
                margin: 0;
            }

            /* —Å–∫—Ä—ã–≤–∞–µ–º –Ω—É–ª–∏ (—É –Ω—É–ª–µ–π —É —Ç–µ–±—è –Ω–µ—Ç class amtIn/amtOut) */
            .opAmts .val span:not(.amtIn):not(.amtOut) {
                display: none;
            }

            /* —á—Ç–æ–±—ã + –∏ - –Ω–µ —Å–ª–∏–ø–∞–ª–∏—Å—å */
            .opAmts .val span.amtIn,
            .opAmts .val span.amtOut {
                margin-right: 8px;
            }

            /* –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç :has ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –≤–∞–ª—é—Ç–Ω—ã–π –±–ª–æ–∫, –µ—Å–ª–∏ —Ç–∞–º –≤–æ–æ–±—â–µ –Ω–µ—Ç —Å—É–º–º */
            @supports(selector(:has(*))) {
                .opAmts .box:not(:has(.amtIn)):not(:has(.amtOut)) {
                    display: none;
                }
            }
        }

        @media (max-width: 420px) {
            .catTotals {
                grid-template-columns: 1fr;
            }
        }


        /* ===== Brand Date Picker ===== */
        .dateRangeBtn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(255, 255, 255, .04);
            color: rgba(255, 255, 255, .92);
            cursor: pointer;
            font-weight: 900;
        }

        .dateRangeBtn:hover {
            background: rgba(255, 255, 255, .06);
        }

        .dateRangeIco {
            opacity: .85;
        }

        .datePicker {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, .48);
            z-index: 2000;
            padding: 14px;
        }

        .datePicker.open {
            display: flex;
        }

        .dpCard {
            width: min(420px, 100%);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(8, 16, 24, .94);
            box-shadow: 0 18px 50px rgba(0, 0, 0, .45);
            padding: 12px;
        }

        .dpHead {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .dpTitle {
            flex: 1;
            text-align: center;
            font-weight: 1000;
            letter-spacing: .2px;
        }

        .dpNav,
        .dpClose {
            width: 38px;
            height: 36px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .06);
            color: rgba(255, 255, 255, .92);
            cursor: pointer;
        }

        .dpClose {
            margin-left: auto;
        }

        .dpWeek {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            padding: 6px 4px 8px;
            color: rgba(255, 255, 255, .65);
            font-size: 12px;
            font-weight: 900;
            text-transform: uppercase;
        }

        .dpGrid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            padding: 4px;
        }

        .dpDay {
            height: 40px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(255, 255, 255, .04);
            color: rgba(255, 255, 255, .90);
            cursor: pointer;
            font-weight: 900;
        }

        .dpDay.muted {
            opacity: .40;
            border-color: rgba(255, 255, 255, .06);
        }

        .dpDay:hover {
            background: rgba(255, 255, 255, .07);
        }

        .dpDay.start,
        .dpDay.end {
            background: rgba(16, 185, 129, .16);
            border-color: rgba(16, 185, 129, .35);
            color: rgba(255, 255, 255, .95);
        }

        .dpDay.inRange {
            background: rgba(16, 185, 129, .08);
            border-color: rgba(16, 185, 129, .18);
        }

        .dpActions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .dpBtn {
            flex: 1;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .06);
            color: rgba(255, 255, 255, .92);
            cursor: pointer;
            font-weight: 900;
        }

        .dpBtnOk {
            background: rgba(16, 185, 129, .85);
            color: #062a1b;
            border-color: rgba(16, 185, 129, .35);
        }

        /* Mobile: –¥–µ–ª–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∫–∞–∫ ‚Äúbottom sheet‚Äù */
        @media (max-width: 980px) {
            .datePicker {
                align-items: flex-end;
                padding: 10px;
            }

            .dpCard {
                width: 100%;
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
                padding-bottom: calc(12px + env(safe-area-inset-bottom));
            }

            .dpDay {
                height: 44px;
            }
        }
    </style>
</head>

<body>
    <!-- Mobile menu -->
    <div id="mOverlay" class="mobileMenuOverlay">
        <div class="mobileMenu" onclick="event.stopPropagation()">
            <div class="brand" style="margin-bottom:6px;">
                <div class="brandLogo">G</div>
                <div class="brandText" style="opacity:1;transform:none;">Gekto</div>
            </div>
            <div class="mNav" id="mNav"></div>
            <div class="muted" style="margin-top:auto;">Gekto</div>
        </div>
    </div>

    <div class="appShell">
        <aside class="sidebar">
            <div class="brand">
                <div class="brandLogo">G</div>
                <div class="brandText">Gekto</div>
            </div>
            <nav class="nav" id="nav"></nav>
        </aside>

        <main class="main">
            <header class="topHeader">
                <div class="hdrLeft">
                    <div class="hdrTitle">BPS <b>(Erkin)</b></div>
                    <div class="hdrSub">Kassa hisoboti</div>
                </div>

                <div class="hdrRight">
                    <span id="userPill" class="pill">üë§ -</span>
                    <button id="btnReload" class="btn">Yangilash</button>
                    <button id="btnLogout" class="btn danger">Chiqish</button>
                    <span id="status" class="pill"><span class="muted">Yuklanmoqda...</span></span>
                    <button id="burger" class="burger" title="Menu">‚ò∞</button>
                </div>
            </header>

            <section class="content">
                <!-- TOP -->
                <div class="topArea">
                    <!-- balances -->
                    <div class="card balancesCard">
                        <div class="cardTitleRow">
                            <div class="cardTitle">Qoldiq (hamma sana bo‚Äòyicha)</div>
                            <span id="updatedAt" class="muted"></span>
                        </div>
                        <div id="balances" class="balList"></div>
                    </div>

                    <!-- filters -->
                    <div class="card filtersCard">
                        <div class="cardTitleRow">
                            <div class="cardTitle">Filtrlar</div>
                            <button id="btnClear" class="btn" type="button">Reset</button>
                        </div>

                        <div class="filtersGrid">
                            <div class="field full">
                                <label>Sana (oraliq)</label>

                                <button type="button" id="dateRangeBtn" class="dateRangeBtn">
                                    <span id="dateRangeText">Bugun</span>
                                    <span class="dateRangeIco">üìÖ</span>
                                </button>

                                <!-- –æ—Å—Ç–∞–≤–ª—è–µ–º —ç—Ç–∏ id –¥–ª—è —Ç–≤–æ–µ–≥–æ —Ç–µ–∫—É—â–µ–≥–æ JS —Ñ–∏–ª—å—Ç—Ä–∞ -->
                                <input id="dateFrom" type="hidden" />
                                <input id="dateTo" type="hidden" />
                            </div>

                            <!-- Brand Date Picker -->
                            <div id="datePicker" class="datePicker" aria-hidden="true">
                                <div class="dpCard" role="dialog" aria-modal="true">
                                    <div class="dpHead">
                                        <button type="button" class="dpNav" id="dpPrev"
                                            aria-label="Prev month">‚Äπ</button>
                                        <div class="dpTitle" id="dpTitle">‚Äî</div>
                                        <button type="button" class="dpNav" id="dpNext"
                                            aria-label="Next month">‚Ä∫</button>
                                        <button type="button" class="dpClose" id="dpClose" aria-label="Close">‚úï</button>
                                    </div>

                                    <div class="dpWeek">
                                        <span>Du</span><span>Se</span><span>Ch</span><span>Pa</span><span>Ju</span><span>Sh</span><span>Ya</span>
                                    </div>

                                    <div class="dpGrid" id="dpGrid"></div>

                                    <div class="dpActions">
                                        <button type="button" class="dpBtn" id="dpClear">Tozalash</button>
                                        <button type="button" class="dpBtn dpBtnOk" id="dpToday">Bugun</button>
                                    </div>
                                </div>
                            </div>


                            <!-- –æ–±—â–∏–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ -->
                            <div class="field full">
                                <label>Qidiruv (matn)</label>
                                <input id="qText" placeholder="Koshelok / Kategoriya / Subkategoriya / Izoh..." />
                            </div>

                            <!-- Wallet typed -->
                            <div class="field">
                                <label>–ü–æ –∫–æ—à–µ–ª—å–∫–∞–º</label>
                                <input id="fWallet" class="combo" list="walletList" placeholder="–í—Å–µ" />
                                <datalist id="walletList"></datalist>
                            </div>

                            <!-- Category typed -->
                            <div class="field">
                                <label>–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</label>
                                <input id="fCat" class="combo" list="catList" placeholder="–í—Å–µ" />
                                <datalist id="catList"></datalist>
                            </div>

                            <!-- Sub typed -->
                            <div class="field">
                                <label>–ü–æ —Å—É–± –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</label>
                                <input id="fSub" class="combo" list="subList" placeholder="–í—Å–µ" />
                                <datalist id="subList"></datalist>
                            </div>

                            <div class="field">
                                <label>–¢–∏–ø—ã (–†–∞—Å—Ö–æ–¥/–ü—Ä–∏—Ö–æ–¥)</label>
                                <select id="fType">
                                    <option value="all">–í—Å–µ</option>
                                    <option value="in">–ü—Ä–∏—Ö–æ–¥</option>
                                    <option value="out">–†–∞—Å—Ö–æ–¥</option>
                                </select>
                            </div>

                            <div class="field">
                                <label>–í–∞–ª—é—Ç–∞</label>
                                <select id="fCur">
                                    <option value="all">–í—Å–µ</option>
                                    <option value="uzs">UZS</option>
                                    <option value="usd">USD</option>
                                    <option value="both">UZS+USD</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- category summary -->
                    <div class="card catCard">
                        <div class="cardTitleRow">
                            <div class="cardTitle">Kategoriya bo‚Äòyicha</div>
                            <span class="muted">filtr bo‚Äòyicha</span>
                        </div>

                        <div class="catTotals">
                            <div class="totBox">
                                <div class="totLbl">Kirim UZS</div>
                                <div id="tInU" class="totVal in">0</div>
                            </div>
                            <div class="totBox">
                                <div class="totLbl">Chiqim UZS</div>
                                <div id="tOutU" class="totVal out">0</div>
                            </div>
                            <div class="totBox">
                                <div class="totLbl">Kirim USD</div>
                                <div id="tInD" class="totVal in">0</div>
                            </div>
                            <div class="totBox">
                                <div class="totLbl">Chiqim USD</div>
                                <div id="tOutD" class="totVal out">0</div>
                            </div>
                        </div>

                        <div class="catListWrap">
                            <table class="catTable">
                                <thead>
                                    <tr>
                                        <th>Kategoriya</th>
                                        <th>Kirim UZS</th>
                                        <th>Chiqim UZS</th>
                                        <th>Kirim USD</th>
                                        <th>Chiqim USD</th>
                                    </tr>
                                </thead>
                                <tbody id="catBody">
                                    <tr>
                                        <td colspan="5" class="empty">Operatsiyalar yoq</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- BOTTOM -->
                <div class="card bottomArea">
                    <div class="tableScroll" id="tableScroll">
                        <table class="opsTable">
                            <thead>
                                <tr>
                                    <th>Sana</th>
                                    <th>Koshelok</th>
                                    <th>Kategoriya</th>
                                    <th>Subkategoriya</th>
                                    <th>Izoh</th>
                                    <th>Kirim Summa</th>
                                    <th>Chiqim summa</th>
                                    <th>Kirim $ Summa</th>
                                    <th>Chiqim $ summa</th>
                                    <th>Kurs</th>
                                </tr>
                            </thead>
                            <tbody id="tbody">
                                <tr>
                                    <td colspan="10" class="empty">Yuklanmoqda...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="opsCards" class="opsCards"></div>
                </div>
            </section>
        </main>
    </div>

    <script>
        /************ CONFIG ************/
        const ENDPOINT =
            "https://script.google.com/macros/s/AKfycbyZD2z3CcNpQhGFh-e_Qfmhu91B7imqNKQ0dr2Gm4_V2KzTlvNEJMpRYnjOAfu_CCwiQg/exec";
        const API_SECRET = "bpsSecret123"; // –µ—Å–ª–∏ –≤–∫–ª—é—á–∏–ª –≤ Apps Script ‚Äî –ø—Ä–æ–ø–∏—à–∏

        const LOGIN_URL = "/bpslogin"; // –∏–ª–∏ "/bpslogin.html"
        const KASSA_URL = "/bpskassa"; // —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞

        const IDLE_MS = 3 * 60 * 1000; // 3 –º–∏–Ω—É—Ç—ã
        const TOUCH_DEBOUNCE_MS = 25000; // touch –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ ~25 —Å–µ–∫

        /************ NAV ************/
        const NAV_ITEMS = [{
                key: "home",
                label: "–ì–ª–∞–≤–Ω–∞—è",
                href: "/bpsmain",
                icon: homeIcon()
            },
            {
                key: "kassa",
                label: "–ö–∞—Å—Å–∞",
                href: "/bpskassa",
                icon: cashIcon()
            },
            {
                key: "prod",
                label: "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ",
                href: "/bpsprod",
                icon: factoryIcon()
            },
            {
                key: "sale",
                label: "–ü—Ä–æ–¥–∞–∂–∞",
                href: "/bpssale",
                icon: saleIcon()
            },
            {
                key: "stock",
                label: "–°–∫–ª–∞–¥",
                href: "/bpsstock",
                icon: boxIcon()
            },
            {
                key: "users",
                label: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
                href: "/bpsusers",
                icon: usersIcon()
            },
        ];

        function currentKeyFromPath() {
            const p = (location.pathname || "").toLowerCase();
            if (p.includes("bpskassa")) return "kassa";
            if (p.includes("bpsmain")) return "home";
            if (p.includes("bpsprod")) return "prod";
            if (p.includes("bpssale")) return "sale";
            if (p.includes("bpsstock")) return "stock";
            if (p.includes("bpsusers")) return "users";
            return "kassa";
        }

        function renderNav() {
            const activeKey = currentKeyFromPath();
            const nav = document.getElementById("nav");
            const mNav = document.getElementById("mNav");

            nav.innerHTML = NAV_ITEMS.map(i => `
        <a class="navItem ${i.key===activeKey ? "active":""}" href="${i.href}">
          <span class="navIcon">${i.icon}</span>
          <span class="navText">${escapeHtml(i.label)}</span>
        </a>
      `).join("");

            mNav.innerHTML = NAV_ITEMS.map(i => `
        <a class="${i.key===activeKey ? "active":""}" href="${i.href}">${escapeHtml(i.label)}</a>
      `).join("");
        }

        /************ STATE ************/
        let TOKEN = localStorage.getItem("bps_token") || "";
        let USER = safeParse(localStorage.getItem("bps_user")) || null;

        let ALL_ROWS = [];
        let OPTIONS = {
            wallets: [],
            categories: [],
            subAll: [],
            subByCat: {}
        };
        let BALANCES = [];

        let lastTouchSentAt = 0;

        /************ DOM ************/
        const userPill = document.getElementById("userPill");
        const status = document.getElementById("status");
        const btnReload = document.getElementById("btnReload");
        const btnLogout = document.getElementById("btnLogout");
        const btnClear = document.getElementById("btnClear");
        const updatedAt = document.getElementById("updatedAt");

        const dateFrom = document.getElementById("dateFrom");
        const dateTo = document.getElementById("dateTo");
        const qText = document.getElementById("qText");

        const fWallet = document.getElementById("fWallet");
        const fCat = document.getElementById("fCat");
        const fSub = document.getElementById("fSub");
        const fType = document.getElementById("fType");
        const fCur = document.getElementById("fCur");

        const walletList = document.getElementById("walletList");
        const catList = document.getElementById("catList");
        const subList = document.getElementById("subList");

        const balancesBox = document.getElementById("balances");

        const tbody = document.getElementById("tbody");
        const tableScroll = document.getElementById("tableScroll");
        const opsCards = document.getElementById("opsCards");

        const catBody = document.getElementById("catBody");
        const tInU = document.getElementById("tInU");
        const tOutU = document.getElementById("tOutU");
        const tInD = document.getElementById("tInD");
        const tOutD = document.getElementById("tOutD");

        const burger = document.getElementById("burger");
        const mOverlay = document.getElementById("mOverlay");

        /************ helpers ************/
        function safeParse(s) {
            try {
                return JSON.parse(s);
            } catch (e) {
                return null;
            }
        }

        function setStatus(type, text, loading = false) {
            status.className = "pill";
            status.innerHTML = "";
            if (loading) status.innerHTML = '<span class="spinner"></span>';
            status.innerHTML += `<span>${escapeHtml(text)}</span>`;
            if (type === "ok") status.classList.add("ok");
            if (type === "err") status.classList.add("err");
        }

        function escapeHtml(s) {
            return String(s ?? "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function fmt(n) {
            const x = Number(n);
            if (!isFinite(x)) return "0";
            return x.toLocaleString("ru-RU", {
                maximumFractionDigits: 2
            });
        }

        function toNum(n) {
            const x = Number(n);
            return isFinite(x) ? x : 0;
        }

        function todayISO() {
            const d = new Date();
            const pad = x => String(x).padStart(2, "0");
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
        }

        function isMobile() {
            return window.matchMedia("(max-width: 980px)").matches;
        }

        function clearSession() {
            localStorage.removeItem("bps_token");
            localStorage.removeItem("bps_user");
            localStorage.removeItem("bps_lastActivity");
            TOKEN = "";
            USER = null;
        }

        function lockToLogin() {
            clearSession();
            location.replace(LOGIN_URL);
        }

        /************ AUTH GATE (no token => redirect) ************/
        if (!TOKEN) {
            location.replace(LOGIN_URL);
        }

        /************ JSONP ************/
        function loadJSONP(url) {
            return new Promise((resolve, reject) => {
                const cbName = "__bps_cb_" + Math.random().toString(36).slice(2);
                const script = document.createElement("script");
                window[cbName] = (data) => {
                    cleanup();
                    resolve(data);
                };

                function cleanup() {
                    try {
                        delete window[cbName];
                    } catch (e) {
                        window[cbName] = undefined;
                    }
                    script.remove();
                }
                script.onerror = () => {
                    cleanup();
                    reject(new Error("JSONP load error"));
                };
                const sep = url.includes("?") ? "&" : "?";
                script.src = url + sep + "callback=" + cbName + "&_=" + Date.now();
                document.body.appendChild(script);
            });
        }

        function apiUrl(params) {
            const u = new URL(ENDPOINT);
            Object.entries(params).forEach(([k, v]) => u.searchParams.set(k, v));
            if (API_SECRET) u.searchParams.set("api_secret", API_SECRET);
            return u.toString();
        }
        async function apiRefresh() {
            return await loadJSONP(apiUrl({
                action: "refresh",
                token: TOKEN
            }));
        }
        async function apiTouch() {
            return await loadJSONP(apiUrl({
                action: "touch",
                token: TOKEN
            }));
        }
        async function apiLogout() {
            return await loadJSONP(apiUrl({
                action: "logout",
                token: TOKEN
            }));
        }

        /************ idle control (3 min) ************/
        function markActivity() {
            localStorage.setItem("bps_lastActivity", String(Date.now()));
            maybeTouch();
        }

        function getLastActivity() {
            const x = Number(localStorage.getItem("bps_lastActivity") || "0");
            return isFinite(x) ? x : 0;
        }

        function startIdleWatch() {
            if (!getLastActivity()) localStorage.setItem("bps_lastActivity", String(Date.now()));
            setInterval(() => {
                const idle = Date.now() - getLastActivity();
                if (idle >= IDLE_MS) {
                    lockToLogin();
                }
            }, 2000);
        }

        async function maybeTouch() {
            const now = Date.now();
            if (now - lastTouchSentAt < TOUCH_DEBOUNCE_MS) return;
            lastTouchSentAt = now;

            try {
                const res = await apiTouch();
                if (!res || !res.ok) {
                    lockToLogin();
                }
            } catch (e) {}
        }

        function bindActivityEvents() {
            const events = ["mousemove", "keydown", "wheel", "touchstart", "scroll", "click"];
            events.forEach(ev => window.addEventListener(ev, markActivity, {
                passive: true
            }));
            document.addEventListener("visibilitychange", () => {
                if (!document.hidden) markActivity();
            });
        }

        /************ data render ************/
        function setDataFromApi(res) {
            ALL_ROWS = res.rows || [];
            OPTIONS = res.options || OPTIONS;
            BALANCES = res.balances || BALANCES;

            updatedAt.textContent = res.updatedAt ? ("update: " + res.updatedAt) : "";

            if (res.user) {
                USER = res.user;
                localStorage.setItem("bps_user", JSON.stringify(USER));
            }
            userPill.textContent = `üë§ ${USER?.ism || USER?.login || "-"}`;

            renderOptions();
            renderBalances();

            const t = todayISO();
            if (!dateFrom.value) dateFrom.value = t;
            if (!dateTo.value) dateTo.value = t;

            applyFilters();
        }

        function renderOptions() {
            walletList.innerHTML = (OPTIONS.wallets || []).map(w => `<option value="${escapeHtml(w)}"></option>`).join(
                "");
            catList.innerHTML = (OPTIONS.categories || []).map(c => `<option value="${escapeHtml(c)}"></option>`).join(
                "");
            renderSubOptions(fCat.value);
        }

        function renderSubOptions(catVal) {
            let list = [];
            const c = (catVal || "").trim();
            if (c && OPTIONS.subByCat && OPTIONS.subByCat[c]) list = OPTIONS.subByCat[c];
            else list = OPTIONS.subAll || [];
            subList.innerHTML = list.map(s => `<option value="${escapeHtml(s)}"></option>`).join("");
        }

        function renderBalances() {
            if (!BALANCES || BALANCES.length === 0) {
                balancesBox.innerHTML = `<div class="muted">Qoldiq yo‚Äòq</div>`;
                return;
            }
            balancesBox.innerHTML = BALANCES.map(b => `
        <div class="balItem">
          <div>
            <div class="w">${escapeHtml(b.wallet)}</div>
            <div class="muted">UZS / USD</div>
          </div>
          <div class="nums">
            <div>${fmt(b.uzs)} <span class="muted">UZS</span></div>
            <div>${fmt(b.usd)} <span class="muted">USD</span></div>
          </div>
        </div>
      `).join("");
        }

        function rowHasUZS(r) {
            return (toNum(r.kirimUzs) !== 0) || (toNum(r.chiqimUzs) !== 0);
        }

        function rowHasUSD(r) {
            return (toNum(r.kirimUsd) !== 0) || (toNum(r.chiqimUsd) !== 0);
        }

        function rowHasIN(r) {
            return (toNum(r.kirimUzs) > 0) || (toNum(r.kirimUsd) > 0);
        }

        function rowHasOUT(r) {
            return (toNum(r.chiqimUzs) > 0) || (toNum(r.chiqimUsd) > 0);
        }

        function normFilterVal(v) {
            v = String(v || "").trim();
            if (!v || v.toLowerCase() === "–≤—Å–µ" || v.toLowerCase() === "all") return "all";
            return v;
        }

        function applyFilters() {
            const df = dateFrom.value || "";
            const dt = dateTo.value || "";
            const w = normFilterVal(fWallet.value);
            const c = normFilterVal(fCat.value);
            const s = normFilterVal(fSub.value);
            const t = fType.value;
            const cur = fCur.value;
            const q = (qText.value || "").trim().toLowerCase();

            const filtered = ALL_ROWS.filter(r => {
                if (df && r.sana < df) return false;
                if (dt && r.sana > dt) return false;

                if (w !== "all" && String(r.koshelok || "") !== w) return false;
                if (c !== "all" && String(r.kategoriya || "") !== c) return false;
                if (s !== "all" && String(r.subkategoriya || "") !== s) return false;

                if (t === "in" && !rowHasIN(r)) return false;
                if (t === "out" && !rowHasOUT(r)) return false;

                if (cur === "uzs" && !rowHasUZS(r)) return false;
                if (cur === "usd" && !rowHasUSD(r)) return false;
                if (cur === "both" && !(rowHasUZS(r) && rowHasUSD(r))) return false;

                if (q) {
                    const hay = `${r.koshelok||""} ${r.kategoriya||""} ${r.subkategoriya||""} ${r.izoh||""}`
                        .toLowerCase();
                    if (!hay.includes(q)) return false;
                }

                return true;
            });

            renderTotals(filtered);
            renderCategorySummary(filtered);
            renderOps(filtered);
        }

        function renderTotals(list) {
            let inU = 0,
                outU = 0,
                inD = 0,
                outD = 0;
            for (const r of list) {
                inU += toNum(r.kirimUzs);
                outU += toNum(r.chiqimUzs);
                inD += toNum(r.kirimUsd);
                outD += toNum(r.chiqimUsd);
            }
            tInU.textContent = fmt(inU);
            tOutU.textContent = fmt(outU);
            tInD.textContent = fmt(inD);
            tOutD.textContent = fmt(outD);
        }

        function renderCategorySummary(list) {
            if (!list || list.length === 0) {
                catBody.innerHTML = `<tr><td colspan="5" class="empty">Operatsiyalar yoq</td></tr>`;
                return;
            }

            const map = new Map();
            for (const r of list) {
                const k = (r.kategoriya || "-").trim() || "-";
                if (!map.has(k)) map.set(k, {
                    cat: k,
                    inU: 0,
                    outU: 0,
                    inD: 0,
                    outD: 0
                });
                const o = map.get(k);
                o.inU += toNum(r.kirimUzs);
                o.outU += toNum(r.chiqimUzs);
                o.inD += toNum(r.kirimUsd);
                o.outD += toNum(r.chiqimUsd);
            }

            const arr = Array.from(map.values()).sort((a, b) => ((b.outU + b.outD) - (a.outU + a.outD)));

            catBody.innerHTML = arr.map(x => `
        <tr>
          <td class="catName" title="${escapeHtml(x.cat)}">${escapeHtml(x.cat)}</td>
          <td class="mono"><span class="in">${fmt(x.inU)}</span></td>
          <td class="mono"><span class="out">${fmt(x.outU)}</span></td>
          <td class="mono"><span class="in">${fmt(x.inD)}</span></td>
          <td class="mono"><span class="out">${fmt(x.outD)}</span></td>
        </tr>
      `).join("");
        }

        function renderOps(list) {
            if (!list || list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="empty">Operatsiyalar yoq</td></tr>`;
                opsCards.innerHTML = `<div class="empty">Operatsiyalar yoq</div>`;
                return;
            }

            const sorted = [...list].sort((a, b) => (a.sana < b.sana ? 1 : a.sana > b.sana ? -1 : 0));

            tbody.innerHTML = sorted.map(r => {
                const inU = toNum(r.kirimUzs);
                const outU = toNum(r.chiqimUzs);
                const inD = toNum(r.kirimUsd);
                const outD = toNum(r.chiqimUsd);

                return `
          <tr>
            <td class="mono">${escapeHtml(r.sana || "-")}</td>
            <td>${escapeHtml(r.koshelok || "-")}</td>
            <td>${escapeHtml(r.kategoriya || "-")}</td>
            <td>${escapeHtml(r.subkategoriya || "-")}</td>
            <td title="${escapeHtml(r.izoh || "")}">${escapeHtml(r.izoh || "-")}</td>
            <td class="mono ${inU ? "amtIn":""}">${fmt(inU)}</td>
            <td class="mono ${outU ? "amtOut":""}">${fmt(outU)}</td>
            <td class="mono ${inD ? "amtIn":""}">${fmt(inD)}</td>
            <td class="mono ${outD ? "amtOut":""}">${fmt(outD)}</td>
            <td class="mono">${fmt(r.kurs)}</td>
          </tr>
        `;
            }).join("");

            opsCards.innerHTML = sorted.map(r => {
                const inU = toNum(r.kirimUzs);
                const outU = toNum(r.chiqimUzs);
                const inD = toNum(r.kirimUsd);
                const outD = toNum(r.chiqimUsd);

                return `
          <div class="opCard">
            <div class="opTop">
              <div>${escapeHtml(r.sana || "-")}</div>
              <div>${escapeHtml(r.koshelok || "-")}</div>
            </div>
            <div class="opMid">
              <div>${escapeHtml(r.kategoriya || "-")} ‚Ä¢ ${escapeHtml(r.subkategoriya || "-")}</div>
              <div class="mono">${fmt(r.kurs)}</div>
            </div>
            <div class="opNote" title="${escapeHtml(r.izoh || "")}">${escapeHtml(r.izoh || "-")}</div>

            <div class="opAmts">
              <div class="box">
                <div class="lbl">UZS</div>
                <div class="val">
                  <span class="${inU ? "amtIn":""}">+${fmt(inU)}</span>
                  &nbsp; / &nbsp;
                  <span class="${outU ? "amtOut":""}">-${fmt(outU)}</span>
                </div>
              </div>
              <div class="box">
                <div class="lbl">USD</div>
                <div class="val">
                  <span class="${inD ? "amtIn":""}">+${fmt(inD)}</span>
                  &nbsp; / &nbsp;
                  <span class="${outD ? "amtOut":""}">-${fmt(outD)}</span>
                </div>
              </div>
            </div>
          </div>
        `;
            }).join("");

            if (!isMobile()) tableScroll.scrollTop = 0;
        }

        function enableRightDragScroll(el) {
            let dragging = false;
            let startX = 0,
                startY = 0,
                startLeft = 0,
                startTop = 0;

            el.addEventListener("contextmenu", (e) => e.preventDefault());

            el.addEventListener("mousedown", (e) => {
                if (e.button !== 2) return;
                dragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startLeft = el.scrollLeft;
                startTop = el.scrollTop;
                el.style.cursor = "grabbing";
                e.preventDefault();
            });

            window.addEventListener("mousemove", (e) => {
                if (!dragging) return;
                el.scrollLeft = startLeft - (e.clientX - startX);
                el.scrollTop = startTop - (e.clientY - startY);
            });

            window.addEventListener("mouseup", (e) => {
                if (e.button !== 2) return;
                dragging = false;
                el.style.cursor = "";
            });
        }

        function svgIcon(pathD) {
            return `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
             xmlns="http://www.w3.org/2000/svg">
          <path d="${pathD}" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `;
        }

        function homeIcon() {
            return svgIcon("M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1v-10.5z");
        }

        function cashIcon() {
            return svgIcon("M4 7h16v10H4V7zm3 3h4m6 0h2m-2 4h2M8 14h2");
        }

        function factoryIcon() {
            return svgIcon("M3 21V10l6 3V9l6 4V9l6 4v8H3zm4 0v-5h3v5m4 0v-5h3v5");
        }

        function saleIcon() {
            return svgIcon("M7 7h10l-1 12H8L7 7zm2-3h6v3H9V4z");
        }

        function boxIcon() {
            return svgIcon("M21 8l-9-5-9 5 9 5 9-5zM3 8v8l9 5 9-5V8");
        }

        function usersIcon() {
            return svgIcon(
                "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8m10 10v-2a4 4 0 0 0-3-3.87"
            );
        }

        function resetFilters() {
            // –î–ê–¢–ê: –≤—Å–µ–≥–¥–∞ —Å–µ–≥–æ–¥–Ω—è + –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å/–ª–µ–π–±–ª
            if (window.__dpSetToday) {
                window.__dpSetToday();
            } else {
                // fallback (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –±–ª–æ–∫ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è)
                const t = todayISO();
                dateFrom.value = t;
                dateTo.value = t;
                dateFrom.dispatchEvent(new Event("change", {
                    bubbles: true
                }));
                dateTo.dispatchEvent(new Event("change", {
                    bubbles: true
                }));
            }

            // –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            qText.value = "";
            fWallet.value = "";
            fCat.value = "";
            fSub.value = "";
            fType.value = "all";
            fCur.value = "all";

            renderSubOptions("");

            // –ø—Ä–∏–º–µ–Ω—è–µ–º
            applyFilters();
        }

        btnClear.addEventListener("click", resetFilters);

        dateFrom.addEventListener("change", () => {
            markActivity();
            applyFilters();
        });
        dateTo.addEventListener("change", () => {
            markActivity();
            applyFilters();
        });

        qText.addEventListener("input", () => {
            markActivity();
            applyFilters();
        });

        fWallet.addEventListener("input", () => {
            markActivity();
            applyFilters();
        });
        fCat.addEventListener("input", () => {
            markActivity();
            renderSubOptions(fCat.value);
            applyFilters();
        });
        fSub.addEventListener("input", () => {
            markActivity();
            applyFilters();
        });

        fType.addEventListener("change", () => {
            markActivity();
            applyFilters();
        });
        fCur.addEventListener("change", () => {
            markActivity();
            applyFilters();
        });

        btnReload.addEventListener("click", async () => {
            markActivity();
            setStatus("", "Yangilanmoqda...", true);
            btnReload.disabled = true;
            try {
                const res = await apiRefresh();
                if (!res || !res.ok) return lockToLogin();
                setDataFromApi(res);
                setStatus("ok", "Yangilandi");
            } catch (e) {
                setStatus("err", "Xatolik");
            } finally {
                btnReload.disabled = false;
            }
        });

        btnLogout.addEventListener("click", async () => {
            try {
                await apiLogout();
            } catch (e) {}
            lockToLogin();
        });

        burger.addEventListener("click", () => {
            mOverlay.style.display = "block";
        });
        mOverlay.addEventListener("click", () => {
            mOverlay.style.display = "none";
        });

        window.addEventListener("resize", () => applyFilters());

        /* ===== Brand Date Range Picker (2-click) ===== */
        (function () {
            const btn = document.getElementById("dateRangeBtn");
            const textEl = document.getElementById("dateRangeText");
            const dp = document.getElementById("datePicker");
            const grid = document.getElementById("dpGrid");
            const title = document.getElementById("dpTitle");
            const prev = document.getElementById("dpPrev");
            const next = document.getElementById("dpNext");
            const close = document.getElementById("dpClose");
            const clear = document.getElementById("dpClear");
            const todayBtn = document.getElementById("dpToday");

            const fromEl = document.getElementById("dateFrom");
            const toEl = document.getElementById("dateTo");

            const monthNames = ["Yanvar", "Fevral", "Mart", "Aprel", "May", "Iyun", "Iyul", "Avgust", "Sentabr",
                "Oktabr", "Noyabr", "Dekabr"
            ];

            let view = new Date(); // —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
            view.setDate(1);

            let start = ""; // YYYY-MM-DD
            let end = ""; // YYYY-MM-DD

            function pad(n) {
                return String(n).padStart(2, "0");
            }

            function iso(d) {
                return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
            }

            function parseISO(s) {
                const [y, m, dd] = s.split("-").map(Number);
                return new Date(y, m - 1, dd);
            }

            function fmtUZ(s) { // dd.mm.yyyy
                if (!s) return "";
                const d = parseISO(s);
                return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
            }

            function openDP() {
                // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∏–∑ –∏–Ω–ø—É—Ç–æ–≤
                start = fromEl.value || "";
                end = toEl.value || "";

                // –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ø–æ–∫–∞–∂–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
                if (start) {
                    const d = parseISO(start);
                    view = new Date(d.getFullYear(), d.getMonth(), 1);
                } else {
                    const now = new Date();
                    view = new Date(now.getFullYear(), now.getMonth(), 1);
                }

                render();
                dp.classList.add("open");
                dp.setAttribute("aria-hidden", "false");
            }

            function closeDP() {
                dp.classList.remove("open");
                dp.setAttribute("aria-hidden", "true");
            }

            function commitRange() {
                fromEl.value = start || "";
                toEl.value = end || start || "";

                // –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å
                syncLabel();

                // —Ç—Ä–∏–≥–≥–µ—Ä–∏–º —Ç–≤–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                fromEl.dispatchEvent(new Event("change", {
                    bubbles: true
                }));
                toEl.dispatchEvent(new Event("change", {
                    bubbles: true
                }));
            }

            function syncLabel() {
                const a = fromEl.value || "";
                const b = toEl.value || "";
                if (!a && !b) {
                    textEl.textContent = "Barcha sana";
                    return;
                }
                if (a && (!b || a === b)) {
                    textEl.textContent = fmtUZ(a);
                    return;
                }
                textEl.textContent = `${fmtUZ(a)} ‚Äî ${fmtUZ(b)}`;
            }

            function daysInMonth(y, m) {
                return new Date(y, m + 1, 0).getDate();
            } // m=0..11
            function weekdayMon0(d) { // Monday=0..Sunday=6
                const w = d.getDay(); // Sun=0
                return (w + 6) % 7;
            }

            function inRange(dayISO) {
                if (!start) return false;
                if (!end) return dayISO === start;
                return (dayISO >= start && dayISO <= end);
            }

            function render() {
                const y = view.getFullYear();
                const m = view.getMonth();
                title.textContent = `${monthNames[m]} ${y}`;

                const first = new Date(y, m, 1);
                const lead = weekdayMon0(first);
                const dim = daysInMonth(y, m);

                // –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü –¥–ª—è "–ø—É—Å—Ç—ã—Ö" —è—á–µ–µ–∫
                const prevDim = daysInMonth(y, m - 1);

                const cells = [];
                for (let i = 0; i < lead; i++) {
                    const d = prevDim - lead + 1 + i;
                    const dd = new Date(y, m - 1, d);
                    cells.push({
                        iso: iso(dd),
                        day: d,
                        muted: true
                    });
                }
                for (let d = 1; d <= dim; d++) {
                    const dd = new Date(y, m, d);
                    cells.push({
                        iso: iso(dd),
                        day: d,
                        muted: false
                    });
                }
                while (cells.length % 7 !== 0) {
                    const d = cells.length - (lead + dim) + 1;
                    const dd = new Date(y, m + 1, d);
                    cells.push({
                        iso: iso(dd),
                        day: dd.getDate(),
                        muted: true
                    });
                }

                grid.innerHTML = cells.map(c => {
                    const cls = ["dpDay"];
                    if (c.muted) cls.push("muted");
                    if (start && c.iso === start) cls.push("start");
                    if (end && c.iso === end) cls.push("end");
                    if (inRange(c.iso) && c.iso !== start && c.iso !== end) cls.push("inRange");

                    return `<button type="button" class="${cls.join(" ")}" data-iso="${c.iso}">${c.day}</button>`;
                }).join("");
            }

            function handlePick(dayISO) {
                // 1-–π –∫–ª–∏–∫ -> start
                if (!start || (start && end)) {
                    start = dayISO;
                    end = "";
                    render();
                    return;
                }

                // 2-–π –∫–ª–∏–∫ -> end
                end = dayISO;
                if (end < start) {
                    const t = start;
                    start = end;
                    end = t;
                }
                render();
                commitRange();
                closeDP();
            }

            // Events
            btn.addEventListener("click", openDP);

            dp.addEventListener("click", (e) => {
                // –∫–ª–∏–∫ –ø–æ —Ñ–æ–Ω—É ‚Äî –∑–∞–∫—Ä—ã—Ç—å
                if (e.target === dp) closeDP();
            });

            grid.addEventListener("click", (e) => {
                const b = e.target.closest(".dpDay");
                if (!b) return;
                handlePick(b.dataset.iso);
            });

            prev.addEventListener("click", () => {
                view = new Date(view.getFullYear(), view.getMonth() - 1, 1);
                render();
            });
            next.addEventListener("click", () => {
                view = new Date(view.getFullYear(), view.getMonth() + 1, 1);
                render();
            });
            close.addEventListener("click", closeDP);

            clear.addEventListener("click", () => {
                start = "";
                end = "";
                fromEl.value = "";
                toEl.value = "";
                syncLabel();
                fromEl.dispatchEvent(new Event("change", {
                    bubbles: true
                }));
                toEl.dispatchEvent(new Event("change", {
                    bubbles: true
                }));
                closeDP();
            });

            todayBtn.addEventListener("click", () => {
                const t = iso(new Date());
                start = t;
                end = t;
                commitRange();
                closeDP();
            });

            // –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ ‚Äî –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç—ã —Å—Ç–∞–≤–∏—à—å today –≤ boot)
            // –æ–±–Ω–æ–≤–∏–º —Ç–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ
            setTimeout(syncLabel, 0);

            // —á—Ç–æ–±—ã –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ hidden inputs (–µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –º–µ–Ω—è–µ—à—å) —Ç–µ–∫—Å—Ç —Ç–æ–∂–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è
            fromEl.addEventListener("change", syncLabel);
            toEl.addEventListener("change", syncLabel);

            // ===== API –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ reset + –¥–µ—Ñ–æ–ª—Ç —Å–µ–≥–æ–¥–Ω—è =====
            function setRange_(a, b) {
                start = a || "";
                end = b || a || "";

                fromEl.value = start;
                toEl.value = end;

                syncLabel();

                // —á—Ç–æ–±—ã —Ç–≤–æ–∏ —Ñ–∏–ª—å—Ç—Ä—ã/—Ä–µ–Ω–¥–µ—Ä —Å—Ä–∞–∑—É –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–∏
                fromEl.dispatchEvent(new Event("change", {
                    bubbles: true
                }));
                toEl.dispatchEvent(new Event("change", {
                    bubbles: true
                }));

                // –µ—Å–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç–∫—Ä—ã—Ç ‚Äî –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏—è
                render();
            }

            // –æ—Ç–¥–∞—ë–º –Ω–∞—Ä—É–∂—É, —á—Ç–æ–±—ã resetFilters –º–æ–≥ –≤—ã–∑–≤–∞—Ç—å
            window.__dpSetToday = function () {
                const t = iso(new Date());
                // —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã–≤–∞–ª–æ—Å—å –Ω–∞ —Ç–µ–∫—É—â–µ–º –º–µ—Å—è—Ü–µ
                const d = parseISO(t);
                view = new Date(d.getFullYear(), d.getMonth(), 1);

                setRange_(t, t);
            };

            // –¥–µ—Ñ–æ–ª—Ç –ø—Ä–∏ –≤—Ö–æ–¥–µ: –≤—Å–µ–≥–¥–∞ —Å–µ–≥–æ–¥–Ω—è, –µ—Å–ª–∏ –¥–∞—Ç—ã –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
            if (!fromEl.value && !toEl.value) {
                window.__dpSetToday();
            } else {
                // –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ refresh) ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏–º —Ç–µ–∫—Å—Ç
                syncLabel();
            }

        })();


        (async function boot() {
            renderNav();
            enableRightDragScroll(tableScroll);
            bindActivityEvents();
            startIdleWatch();

            setStatus("", "Yuklanmoqda...", true);
            try {
                const res = await apiRefresh();
                if (!res || !res.ok) return lockToLogin();
                setDataFromApi(res);
                setStatus("ok", "Tayyor");
                if (!localStorage.getItem("bps_lastActivity")) localStorage.setItem("bps_lastActivity", String(
                    Date.now()));
            } catch (e) {
                lockToLogin();
            }
        })();
    </script>
</body>

</html>
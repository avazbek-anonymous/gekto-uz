<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>G-SOFT | Managment</title>

  <style>
    :root{
      --r:18px; --gap:12px; --shadow:0 18px 55px rgba(0,0,0,.35);
      --bg:#061a14; --bg2:#0b2b23;
      --card:rgba(255,255,255,.07); --line:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.65);
      --brand:#ffd15c; --ok:#10b981; --bad:#f16262;
      --chip:rgba(0,0,0,.18); --input:rgba(0,0,0,.18);
      --colw: 320px;
    }
    [data-theme="light"]{
      --bg:#f6f8fb; --bg2:#eef2f7;
      --card:rgba(255,255,255,.88); --line:rgba(9,20,30,.10);
      --text:rgba(9,20,30,.92); --muted:rgba(9,20,30,.60);
      --brand:#0ea5e9; --chip:rgba(14,165,233,.08); --input:rgba(9,20,30,.05);
      --shadow:0 18px 55px rgba(9,20,30,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1000px 520px at 20% 20%, rgba(255,209,92,.14), transparent 60%),
        radial-gradient(1000px 520px at 85% 35%, rgba(16,185,129,.14), transparent 55%),
        linear-gradient(180deg,var(--bg),var(--bg2));
      overflow:hidden;
    }

    /* ===== Global Loading Block ===== */
    body.isLoading .shell{filter: blur(1px) saturate(.95); opacity:.92}
    body.isLoading{pointer-events:none}
    .loadingOverlay{
      position:fixed; inset:0; z-index:2000;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.38);
      backdrop-filter: blur(10px);
      opacity:0; visibility:hidden;
      transition: opacity .18s ease, visibility .18s ease;
      pointer-events:auto; /* must be clickable even when body pointer-events none */
    }
    body.isLoading .loadingOverlay{opacity:1; visibility:visible}
    .loadingCard{
      width:min(520px, calc(100% - 28px));
      background:var(--card);
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:16px;
    }
    .loadingRow{display:flex;align-items:center;gap:12px}
    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:2px solid rgba(255,255,255,.18);
      border-top-color: rgba(0,0,0,.55);
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .loadingTitle{font-weight:1000}
    .loadingSub{color:var(--muted);font-size:13px;margin-top:2px}

    /* ===== Layout ===== */
    .shell{height:100vh;display:flex;min-height:0}
    .sidebar{
      width:74px; transition:width .22s ease;
      border-right:1px solid var(--line);
      background:rgba(255,255,255,.05);
      backdrop-filter: blur(12px);
      padding:12px 10px;
      display:flex;flex-direction:column;gap:10px;
      min-height:0;
    }
    .sidebar:hover{width:260px}

    .brand{
      display:flex;align-items:center;gap:10px;
      padding:10px;border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
    }
    .logo{
      width:38px;height:38px;border-radius:14px;
      display:grid;place-items:center;
      font-weight:1000;color:var(--brand);
      background:rgba(255,209,92,.16);
      border:1px solid rgba(255,209,92,.25);
      flex:0 0 38px;
    }
    [data-theme="light"] .logo{
      background:rgba(14,165,233,.14);
      border-color:rgba(14,165,233,.22);
    }
    .brandText{
      font-weight:1000; letter-spacing:.2px;
      white-space:nowrap; overflow:hidden;
      opacity:0; transform:translateX(-4px);
      transition:opacity .16s ease, transform .16s ease;
    }
    .sidebar:hover .brandText{opacity:1; transform:translateX(0)}

    .nav{display:flex;flex-direction:column;gap:6px;padding-top:6px}
    .nav a{
      display:flex;align-items:center;gap:10px;
      padding:10px;border-radius:16px;
      text-decoration:none;color:var(--text);
      border:1px solid transparent;
    }
    .nav a:hover{background:rgba(255,255,255,.06);border-color:var(--line)}
    .nav a.active{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.28)}
    [data-theme="light"] .nav a.active{background:rgba(14,165,233,.12);border-color:rgba(14,165,233,.24)}
    .ico{width:22px;height:22px;display:grid;place-items:center;flex:0 0 22px}
    .txt{
      white-space:nowrap; overflow:hidden;
      opacity:0; transform:translateX(-4px);
      transition:opacity .16s ease, transform .16s ease;
    }
    .sidebar:hover .txt{opacity:1; transform:translateX(0)}

    .main{flex:1;min-width:0;display:flex;flex-direction:column;min-height:0}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.04);
      backdrop-filter: blur(12px);
    }
    .hdrLeft{min-width:0}
    .hdrTitle{font-weight:1000;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hdrSub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .hdrRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:9px 12px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--muted);font-size:13px;white-space:nowrap;
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 12px;border-radius:14px;
      font-weight:900;cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn.danger{background:rgba(241,98,98,.14);border-color:rgba(241,98,98,.24)}
    .btn.primary{background:rgba(255,209,92,.90);border-color:rgba(255,209,92,.28);color:#062018}
    [data-theme="light"] .btn.primary{background:rgba(14,165,233,.92);border-color:rgba(14,165,233,.25);color:#061a14}

    .content{flex:1;min-height:0;padding:var(--gap);overflow:auto}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
      padding:14px;
    }
    .cardTitleRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:10px;
    }
    .cardTitle{font-weight:1000}
    .muted{color:var(--muted);font-size:12px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:var(--chip);
      font-weight:900;
      font-size:12px;
      color:var(--text);
    }

    /* ===== Theme toggle ===== */
    .themeBtn{
      width:44px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      position:relative;overflow:hidden;
    }
    .themeIcon{width:22px;height:22px;transition: transform .45s cubic-bezier(.2,.8,.2,1), opacity .25s ease;}
    .themeBtn .sun{opacity:0;transform:translateY(10px) rotate(25deg) scale(.8)}
    .themeBtn .moon{opacity:1;transform:translateY(0) rotate(0) scale(1)}
    [data-theme="light"] .themeBtn .sun{opacity:1;transform:translateY(0) rotate(0) scale(1)}
    [data-theme="light"] .themeBtn .moon{opacity:0;transform:translateY(-10px) rotate(-25deg) scale(.8)}
    .themeBtn::after{
      content:"";
      position:absolute;inset:-40px;
      background: radial-gradient(220px 140px at 20% 20%, rgba(255,255,255,.18), transparent 60%);
      opacity:.35;
      transform: rotate(0deg);
      transition: transform .6s ease;
      pointer-events:none;
    }
    [data-theme="light"] .themeBtn::after{transform: rotate(180deg); opacity:.25;}

    /* ===== Filters ===== */
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .select{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      padding:8px 10px;border-radius:14px;
    }
    .select label{color:var(--muted);font-size:12px}
    .select select{
      border:0;outline:none;background:transparent;color:var(--text);
      font-weight:900;
    }

    /* ===== Boards ===== */
    .board{
      display:flex; gap:12px;
      overflow:auto;
      padding-bottom:10px;
      scroll-snap-type:x mandatory;
    }
    .col{
      width:var(--colw);
      flex:0 0 var(--colw);
      scroll-snap-align:start;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:18px;
      min-height:420px;
      display:flex;flex-direction:column;
    }
    .colHead{
      padding:10px 10px;
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      font-weight:1000;
    }
    .colHead small{color:var(--muted);font-weight:800}
    .colBody{
      padding:10px;
      display:flex;flex-direction:column;gap:10px;
      min-height:240px;
      flex:1;
    }

    .dropHint{
      outline:2px dashed rgba(255,209,92,.55);
      outline-offset:-6px;
      background:rgba(255,209,92,.06);
    }
    [data-theme="light"] .dropHint{
      outline:2px dashed rgba(14,165,233,.55);
      background:rgba(14,165,233,.06);
    }

    /* ===== Task card ===== */
    .tCard{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px;
      cursor:pointer;
      user-select:none;
      transform: translateY(0);
      transition: transform .18s ease, box-shadow .18s ease, opacity .18s ease;
    }
    [data-theme="light"] .tCard{background:rgba(9,20,30,.04)}
    .tCard:hover{transform: translateY(-2px); box-shadow:0 14px 40px rgba(0,0,0,.25)}
    .tCard.dragging{opacity:.55; transform: rotate(1deg) scale(.99)}
    .tTitle{font-weight:1000; line-height:1.2}
    .tTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .tBadges{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .tMeta{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tLine{margin-top:8px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:10px}
    .timer{font-weight:1000;color:rgba(255,209,92,.95)}
    [data-theme="light"] .timer{color:rgba(14,165,233,.95)}
    .reason{
      margin-top:8px;
      padding:8px;
      border-radius:12px;
      border:1px dashed rgba(241,98,98,.35);
      background:rgba(241,98,98,.08);
      color:rgba(241,98,98,.95);
      font-size:12px;
    }

    /* ===== Project card ===== */
    .pCard{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px;
      user-select:none;
      transition: transform .18s ease, box-shadow .18s ease, opacity .18s ease;
    }
    [data-theme="light"] .pCard{background:rgba(9,20,30,.04)}
    .pCard:hover{transform: translateY(-2px); box-shadow:0 14px 40px rgba(0,0,0,.20)}
    .pTitle{font-weight:1000}
    .pMeta{margin-top:6px;color:var(--muted);font-size:12px}
    .pBtns{margin-top:10px;display:flex;gap:8px}
    .miniBtn{
      flex:1;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;border-radius:12px;
      font-weight:1000; cursor:pointer;
    }
    .miniBtn.primary{background:rgba(16,185,129,.14);border-color:rgba(16,185,129,.22)}
    [data-theme="light"] .miniBtn.primary{background:rgba(14,165,233,.14);border-color:rgba(14,165,233,.22)}

    /* ===== Table for Users (kept) ===== */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;vertical-align:middle}
    [data-theme="light"] th,[data-theme="light"] td{border-bottom:1px solid rgba(9,20,30,.08)}
    th{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.3px}

    .iconBtn{
      width:38px;height:34px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      cursor:pointer;
    }

    /* ===== Modal ===== */
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;justify-content:center;
      padding:14px;
      z-index:1500;
      backdrop-filter: blur(10px);
    }
    .overlay.open{display:flex}
    .modal{
      width:min(720px,100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px;
    }
    .modalHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .modalTitle{font-weight:1000}
    .xBtn{
      width:38px;height:34px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      color:var(--text);
    }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid1{display:grid;grid-template-columns:1fr;gap:10px}
    .f label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    .f input,.f select,.f textarea{
      width:100%;
      padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:var(--input);
      color:var(--text);
      outline:none;
      font-family:inherit;
    }
    .f textarea{min-height:110px;resize:vertical}
    .modalActions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .modalActions .btn{flex:1}

    /* ===== Mobile ===== */
    @media (max-width: 980px){
      body{overflow:auto}
      .shell{height:auto;min-height:100vh;display:block}
      .sidebar{display:none}
      .topbar{position:sticky;top:0;z-index:10}
      :root{--colw: 85vw;}
      th,td{white-space:normal}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="shell">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">G</div>
        <div class="brandText">G-SOFT</div>
      </div>

      <nav class="nav">
        <a href="#/tasks" data-route="tasks"><span class="ico">üß©</span><span class="txt">Vazifalar</span></a>
        <a href="#/projects" data-route="projects"><span class="ico">üìå</span><span class="txt">Loyihalar</span></a>
        <a href="#/users" data-route="users"><span class="ico">üë•</span><span class="txt">Foydalanuvchilar</span></a>
      </nav>
      <div class="muted" style="margin-top:auto;padding:6px 10px;">G-SOFT</div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="hdrLeft">
          <div id="hdrTitle" class="hdrTitle">‚Äî</div>
          <div id="hdrSub" class="hdrSub">‚Äî</div>
        </div>

        <div class="hdrRight">
          <span id="userPill" class="pill">üë§ -</span>
          <span id="clock" class="pill">--:--:--</span>

          <button id="themeBtn" class="themeBtn" title="Theme">
            <svg class="themeIcon moon" viewBox="0 0 24 24" fill="none">
              <path d="M21 14.5A8.5 8.5 0 0 1 9.5 3 7.5 7.5 0 1 0 21 14.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
            <svg class="themeIcon sun" viewBox="0 0 24 24" fill="none">
              <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z" stroke="currentColor" stroke-width="2"/>
              <path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l1.5 1.5M17.5 17.5 19 19M19 5l-1.5 1.5M6.5 17.5 5 19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>

          <button id="btnLogout" class="btn danger">Chiqish</button>
        </div>
      </header>

      <section class="content">
        <div id="page"></div>
      </section>
    </main>
  </div>

  <!-- MODAL -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalHead">
        <div id="modalTitle" class="modalTitle">‚Äî</div>
        <button class="xBtn" id="modalClose">‚úï</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- GLOBAL LOADING -->
  <div class="loadingOverlay" id="loadingOverlay">
    <div class="loadingCard">
      <div class="loadingRow">
        <div class="spinner"></div>
        <div>
          <div class="loadingTitle" id="loadingTitle">Yuklanmoqda‚Ä¶</div>
          <div class="loadingSub" id="loadingSub">Iltimos, kuting</div>
        </div>
      </div>
    </div>
  </div>

<script>
  /************ CONFIG ************/
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbyGW5vwkyYWmsbSP2_wHFMBoSjJcYLGz7r0gR-R-e5al-efv1hchZIYKCxc5HxG0gvR/exec";
  const API_SECRET = "Gekto2022@";
  const LOGIN_URL = "./login.html";
  const IDLE_MS = 3 * 60 * 1000;
  const TOUCH_DEBOUNCE_MS = 25000;

  /************ SESSION ************/
  let TOKEN = localStorage.getItem("gsoft_token") || "";
  let USER  = safeParse(localStorage.getItem("gsoft_user")) || null;
  let EXP   = Number(localStorage.getItem("gsoft_exp") || "0");
  let lastTouch = 0;

  function isExpired(){ return !TOKEN || !EXP || Date.now() > EXP; }
  function lockToLogin(){
    localStorage.removeItem("gsoft_token");
    localStorage.removeItem("gsoft_user");
    localStorage.removeItem("gsoft_exp");
    localStorage.removeItem("gsoft_last");
    location.replace(LOGIN_URL);
  }
  if (isExpired()) lockToLogin();

  /************ LOADING (BLOCK UI) ************/
  const loadingTitleEl = document.getElementById("loadingTitle");
  const loadingSubEl = document.getElementById("loadingSub");

  function showLoading(title="Yuklanmoqda‚Ä¶", sub="Iltimos, kuting"){
    loadingTitleEl.textContent = title;
    loadingSubEl.textContent = sub;
    document.body.classList.add("isLoading");
  }
  function hideLoading(){
    document.body.classList.remove("isLoading");
  }
  async function withLoading(title, sub, fn){
    showLoading(title, sub);
    try{ return await fn(); }
    finally{ hideLoading(); }
  }

  /************ JSONP ************/
  function jsonp(params){
    return new Promise((resolve,reject)=>{
      const cb = "__cb_" + Math.random().toString(36).slice(2);
      params.callback = cb;

      const u = new URL(ENDPOINT);
      Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));

      const s = document.createElement("script");
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      function cleanup(){
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        s.remove();
      }
      s.onerror = ()=>{ cleanup(); reject(new Error("JSONP_ERROR")); };
      s.src = u.toString();
      document.body.appendChild(s);
    });
  }

  async function api(action, extra={}){
    const res = await jsonp(Object.assign({
      action, api_secret: API_SECRET, token: TOKEN
    }, extra));

    if(!res || res.ok === false){
      const err = res?.error || "";
      if(err === "TOKEN_EXPIRED" || err === "TOKEN_REQUIRED" || err === "USER_INACTIVE"){
        lockToLogin();
      }
    }
    if(res && res.ok && res.ttlSec){
      EXP = Date.now() + res.ttlSec * 1000;
      localStorage.setItem("gsoft_exp", String(EXP));
      if(res.user){
        USER = res.user;
        localStorage.setItem("gsoft_user", JSON.stringify(USER));
      }
    }
    return res;
  }

  async function touch(){
    const now = Date.now();
    if(now - lastTouch < TOUCH_DEBOUNCE_MS) return;
    lastTouch = now;
    try{ await api("touch"); }catch(e){}
  }

  /************ IDLE WATCH ************/
  function markActivity(){
    localStorage.setItem("gsoft_last", String(Date.now()));
    touch();
  }
  function startIdle(){
    if(!localStorage.getItem("gsoft_last")) localStorage.setItem("gsoft_last", String(Date.now()));
    setInterval(()=>{
      const last = Number(localStorage.getItem("gsoft_last") || "0");
      if(last && (Date.now() - last >= IDLE_MS)) lockToLogin();
    }, 2000);
  }
  ["mousemove","keydown","wheel","touchstart","scroll","click"].forEach(ev=>{
    window.addEventListener(ev, markActivity, {passive:true});
  });
  document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) markActivity(); });

  /************ THEME ************/
  const root = document.documentElement;
  function loadTheme(){
    const t = localStorage.getItem("gsoft_theme") || "dark";
    root.setAttribute("data-theme", t);
  }
  function toggleTheme(){
    const cur = root.getAttribute("data-theme") || "dark";
    const next = cur === "dark" ? "light" : "dark";
    root.setAttribute("data-theme", next);
    localStorage.setItem("gsoft_theme", next);
  }
  loadTheme();
  document.getElementById("themeBtn").addEventListener("click", ()=>{ markActivity(); toggleTheme(); });

  /************ TOPBAR ************/
  function pad(n){ return String(n).padStart(2,"0"); }
  function tick(){
    const d = new Date();
    document.getElementById("clock").textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  setInterval(tick, 1000); tick();

  document.getElementById("userPill").textContent = `üë§ ${USER?.ism || USER?.login || "-" } ‚Ä¢ ${USER?.rol || "-"}`;
  document.getElementById("btnLogout").addEventListener("click", async ()=>{
    await withLoading("Chiqish‚Ä¶","Sessiya yopilmoqda", async ()=>{
      try{ await api("logout"); }catch(e){}
    });
    lockToLogin();
  });

  /************ MODAL ************/
  const overlay = document.getElementById("overlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  document.getElementById("modalClose").addEventListener("click", closeModal);
  overlay.addEventListener("click", closeModal);

  function openModal(title, html){
    modalTitle.textContent = title;
    modalBody.innerHTML = html;
    overlay.classList.add("open");
    overlay.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    overlay.classList.remove("open");
    overlay.setAttribute("aria-hidden","true");
    modalBody.innerHTML = "";
  }

  /************ ROUTER ************/
  const hdrTitle = document.getElementById("hdrTitle");
  const hdrSub = document.getElementById("hdrSub");
  const page = document.getElementById("page");

  const Routes = {
    tasks: { title:"Vazifalar", sub:"Kanban ‚Ä¢ drag & timer", render: renderTasks },
    projects: { title:"Loyihalar", sub:"Kanban ‚Ä¢ drag", render: renderProjects },
    users: { title:"Foydalanuvchilar", sub:"Users & roles", render: renderUsers },
  };

  function currentRoute(){
    const h = location.hash || "#/tasks";
    const m = h.match(/^#\/([a-z]+)/i);
    return (m && m[1]) ? m[1].toLowerCase() : "tasks";
  }
  function setActiveNav(){
    const r = currentRoute();
    document.querySelectorAll(".nav a").forEach(a=>{
      a.classList.toggle("active", a.dataset.route === r);
    });
  }
  function render(){
    const r = currentRoute();
    const route = Routes[r] || Routes.tasks;
    hdrTitle.textContent = route.title;
    hdrSub.textContent = route.sub;
    setActiveNav();
    route.render();
  }
  window.addEventListener("hashchange", render);
  if(!location.hash) location.hash = "#/tasks";

  /************ STATE (CACHES) ************/
  let USERS_PUBLIC = [];   // {id, ism, rol}
  let USERS_ADMIN = [];    // full list only admin
  let PROJECTS = [];       // accessible projects
  let TASKS = [];          // accessible tasks (already filtered by role; then we filter by UI)

  const TASK_COLS = [
    {key:"BOSHLANMAGAN", title:"Boshlanmagan", hint:"0 vaqt"},
    {key:"PAUZA",        title:"Pauza",        hint:"to‚Äòxtatilgan"},
    {key:"JARAYONDA",    title:"Jarayonda",    hint:"1 ta vazifa"},
    {key:"BAJARILDI",    title:"Bajarildi",    hint:"‚úÖ"},
    {key:"OTMENA",       title:"Otmena",       hint:"‚ùå"}
  ];

  const PROJECT_COLS = [
    {key:"YANGI",         title:"Yangi"},
    {key:"TZ_BERILDI",    title:"Tz berildi"},
    {key:"TAKLIF_BERILDI",title:"Taklif berildi"},
    {key:"PROCESS",       title:"Process"},
    {key:"OUTSOURCE",     title:"Outsource"},
    {key:"KEYINROQ",      title:"Keyinroq"},
    {key:"BAJARILDI",     title:"Bajarildi"},
    {key:"OTMENA",        title:"Otmena"},
  ];

  // UI filters
  let FILTER_PROJECT = "NO_PROJECT"; // NO_PROJECT | ALL | PRJ-...
  let FILTER_USER = "ALL";           // for admin only
  let TASKS_TIMER_TICK = null;
  let TASKS_HEARTBEAT = null;

  function isAdmin(){ return String(USER?.rol||"").toLowerCase() === "admin"; }
  function isPM(){ return String(USER?.rol||"").toLowerCase() === "pm"; }

  /************ HELPERS ************/
  function safeParse(s){ try{ return JSON.parse(s); }catch(e){ return null; } }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function fmtDate(iso){
    if(!iso) return "";
    const d = new Date(iso);
    if(isNaN(d.getTime())) return String(iso);
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function fmtHM(min){
    const m = Math.max(0, Math.floor(Number(min)||0));
    const h = Math.floor(m/60);
    const mm = m%60;
    if(h<=0) return `${mm}m`;
    return `${h}h ${mm}m`;
  }
  function first3Words(txt){
    const s = String(txt||"").trim().replace(/\s+/g," ");
    if(!s) return "";
    return s.split(" ").slice(0,3).join(" ");
  }
  function computedTaskTitle(t){
    const ttl = String(t.title||"").trim();
    if(ttl) return ttl;
    return first3Words(t.description) || "(No title)";
  }
  function chip(text){ return `<span class="chip">${escapeHtml(text)}</span>`; }

  function findUserName(id){
    const u = USERS_PUBLIC.find(x=>x.id===id);
    return u ? u.ism : "";
  }
  function findProjectTitle(id){
    const p = PROJECTS.find(x=>x.id===id);
    return p ? p.title : "";
  }

  function parseHashQuery(){
    // allow #/tasks?projectId=PRJ-00001
    const h = location.hash || "";
    const q = h.split("?")[1] || "";
    const obj = {};
    q.split("&").forEach(p=>{
      if(!p) return;
      const [k,v] = p.split("=");
      obj[decodeURIComponent(k)] = decodeURIComponent(v||"");
    });
    return obj;
  }

  /************ LOAD BOOT DATA ************/
  async function ensurePublicUsers(){
    if(USERS_PUBLIC.length) return;
    const r = await api("users_public_list");
    if(r?.ok) USERS_PUBLIC = r.users || [];
  }

  async function loadProjects(force=false){
    if(PROJECTS.length && !force) return;
    const r = await api("projects_list");
    if(r?.ok) PROJECTS = r.projects || [];
  }

  async function loadTasks(projectId, userId){
    const r = await api("tasks_list", { projectId, userId });
    if(r?.ok) TASKS = r.tasks || [];
    else TASKS = [];
  }

  /************ USERS PAGE (admin) ************/
  async function renderUsers(){
    if(!isAdmin()){
      page.innerHTML = `<div class="card"><div class="cardTitleRow"><div class="cardTitle">Foydalanuvchilar</div><span class="muted">Faqat admin</span></div><div class="muted">Ruxsat yo‚Äòq.</div></div>`;
      return;
    }

    page.innerHTML = `
      <div class="card">
        <div class="cardTitleRow">
          <div class="cardTitle">Foydalanuvchilar</div>
          <div class="toolbar">
            <span class="muted">admin / pm / fin</span>
            <span class="spacer"></span>
            <button class="btn primary" id="btnAddUser">+ Qo‚Äòshish</button>
            <button class="btn" id="btnReloadUsers">Yangilash</button>
          </div>
        </div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Ism</th>
                <th>Login</th>
                <th>Parol</th>
                <th>Rol</th>
                <th>Active</th>
                <th style="width:90px">Edit</th>
              </tr>
            </thead>
            <tbody id="uBody">
              <tr><td colspan="6" class="muted">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    `;

    document.getElementById("btnAddUser").onclick = ()=>{ markActivity(); openUserModal(); };
    document.getElementById("btnReloadUsers").onclick = async ()=>{ markActivity(); await loadUsersAdmin(true); };

    await loadUsersAdmin();
  }

  async function loadUsersAdmin(force=false){
    await withLoading("Foydalanuvchilar‚Ä¶", "Ma‚Äôlumotlar yuklanmoqda", async ()=>{
      const r = await api("users_list");
      if(r?.ok) USERS_ADMIN = r.users || [];
      // also refresh public
      USERS_PUBLIC = (r?.users||[]).filter(u=>u.active).map(u=>({id:u.id, ism:u.ism, rol:u.rol}));
    });
    drawUsersAdmin();
  }

  function roleChip(role){
    const r = String(role||"").toLowerCase();
    const label = r === "admin" ? "admin" : (r === "pm" ? "pm" : "fin");
    return `<span class="chip">${label}</span>`;
  }
  function mask(p){
    if(!p) return "";
    const s = String(p);
    if(s.length <= 2) return "‚Ä¢‚Ä¢";
    return "‚Ä¢".repeat(Math.min(10, s.length));
  }

  function drawUsersAdmin(){
    const body = document.getElementById("uBody");
    if(!body) return;
    if(!USERS_ADMIN.length){
      body.innerHTML = `<tr><td colspan="6" class="muted">Yo‚Äòq</td></tr>`;
      return;
    }
    body.innerHTML = USERS_ADMIN.map(u=>`
      <tr>
        <td><b>${escapeHtml(u.ism || "")}</b></td>
        <td class="mono">${escapeHtml(u.login || "")}</td>
        <td class="mono" title="${escapeHtml(u.parol||"")}">${escapeHtml(mask(u.parol))}</td>
        <td>${roleChip(u.rol)}</td>
        <td>${u.active ? "‚úÖ" : "‚õî"}</td>
        <td><button class="iconBtn" data-edit="${escapeHtml(u.id)}">‚úèÔ∏è</button></td>
      </tr>
    `).join("");

    body.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.onclick = ()=>{
        markActivity();
        const id = btn.getAttribute("data-edit");
        const u = USERS_ADMIN.find(x=>String(x.id)===String(id));
        openUserModal(u);
      };
    });
  }

  function openUserModal(user=null){
    const isEdit = !!user;
    openModal(isEdit ? "Edit user" : "Add user", `
      <div class="grid">
        <div class="f"><label>Ism</label><input id="fIsm" value="${escapeHtml(user?.ism||"")}" /></div>
        <div class="f">
          <label>Rol</label>
          <select id="fRol">
            <option value="admin" ${String(user?.rol||"")==="admin"?"selected":""}>admin</option>
            <option value="pm" ${String(user?.rol||"")==="pm"?"selected":""}>pm</option>
            <option value="fin" ${String(user?.rol||"")==="fin"?"selected":""}>fin</option>
          </select>
        </div>
      </div>
      <div class="grid" style="margin-top:10px;">
        <div class="f"><label>Login</label><input id="fLogin" value="${escapeHtml(user?.login||"")}" /></div>
        <div class="f"><label>Parol ${isEdit ? '(bo‚Äòsh qoldirsang o‚Äòzgarmaydi)' : ''}</label><input id="fParol" type="password" value="" /></div>
      </div>
      <div class="grid1" style="margin-top:10px;">
        <div class="f">
          <label>Active</label>
          <select id="fActive">
            <option value="true" ${user?.active !== false ? "selected":""}>true</option>
            <option value="false" ${user?.active === false ? "selected":""}>false</option>
          </select>
        </div>
      </div>
      <div id="fMsg" class="muted" style="margin-top:10px;min-height:18px"></div>
      <div class="modalActions">
        <button class="btn" id="btnCancel">Bekor</button>
        <button class="btn primary" id="btnSave">Saqlash</button>
      </div>
    `);

    document.getElementById("btnCancel").onclick = ()=>{ markActivity(); closeModal(); };
    document.getElementById("btnSave").onclick = async ()=>{
      markActivity();
      const ism = document.getElementById("fIsm").value.trim();
      const login = document.getElementById("fLogin").value.trim();
      const rol = document.getElementById("fRol").value.trim();
      const parol = document.getElementById("fParol").value.trim();
      const active = document.getElementById("fActive").value === "true";
      const msg = document.getElementById("fMsg");
      msg.textContent = "";

      if(!ism || !login || !rol){ msg.textContent = "ism/login/rol shart"; return; }
      if(!isEdit && !parol){ msg.textContent = "Yangi user uchun parol shart"; return; }

      const payload = { id:user?.id||"", ism, login, rol, active, parol };

      await withLoading("Saqlash‚Ä¶","Foydalanuvchi yangilanmoqda", async ()=>{
        const res = await api("users_upsert", { payload: encodeURIComponent(JSON.stringify(payload)) });
        if(!res?.ok){ msg.textContent = "Xatolik: " + (res?.error||""); return; }
      });

      // reload without reloading whole app
      await loadUsersAdmin(true);
      closeModal();
    };
  }

  /************ PROJECTS PAGE ************/
  let draggingProjectId = null;

  async function renderProjects(){
    clearTimers();

    page.innerHTML = `
      <div class="card">
        <div class="cardTitleRow">
          <div>
            <div class="cardTitle">Loyihalar</div>
            <div class="muted">Drag & drop bilan status almashtiring ‚Ä¢ Info -> tahrirlash ‚Ä¢ O‚Äòtish -> Vazifalar</div>
          </div>
          <div class="toolbar">
            <button class="btn" id="btnRefreshProjects">Yangilash</button>
          </div>
        </div>
        <div class="board" id="projectsBoard"></div>
      </div>
    `;

    document.getElementById("btnRefreshProjects").onclick = async ()=>{
      markActivity();
      await withLoading("Loyihalar‚Ä¶","Yangilanmoqda", async ()=>{
        await loadProjects(true);
      });
      drawProjectsBoard();
    };

    await withLoading("Loyihalar‚Ä¶","Yuklanmoqda", async ()=>{
      await ensurePublicUsers();
      await loadProjects();
    });

    drawProjectsBoard();
  }

  function drawProjectsBoard(){
    const board = document.getElementById("projectsBoard");
    if(!board) return;

    board.innerHTML = PROJECT_COLS.map(c=>`
      <div class="col" data-pstatus="${c.key}">
        <div class="colHead">
          <div>${escapeHtml(c.title)}</div>
          <small id="pcnt_${c.key}">0</small>
        </div>
        <div class="colBody" id="pcol_${c.key}"></div>
      </div>
    `).join("");

    // fill cards
    const by = {};
    PROJECT_COLS.forEach(c=>by[c.key]=[]);
    PROJECTS.forEach(p=>{
      const st = p.status || "YANGI";
      (by[st] || (by[st]=[])).push(p);
    });

    PROJECT_COLS.forEach(c=>{
      const list = (by[c.key]||[]).slice().sort((a,b)=>{
        // deadline asc
        const da = a.deadline ? new Date(a.deadline).getTime() : 9e15;
        const db = b.deadline ? new Date(b.deadline).getTime() : 9e15;
        return da - db;
      });

      document.getElementById("pcnt_"+c.key).textContent = String(list.length);
      const col = document.getElementById("pcol_"+c.key);

      col.innerHTML = list.map(p=>`
        <div class="pCard" draggable="true" data-id="${escapeHtml(p.id)}">
          <div class="pTitle">${escapeHtml(p.title || "(No title)")}</div>
          <div class="pMeta">
            ${p.ownerName ? `üë§ ${escapeHtml(p.ownerName)}<br/>` : ""}
            ${p.product ? `üì¶ ${escapeHtml(p.product)}<br/>` : ""}
            ${p.pmName ? `üß≠ PM: ${escapeHtml(p.pmName)}<br/>` : ""}
            ${p.deadline ? `‚è≥ ${escapeHtml(fmtDate(p.deadline))}` : ""}
          </div>
          <div class="pBtns">
            <button class="miniBtn" data-info="${escapeHtml(p.id)}">Info</button>
            <button class="miniBtn primary" data-go="${escapeHtml(p.id)}">O‚Äòtish</button>
          </div>
        </div>
      `).join("");

      // events
      col.querySelectorAll(".pCard").forEach(card=>{
        card.addEventListener("dragstart", (e)=>{
          draggingProjectId = card.getAttribute("data-id");
          card.classList.add("dragging");
          e.dataTransfer.setData("text/plain", draggingProjectId);
          e.dataTransfer.effectAllowed = "move";
        });
        card.addEventListener("dragend", ()=>{ card.classList.remove("dragging"); draggingProjectId=null; });
      });

      col.querySelectorAll("[data-info]").forEach(b=>{
        b.onclick = ()=>{ markActivity(); openProjectInfo(b.getAttribute("data-info")); };
      });
      col.querySelectorAll("[data-go]").forEach(b=>{
        b.onclick = ()=>{ markActivity(); goToTasksForProject(b.getAttribute("data-go")); };
      });
    });

    // drop zones
    board.querySelectorAll(".colBody").forEach(zone=>{
      zone.addEventListener("dragover", (e)=>{ e.preventDefault(); zone.classList.add("dropHint"); });
      zone.addEventListener("dragleave", ()=>zone.classList.remove("dropHint"));
      zone.addEventListener("drop", async (e)=>{
        e.preventDefault();
        zone.classList.remove("dropHint");
        const pid = e.dataTransfer.getData("text/plain") || draggingProjectId;
        const colEl = zone.closest(".col");
        const newStatus = colEl.getAttribute("data-pstatus");
        if(!pid || !newStatus) return;

        const pr = PROJECTS.find(x=>x.id===pid);
        if(!pr) return;
        if(pr.status === newStatus) return;

        // optimistic
        pr.status = newStatus;
        drawProjectsBoard();

        await withLoading("Saqlash‚Ä¶","Loyiha status yangilanmoqda", async ()=>{
          const res = await api("project_update_status", { payload: encodeURIComponent(JSON.stringify({id:pid, status:newStatus})) });
          if(!res?.ok){
            // rollback by reloading
            await loadProjects(true);
            drawProjectsBoard();
            return;
          }
          // sync updated
          const upd = res.project;
          const i = PROJECTS.findIndex(x=>x.id===upd.id);
          if(i>=0) PROJECTS[i]=upd;
          drawProjectsBoard();
        });
      });
    });
  }

  function openProjectInfo(projectId){
    const p = PROJECTS.find(x=>x.id===projectId);
    if(!p){ alert("Project topilmadi"); return; }

    // only admin or pm-owner can edit
    const canEdit = isAdmin() || (isPM() && String(p.pmId)===String(USER.id));

    openModal("Project Info", `
      <div class="grid">
        <div class="f"><label>Nomi</label><input id="pr_title" value="${escapeHtml(p.title||"")}" ${canEdit?"":"disabled"}></div>
        <div class="f"><label>Status</label>
          <select id="pr_status" ${canEdit?"":"disabled"}>
            ${PROJECT_COLS.map(c=>`<option value="${c.key}" ${p.status===c.key?"selected":""}>${escapeHtml(c.title)}</option>`).join("")}
          </select>
        </div>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div class="f"><label>Owner</label><input id="pr_ownerName" value="${escapeHtml(p.ownerName||"")}" ${canEdit?"":"disabled"}></div>
        <div class="f"><label>Owner phone</label><input id="pr_ownerPhone" value="${escapeHtml(p.ownerPhone||"")}" ${canEdit?"":"disabled"}></div>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div class="f"><label>Sfera</label><input id="pr_sphere" value="${escapeHtml(p.sphere||"")}" ${canEdit?"":"disabled"}></div>
        <div class="f"><label>Manba</label><input id="pr_source" value="${escapeHtml(p.source||"")}" ${canEdit?"":"disabled"}></div>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div class="f"><label>Shahar</label><input id="pr_city" value="${escapeHtml(p.city||"")}" ${canEdit?"":"disabled"}></div>
        <div class="f"><label>Deadline (ISO yoki matn)</label><input id="pr_deadline" value="${escapeHtml(p.deadline||"")}" ${canEdit?"":"disabled"}></div>
      </div>

      <div class="grid1" style="margin-top:10px;">
        <div class="f"><label>Product/Service</label><input id="pr_product" value="${escapeHtml(p.product||"")}" ${canEdit?"":"disabled"}></div>
      </div>

      <div class="grid1" style="margin-top:10px;">
        <div class="f"><label>Komment</label><textarea id="pr_comment" ${canEdit?"":"disabled"}>${escapeHtml(p.comment||"")}</textarea></div>
      </div>

      <div class="muted" id="pr_msg" style="margin-top:10px;min-height:18px"></div>

      <div class="modalActions">
        <button class="btn" id="pr_go">O‚Äòtish</button>
        ${canEdit ? `<button class="btn primary" id="pr_save">Saqlash</button>` : ``}
        <button class="btn" id="pr_close">Yopish</button>
      </div>
    `);

    document.getElementById("pr_go").onclick = ()=>{ markActivity(); closeModal(); goToTasksForProject(projectId); };
    document.getElementById("pr_close").onclick = ()=>{ markActivity(); closeModal(); };

    if(canEdit){
      document.getElementById("pr_save").onclick = async ()=>{
        markActivity();
        const msg = document.getElementById("pr_msg");
        msg.textContent = "";

        const payload = {
          id: p.id,
          title: document.getElementById("pr_title").value.trim(),
          ownerName: document.getElementById("pr_ownerName").value.trim(),
          ownerPhone: document.getElementById("pr_ownerPhone").value.trim(),
          sphere: document.getElementById("pr_sphere").value.trim(),
          source: document.getElementById("pr_source").value.trim(),
          city: document.getElementById("pr_city").value.trim(),
          comment: document.getElementById("pr_comment").value.trim(),
          product: document.getElementById("pr_product").value.trim(),
          deadline: document.getElementById("pr_deadline").value.trim(),
          status: document.getElementById("pr_status").value.trim(),
          pmId: p.pmId,
          pmName: p.pmName
        };

        await withLoading("Saqlash‚Ä¶","Project yangilanmoqda", async ()=>{
          const res = await api("project_upsert", { payload: encodeURIComponent(JSON.stringify(payload)) });
          if(!res?.ok){ msg.textContent = "Xatolik: " + (res?.error||""); return; }
          const upd = res.project;
          const i = PROJECTS.findIndex(x=>x.id===upd.id);
          if(i>=0) PROJECTS[i]=upd;
        });

        closeModal();
        drawProjectsBoard();
      };
    }
  }

  function goToTasksForProject(projectId){
    FILTER_PROJECT = projectId;
    location.hash = "#/tasks?projectId=" + encodeURIComponent(projectId);
  }

  /************ TASKS PAGE ************/
  let draggingTaskId = null;
  let suppressClickId = null;

  async function renderTasks(){
    // parse project from hash query (for "O‚Äòtish")
    const q = parseHashQuery();
    if(q.projectId) FILTER_PROJECT = q.projectId;

    page.innerHTML = `
      <div class="card">
        <div class="cardTitleRow">
          <div>
            <div class="cardTitle">Vazifalar</div>
            <div class="muted">Boshlanmagan/Pauza -> Jarayonda drag ‚Ä¢ Jarayonda 1 ta ‚Ä¢ Bajarildi/Otmena -> Pauza qaytarish</div>
          </div>
          <div class="toolbar">
            <div class="select">
              <label>Proyekt</label>
              <select id="fProject"></select>
            </div>

            ${isAdmin() ? `
              <div class="select">
                <label>User</label>
                <select id="fUser"></select>
              </div>
            ` : ``}

            <button class="btn" id="btnRefreshTasks">Yangilash</button>
          </div>
        </div>

        <div class="board" id="tasksBoard"></div>
      </div>
    `;

    await withLoading("Vazifalar‚Ä¶","Yuklanmoqda", async ()=>{
      await ensurePublicUsers();
      await loadProjects();
      // set dropdowns
      buildFiltersUI();
      // load tasks by current filters
      await loadTasks(FILTER_PROJECT || "NO_PROJECT", isAdmin()?FILTER_USER:"ALL");
    });

    drawTasksBoard();
    startTaskTimers();
    startHeartbeat();
  }

  function buildFiltersUI(){
    const selP = document.getElementById("fProject");
    if(selP){
      const options = [
        {id:"NO_PROJECT", title:"Bez proyekt (default)"},
        {id:"ALL", title:"Barcha (ALL)"},
        ...PROJECTS.map(p=>({id:p.id, title:p.title || p.id}))
      ];
      selP.innerHTML = options.map(o=>`<option value="${escapeHtml(o.id)}" ${String(FILTER_PROJECT)===String(o.id)?"selected":""}>${escapeHtml(o.title)}</option>`).join("");
      selP.onchange = async ()=>{
        markActivity();
        FILTER_PROJECT = selP.value;
        await withLoading("Filtr‚Ä¶","Vazifalar yangilanmoqda", async ()=>{
          await loadTasks(FILTER_PROJECT, isAdmin()?FILTER_USER:"ALL");
        });
        drawTasksBoard();
      };
    }

    if(isAdmin()){
      const selU = document.getElementById("fUser");
      if(selU){
        // include ALL + users
        const options = [{id:"ALL", title:"Barcha"}].concat(USERS_PUBLIC.map(u=>({id:u.id, title:`${u.ism} (${u.rol})`})));
        selU.innerHTML = options.map(o=>`<option value="${escapeHtml(o.id)}" ${String(FILTER_USER)===String(o.id)?"selected":""}>${escapeHtml(o.title)}</option>`).join("");
        selU.onchange = async ()=>{
          markActivity();
          FILTER_USER = selU.value;
          await withLoading("Filtr‚Ä¶","Vazifalar yangilanmoqda", async ()=>{
            await loadTasks(FILTER_PROJECT, FILTER_USER);
          });
          drawTasksBoard();
        };
      }
    }

    document.getElementById("btnRefreshTasks").onclick = async ()=>{
      markActivity();
      await withLoading("Vazifalar‚Ä¶","Yangilanmoqda", async ()=>{
        await loadProjects(true);
        await loadTasks(FILTER_PROJECT, isAdmin()?FILTER_USER:"ALL");
      });
      buildFiltersUI();
      drawTasksBoard();
    };
  }

  function drawTasksBoard(){
    clearTimers();
    const board = document.getElementById("tasksBoard");
    if(!board) return;

    board.innerHTML = TASK_COLS.map(c=>`
      <div class="col" data-tstatus="${c.key}">
        <div class="colHead">
          <div>${escapeHtml(c.title)} <small>${escapeHtml(c.hint||"")}</small></div>
          <small id="tcnt_${c.key}">0</small>
        </div>
        <div class="colBody" id="tcol_${c.key}"></div>
      </div>
    `).join("");

    const by = {};
    TASK_COLS.forEach(c=>by[c.key]=[]);
    TASKS.forEach(t=>{
      const st = String(t.status||"BOSHLANMAGAN");
      (by[st] || (by[st]=[])).push(t);
    });

    TASK_COLS.forEach(c=>{
      const list = (by[c.key]||[]).slice().sort((a,b)=>{
        const da = a.deadline ? new Date(a.deadline).getTime() : 9e15;
        const db = b.deadline ? new Date(b.deadline).getTime() : 9e15;
        return da - db;
      });

      document.getElementById("tcnt_"+c.key).textContent = String(list.length);
      const col = document.getElementById("tcol_"+c.key);

      col.innerHTML = list.map(t=>{
        const title = computedTaskTitle(t);
        const prTitle = t.projectId ? (t.projectTitle || findProjectTitle(t.projectId) || "") : "";
        const isRunning = t.status === "JARAYONDA";
        const spentLabel = fmtHM(t.spentMin || 0);
        const upd = t.updatedAt ? fmtDate(t.updatedAt) : "";

        const showAssignee = isAdmin() || isPM();
        const assignee = showAssignee ? (t.assigneeName || findUserName(t.assigneeId) || "") : "";

        const deadlineChip = t.deadline ? chip("‚è≥ " + fmtDate(t.deadline)) : "";
        const projectChip = prTitle ? chip("üìå " + prTitle) : "";

        const timerHtml = isRunning
          ? `<span class="timer" data-timer="${escapeHtml(t.id)}">+ 0m</span>`
          : "";

        const reasonHtml = (t.status==="OTMENA" && t.cancelReason)
          ? `<div class="reason">Sabab: ${escapeHtml(t.cancelReason)}</div>`
          : "";

        return `
          <div class="tCard" draggable="true" data-id="${escapeHtml(t.id)}">
            <div class="tTop">
              <div class="tTitle">${escapeHtml(title)}</div>
              <div class="tBadges">${projectChip}${deadlineChip}</div>
            </div>

            <div class="tMeta">
              ${chip("‚è± " + spentLabel)}
              ${t.updatedAt ? chip("üïí " + upd) : ""}
            </div>

            <div class="tLine">
              <div>${showAssignee ? `üë§ ${escapeHtml(assignee||"-")}` : `üë§ ${escapeHtml(t.assigneeName||findUserName(t.assigneeId)||"-")}`}</div>
              <div>${timerHtml}</div>
            </div>

            ${reasonHtml}
          </div>
        `;
      }).join("");

      // card events (drag & click)
      col.querySelectorAll(".tCard").forEach(card=>{
        const id = card.getAttribute("data-id");

        card.addEventListener("dragstart", (e)=>{
          suppressClickId = id;
          draggingTaskId = id;
          card.classList.add("dragging");
          e.dataTransfer.setData("text/plain", id);
          e.dataTransfer.effectAllowed = "move";
        });
        card.addEventListener("dragend", ()=>{
          card.classList.remove("dragging");
          draggingTaskId=null;
          setTimeout(()=>{ suppressClickId=null; }, 50);
        });

        card.addEventListener("click", ()=>{
          if(suppressClickId === id) return; // prevent click after drag
          markActivity();
          openTaskModal(id);
        });
      });
    });

    // drop zones
    board.querySelectorAll(".colBody").forEach(zone=>{
      zone.addEventListener("dragover", (e)=>{ e.preventDefault(); zone.classList.add("dropHint"); });
      zone.addEventListener("dragleave", ()=>zone.classList.remove("dropHint"));

      zone.addEventListener("drop", async (e)=>{
        e.preventDefault();
        zone.classList.remove("dropHint");

        const taskId = e.dataTransfer.getData("text/plain") || draggingTaskId;
        if(!taskId) return;

        const colEl = zone.closest(".col");
        const toStatus = colEl.getAttribute("data-tstatus");
        const t = TASKS.find(x=>x.id===taskId);
        if(!t) return;

        // rules:
        // - to JARAYONDA only from BOSHLANMAGAN/PAUZA
        // - to PAUZA allowed from OTMENA/BAJARILDI (and also from JARAYONDA if you want)
        // - to OTMENA needs reason -> open modal reason
        if (toStatus === "JARAYONDA" && !["BOSHLANMAGAN","PAUZA"].includes(t.status)) return;

        if (toStatus === "OTMENA") {
          // ask reason in modal flow
          openCancelReasonFlow(taskId);
          return;
        }

        // optimistic update
        const oldStatus = t.status;
        t.status = toStatus;
        if(toStatus !== "JARAYONDA") t.startedAt = "";
        drawTasksBoard();
        startTaskTimers();

        await withLoading("Saqlash‚Ä¶","Vazifa status yangilanmoqda", async ()=>{
          const res = await api("task_update_status", { payload: encodeURIComponent(JSON.stringify({id:taskId, status:toStatus})) });
          if(!res?.ok){
            // rollback reload
            await loadTasks(FILTER_PROJECT, isAdmin()?FILTER_USER:"ALL");
          } else {
            // replace updated task (and server might have paused another running task)
            const upd = res.task;
            const i = TASKS.findIndex(x=>x.id===upd.id);
            if(i>=0) TASKS[i]=upd;
            // reload tasks to reflect "other task dropped from Jarayonda"
            await loadTasks(FILTER_PROJECT, isAdmin()?FILTER_USER:"ALL");
          }
        });

        drawTasksBoard();
        startTaskTimers();
      });
    });
  }

  function openCancelReasonFlow(taskId){
    const t = TASKS.find(x=>x.id===taskId);
    if(!t) return;

    openModal("Vazifani bekor qilish", `
      <div class="muted">Sabab yozmasangiz, bekor qilinmaydi.</div>
      <div class="grid1" style="margin-top:10px;">
        <div class="f">
          <label>Sabab</label>
          <textarea id="cancelReason" placeholder="Sabab..."></textarea>
        </div>
      </div>
      <div class="muted" id="cmsg" style="margin-top:10px;min-height:18px"></div>
      <div class="modalActions">
        <button class="btn" id="cNo">Bekor</button>
        <button class="btn primary" id="cYes">OTMENA</button>
      </div>
    `);

    document.getElementById("cNo").onclick = ()=>{ markActivity(); closeModal(); };
    document.getElementById("cYes").onclick = async ()=>{
      markActivity();
      const reason = document.getElementById("cancelReason").value.trim();
      const msg = document.getElementById("cmsg");
      msg.textContent = "";
      if(!reason){ msg.textContent = "Sabab shart"; return; }

      closeModal();

      await withLoading("Saqlash‚Ä¶","Bekor qilinmoqda", async ()=>{
        const res = await api("task_update_status", { payload: encodeURIComponent(JSON.stringify({id:taskId, status:"OTMENA", reason})) });
        if(!res?.ok){
          await loadTasks(FILTER_PROJECT, isAdmin()?FILTER_USER:"ALL");
          return;
        }
        await loadTasks(FILTER_PROJECT, isAdmin()?FILTER_USER:"ALL");
      });

      drawTasksBoard();
      startTaskTimers();
    };
  }

  function openTaskModal(taskId){
    const t = TASKS.find(x=>x.id===taskId);
    if(!t) return;

    const title = computedTaskTitle(t);
    const prTitle = t.projectId ? (t.projectTitle || findProjectTitle(t.projectId) || "") : "";
    const assignee = t.assigneeName || findUserName(t.assigneeId) || "";

    const canReturn = (isAdmin() || isPM()) && (t.status === "BAJARILDI" || t.status === "OTMENA");
    const showAssignee = (isAdmin() || isPM());

    openModal(title, `
      <div class="grid">
        <div class="f"><label>Proyekt</label><input value="${escapeHtml(prTitle || "Bez proyekt")}" disabled></div>
        <div class="f"><label>Status</label><input value="${escapeHtml(t.status)}" disabled></div>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div class="f"><label>Deadline</label><input value="${escapeHtml(t.deadline ? fmtDate(t.deadline) : "")}" disabled></div>
        <div class="f"><label>Potrachennoe</label><input value="${escapeHtml(fmtHM(t.spentMin||0))}" disabled></div>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div class="f"><label>Poslednee izm</label><input value="${escapeHtml(t.updatedAt ? fmtDate(t.updatedAt) : "")}" disabled></div>
        <div class="f"><label>Otvetstvenniy</label><input value="${escapeHtml(showAssignee ? assignee : (assignee || "-"))}" disabled></div>
      </div>

      <div class="grid1" style="margin-top:10px;">
        <div class="f"><label>Opisanie</label><textarea disabled>${escapeHtml(t.description||"")}</textarea></div>
      </div>

      ${t.status==="OTMENA" && t.cancelReason ? `
        <div class="grid1" style="margin-top:10px;">
          <div class="f"><label>Sabab (Otmena)</label><textarea disabled>${escapeHtml(t.cancelReason)}</textarea></div>
        </div>
      ` : ""}

      <div class="modalActions">
        <button class="btn" id="tClose">Yopish</button>
        <button class="btn" id="tStart">Start</button>
        <button class="btn" id="tCancel">Otmena</button>
        <button class="btn primary" id="tDone">Bajarildi</button>
        ${canReturn ? `<button class="btn" id="tReturn">Vazifani qaytarish (Pauza)</button>` : ``}
      </div>
    `);

    document.getElementById("tClose").onclick = ()=>{ markActivity(); closeModal(); };
    document.getElementById("tCancel").onclick = ()=>{ markActivity(); closeModal(); openCancelReasonFlow(taskId); };

    document.getElementById("tStart").onclick = async ()=>{
      markActivity();
      closeModal();

      await withLoading("Start‚Ä¶","Jarayonga o‚Äòtkazilmoqda", async ()=>{
        const res = await api("task_update_status", { payload: encodeURIComponent(JSON.stringify({id:taskId, status:"JARAYONDA"})) });
        if(!res?.ok){
          await loadTasks(FILTER_PROJECT, isAdmin()?FILTER_USER:"ALL");
        } else {
          // reload because server may pause another task
          await loadTasks(FILTER_PROJECT, isAdmin()?FILTER_USER:"ALL");
        }
      });

      drawTasksBoard();
      startTaskTimers();
    };

    document.getElementById("tDone").onclick = async ()=>{
      markActivity();
      closeModal();

      await withLoading("Saqlash‚Ä¶","Bajarildi qilinmoqda", async ()=>{
        const res = await api("task_update_status", { payload: encodeURIComponent(JSON.stringify({id:taskId, status:"BAJARILDI"})) });
        if(!res?.ok) await loadTasks(FILTER_PROJECT, isAdmin()?FILTER_USER:"ALL");
        else await loadTasks(FILTER_PROJECT, isAdmin()?FILTER_USER:"ALL");
      });

      drawTasksBoard();
      startTaskTimers();
    };

    const ret = document.getElementById("tReturn");
    if(ret){
      ret.onclick = async ()=>{
        markActivity();
        closeModal();

        await withLoading("Qaytarish‚Ä¶","Pauzaga o‚Äòtkazilmoqda", async ()=>{
          const res = await api("task_update_status", { payload: encodeURIComponent(JSON.stringify({id:taskId, status:"PAUZA"})) });
          if(!res?.ok) await loadTasks(FILTER_PROJECT, isAdmin()?FILTER_USER:"ALL");
          else await loadTasks(FILTER_PROJECT, isAdmin()?FILTER_USER:"ALL");
        });

        drawTasksBoard();
        startTaskTimers();
      };
    }
  }

  function startTaskTimers(){
    // update running timers every second
    if(TASKS_TIMER_TICK) clearInterval(TASKS_TIMER_TICK);
    TASKS_TIMER_TICK = setInterval(()=>{
      document.querySelectorAll("[data-timer]").forEach(el=>{
        const id = el.getAttribute("data-timer");
        const t = TASKS.find(x=>x.id===id);
        if(!t || t.status!=="JARAYONDA") { el.textContent = ""; return; }
        const start = t.startedAt ? new Date(t.startedAt).getTime() : Date.now();
        const elapsedMin = Math.max(0, Math.floor((Date.now()-start)/60000));
        const total = (Number(t.spentMin)||0) + elapsedMin;
        el.textContent = "+ " + fmtHM(total);
      });
    }, 1000);
  }

  function startHeartbeat(){
    if(TASKS_HEARTBEAT) clearInterval(TASKS_HEARTBEAT);
    // persist time every 45s for self running task
    TASKS_HEARTBEAT = setInterval(async ()=>{
      const running = TASKS.find(t=>t.status==="JARAYONDA" && String(t.assigneeId)===String(USER.id));
      if(!running) return;
      try{
        await api("task_heartbeat", { payload: encodeURIComponent(JSON.stringify({id:running.id})) });
        // we don‚Äôt force reload each time; it‚Äôs ok.
      }catch(e){}
    }, 45000);
  }

  function clearTimers(){
    if(TASKS_TIMER_TICK){ clearInterval(TASKS_TIMER_TICK); TASKS_TIMER_TICK=null; }
    if(TASKS_HEARTBEAT){ clearInterval(TASKS_HEARTBEAT); TASKS_HEARTBEAT=null; }
  }

  /************ BOOT ************/
  (async function boot(){
    startIdle();
    await touch();
    render();
  })();
</script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>G-SOFT</title>

  <style>
    :root{
      --bg:#07121b;
      --card: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --ok:#10b981;
      --bad:#f16262;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --r:16px;
      --gap:12px;
      --dockW: 290px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1000px 520px at 18% 12%, rgba(16,185,129,.18), transparent 60%),
        radial-gradient(900px 520px at 88% 38%, rgba(59,130,246,.14), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      overflow:hidden;
    }

    .topHeader{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      backdrop-filter:blur(10px);
    }
    .hdrLeft{display:flex;flex-direction:column;gap:2px;min-width:0}
    .hdrTitle{font-weight:1000;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hdrSub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hdrRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:9px 12px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);font-size:13px;white-space:nowrap;
    }
    .pill.ok{color:rgba(16,185,129,.95);border-color:rgba(16,185,129,.30);background:rgba(16,185,129,.10)}
    .pill.err{color:rgba(241,98,98,.95);border-color:rgba(241,98,98,.28);background:rgba(241,98,98,.10)}
    .btn{
      border:0;border-radius:12px;
      padding:9px 12px;font-weight:1000;cursor:pointer;
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.10);
      white-space:nowrap;
    }
    .btn.danger{background:rgba(241,98,98,.14);border-color:rgba(241,98,98,.28)}
    .btn:disabled{opacity:.7;cursor:not-allowed}
    .spinner{
      width:16px;height:16px;border-radius:50%;
      border:2px solid rgba(255,255,255,.18);
      border-top-color:rgba(255,255,255,.75);
      animation:spin .8s linear infinite;
      flex:0 0 16px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .app{
      height:calc(100vh - 54px);
      min-height:0;
      padding:var(--gap);
      display:flex;
      gap:var(--gap);
      overflow:hidden;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      min-height:0;
    }

    /* ===== Hidden left filters dock ===== */
    .edgeHotspot{
      position:fixed;left:0;top:0;bottom:0;width:10px;z-index:40;
    }
    .filtersDock{
      position:fixed;left:0;top:0;bottom:0;
      width:var(--dockW);
      transform:translateX(calc(-1 * (var(--dockW) - 12px)));
      transition:transform .18s ease;
      z-index:60;
      padding:12px 10px;
      background:rgba(8,16,24,.92);
      border-right:1px solid rgba(255,255,255,.10);
      backdrop-filter:blur(10px);
      display:flex;flex-direction:column;gap:10px;min-height:0;
    }
    body.filtersOpen .filtersDock{transform:translateX(0)}
    .filtersDock .brand{
      display:flex;align-items:center;gap:10px;
      padding:10px 10px;border-radius:14px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
    }
    .brandLogo{
      width:34px;height:34px;border-radius:12px;
      background:rgba(16,185,129,.18);
      border:1px solid rgba(16,185,129,.30);
      display:grid;place-items:center;font-weight:1000;color:rgba(16,185,129,.95);
    }
    .brandText{font-weight:1000}
    .dockScroll{
      overflow:auto;min-height:0;padding-right:2px;
      scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.22) transparent;
    }
    .dockScroll::-webkit-scrollbar{width:10px}
    .dockScroll::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.12);border-radius:999px;border:2px solid transparent;background-clip:content-box
    }
    .dockScroll:hover::-webkit-scrollbar-thumb{background:rgba(255,255,255,.30);background-clip:content-box}

    .dockTitleRow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .dockTitle{font-weight:1000;font-size:14px}
    .muted{color:rgba(255,255,255,.62);font-size:12px}

    .field{
      display:flex;flex-direction:column;gap:6px;
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      margin-bottom:10px;
    }
    .field label{font-size:12px;color:var(--muted)}
    .field input,.field select{
      width:100%;
      border:0;outline:none;background:transparent;color:var(--text);
      font-size:16px;
    }
    select{
      background:rgba(10,18,26,.65);
      border-radius:10px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.12);
    }
    option{color:#0b1220;background:#fff}

    /* ===== Table area ===== */
    .tableCard{
      flex:1;
      display:flex;
      flex-direction:column;
      min-width:0;min-height:0;
      overflow:hidden;
    }

    .tableTop{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .tableTitle{font-weight:1000}
    .tableMeta{color:var(--muted);font-size:12px;white-space:nowrap}

    .tableScroll{
      flex:1;min-height:0;
      overflow:auto;
      scrollbar-gutter:stable;
      scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.22) transparent;
    }
    .tableScroll::-webkit-scrollbar{width:10px;height:10px}
    .tableScroll::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.12);border-radius:999px;border:2px solid transparent;background-clip:content-box
    }
    .tableScroll:hover::-webkit-scrollbar-thumb{background:rgba(255,255,255,.30);background-clip:content-box}

    table{
      width:100%;
      border-collapse:collapse;
      min-width:1600px;
    }
    thead th{
      position:sticky; top:0; z-index:5;
      text-align:left;
      padding:10px 10px;
      font-size:11px;
      text-transform:uppercase;
      color:rgba(255,255,255,.72);
      background:rgba(10,18,26,.96);
      border-bottom:1px solid rgba(255,255,255,.10);
      white-space:nowrap;
    }
    thead tr.grp th{
      top:0;
      z-index:6;
      background:rgba(10,18,26,.98);
      font-weight:1000;
      letter-spacing:.2px;
    }
    thead tr.cols th{
      top:36px; /* РІС‹СЃРѕС‚Р° РїРµСЂРІРѕР№ СЃС‚СЂРѕРєРё */
      z-index:5;
    }
    tbody td{
      padding:8px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:13px;
      white-space:nowrap;
      max-width:520px;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    tbody tr:hover td{background:rgba(255,255,255,.03)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .imgCell img{
      width:80px;height:80px;object-fit:cover;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      display:block;
    }
    .empty{padding:16px 12px;color:var(--muted);font-size:13px}

    /* Mobile */
    .burger{display:none;width:42px;height:38px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:rgba(255,255,255,.92);cursor:pointer}
    .mOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:80;display:none}
    @media (max-width: 980px){
      body{overflow:auto}
      .app{height:auto;overflow:visible;flex-direction:column}
      .tableCard{min-height:60vh}
      .edgeHotspot{display:none}
      .filtersDock{
        transform:translateX(-110%);
        width:min(320px,85vw);
      }
      body.filtersOpen .filtersDock{transform:translateX(0)}
      .burger{display:inline-flex;align-items:center;justify-content:center}
      thead th{position:static}
      table{min-width:1200px}
    }

    /* ===== Column manager & pager ===== */
    .hiddenColsBar{
      display:flex;flex-wrap:wrap;gap:8px;
      margin:6px 0 10px;
    }
    .chipBtn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.85);
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:800;
      cursor:pointer;
      max-width:100%;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .chipBtn:hover{background:rgba(255,255,255,.10)}
    .colsList{
      display:flex;flex-direction:column;gap:8px;
      max-height:260px;overflow:auto;
      padding-right:2px;
      scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.22) transparent;
    }
    .colsList::-webkit-scrollbar{width:10px}
    .colsList::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.12);border-radius:999px;border:2px solid transparent;background-clip:content-box
    }
    .colsList:hover::-webkit-scrollbar-thumb{background:rgba(255,255,255,.30);background-clip:content-box}
    .colItem{
      display:flex;align-items:center;gap:10px;
      padding:9px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
    }
    .colItem:hover{background:rgba(255,255,255,.05)}
    .colItem input{width:18px;height:18px;cursor:pointer}
    .colItem span{font-size:13px;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    .btn.small{padding:7px 10px;font-size:12px;border-radius:10px}

    .pager{
      padding:10px 12px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;flex-wrap:wrap;
      background:rgba(255,255,255,.02);
    }
    .pagerInfo{color:var(--muted);font-size:12px;white-space:nowrap}
    .pagerBtns{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .pageBtn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.88);
      padding:7px 10px;border-radius:10px;
      font-size:12px;font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .pageBtn:hover{background:rgba(255,255,255,.10)}
    .pageBtn:disabled{opacity:.55;cursor:not-allowed}
    .pageBtn.active{
      border-color:rgba(16,185,129,.35);
      background:rgba(16,185,129,.14);
      color:rgba(16,185,129,.95);
    }
    .pageDots{color:var(--muted);padding:0 4px;font-weight:900}

    /* hide button in table headers */
    .thWrap{
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      width:100%;
    }
    .thTxt{min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .thHideBtn{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.85);
      width:22px;height:22px;border-radius:8px;
      display:grid;place-items:center;
      cursor:pointer;
      opacity:0;
      transform:scale(.95);
      transition:opacity .12s ease, transform .12s ease, background .12s ease;
      flex:0 0 22px;
    }
    thead th:hover .thHideBtn{
      opacity:1;
      transform:scale(1);
    }
    .thHideBtn:hover{background:rgba(241,98,98,.14);border-color:rgba(241,98,98,.28)}
  </style>
</head>

<body>
  <div class="edgeHotspot" id="edgeHotspot"></div>

  <aside class="filtersDock" id="filtersDock">
    <div class="brand">
      <div class="brandLogo">G</div>
      <div class="brandText">G-SOFT</div>
    </div>

    <div class="dockTitleRow">
      <div class="dockTitle">Filtrlar</div>
      <button id="btnReset" class="btn" type="button">Reset</button>
    </div>

    <div class="dockScroll">
      <div class="field">
        <label>PРѕСЃС‚Р°РІС‰РёРє</label>
        <select id="fSupplier">
          <option value="all">Barchasi</option>
        </select>
      </div>

      <div class="field">
        <label>Sotilgan</label>
        <select id="fSold">
          <option value="all">Barchasi</option>
          <option value="sold">Sotilgan</option>
          <option value="unsold">Sotilmagan</option>
        </select>
      </div>

      <div class="field">
        <label>Izoh (Kod / Artikul nomi)</label>
        <input id="qText" placeholder="qidiruv..."/>
      </div>

      <div class="field">
        <label>Kategoriya</label>
        <select id="fCategory">
          <option value="all">Barchasi</option>
        </select>
      </div>

      <div class="field">
        <label>Sezon</label>
        <select id="fSeason">
          <option value="all">Barchasi</option>
        </select>
      </div>

      <div class="field">
        <label>Ostatkada</label>
        <select id="fStock">
          <option value="all">Barchasi</option>
          <option value="yes">Ha (bor)</option>
          <option value="no">YoвЂq</option>
        </select>
      </div>

      <!-- ===== Columns (show/hide) ===== -->
      <div class="field" id="colsSection">
        <label>Ustunlar (koвЂrsatish / yashirish)</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
          <button id="btnColsAll" class="btn small" type="button">Barchasini koвЂrsat</button>
        </div>
        <div class="muted" style="margin-top:8px">
          Ustun checkboxini oвЂchirib вЂ” yashirasiz. Jadval sarlavhasidagi <b>Г—</b> tugmasi bilan ham yashirish mumkin.
        </div>
      </div>

      <div id="hiddenColsBar" class="hiddenColsBar"></div>

      <div class="field">
        <label>Ustun qidirish</label>
        <input id="colSearch" placeholder="ustun nomi..."/>
      </div>

      <div id="colsList" class="colsList"></div>

      <div class="muted">* Menyu yashirin вЂ” chap chetga olib boring.</div>
    </div>
  </aside>

  <div class="mOverlay" id="mOverlay"></div>

  <header class="topHeader">
    <div class="hdrLeft">
      <div class="hdrTitle">Azaly вЂ” <b>Analiz</b></div>
      <div class="hdrSub">Р›РёСЃС‚ вЂњРђРЅР°Р»РёР·вЂќ вЂў 1-СЃС‚СЂРѕРєР°: РіСЂСѓРїРїРёСЂРѕРІРєР° вЂў 2-СЃС‚СЂРѕРєР°: РЅР°Р·РІР°РЅРёСЏ</div>
    </div>

    <div class="hdrRight">
      <span id="userPill" class="pill">рџ‘¤ -</span>
      <button id="btnCols" class="btn" type="button">Ustunlar</button>
      <button id="btnReload" class="btn" type="button">Yangilash</button>
      <button id="btnLogout" class="btn danger" type="button">Chiqish</button>
      <span id="status" class="pill"><span class="muted">Yuklanmoqda...</span></span>
      <button id="burger" class="burger" title="Filters" type="button">в°</button>
    </div>
  </header>

  <main class="app">
    <section class="card tableCard">
      <div class="tableTop">
        <div class="tableTitle">Jadval</div>
        <div id="meta" class="tableMeta">вЂ”</div>
      </div>

      <div class="tableScroll" id="tableScroll">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody">
            <tr><td class="empty" colspan="999">Yuklanmoqda...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="pager" id="pager"></div>
    </section>
  </main>

  <script>
    /************ CONFIG ************/
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbxrHIGjRjAv15oNbT2L8cUnqAP-Tf6AprWRLmv1pu9YxpC6IhbkwMt1rRHuJwRqXW_g-g/exec";
    const API_SECRET = "Azaly2025";

    const LOGIN_URL = "/azalylogin.html";

    const TOKEN_KEY = "azaly_token";
    const USER_KEY  = "azaly_user";
    const LAST_KEY  = "azaly_lastActivity";

    const IDLE_MS = 3 * 60 * 1000;
    const TOUCH_DEBOUNCE_MS = 25000;

    const PAGE_SIZE = 100;
    const COLS_KEY = "azaly_hiddenCols";

    /************ helpers ************/
    function safeParse(s){ try{return JSON.parse(s);}catch(e){return null;} }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function setStatus(type,text,loading=false){
      statusEl.className="pill";
      statusEl.innerHTML = (loading?'<span class="spinner"></span>':'') + `<span>${escapeHtml(text)}</span>`;
      if(type==="ok") statusEl.classList.add("ok");
      if(type==="err") statusEl.classList.add("err");
    }
    function toNum(v){
      if(v==null) return 0;
      if(typeof v==="number") return isFinite(v)?v:0;
      const s = String(v).replace(/\s/g,"").replace(",",".");
      const x = Number(s);
      return isFinite(x)?x:0;
    }
    function normStr(v){ return String(v ?? "").trim(); }
    function normLower(v){ return normStr(v).toLowerCase(); }

    /************ STATE ************/
    let TOKEN = localStorage.getItem(TOKEN_KEY) || "";
    let USER = safeParse(localStorage.getItem(USER_KEY)) || null;

    let GROUPS = [];
    let HEADERS = [];
    let ROWS = [];
    let INDEX = {};
    let OPTIONS = { suppliers:[], categories:[], seasons:[] };

    let lastTouchSentAt = 0;

    let FILTERED = [];
    let CURRENT_PAGE = 1;
    let COL_HIDDEN = new Set();

    /************ DOM ************/
    const userPill = document.getElementById("userPill");
    const statusEl = document.getElementById("status");
    const metaEl = document.getElementById("meta");

    const btnCols = document.getElementById("btnCols");
    const btnReload = document.getElementById("btnReload");
    const btnLogout = document.getElementById("btnLogout");

    const thead = document.getElementById("thead");
    const tbody = document.getElementById("tbody");

    const filtersDock = document.getElementById("filtersDock");
    const edgeHotspot = document.getElementById("edgeHotspot");
    const mOverlay = document.getElementById("mOverlay");
    const burger = document.getElementById("burger");

    const fSupplier = document.getElementById("fSupplier");
    const fSold = document.getElementById("fSold");
    const qText = document.getElementById("qText");
    const fCategory = document.getElementById("fCategory");
    const fSeason = document.getElementById("fSeason");
    const fStock = document.getElementById("fStock");
    const btnReset = document.getElementById("btnReset");

    const pager = document.getElementById("pager");
    const colsList = document.getElementById("colsList");
    const hiddenColsBar = document.getElementById("hiddenColsBar");
    const colSearch = document.getElementById("colSearch");
    const btnColsAll = document.getElementById("btnColsAll");
    const colsSection = document.getElementById("colsSection");

    /************ auth gate ************/
    if(!TOKEN) location.replace(LOGIN_URL);

    /************ columns (show/hide) ************/
    function loadHiddenCols(){
      const arr = safeParse(localStorage.getItem(COLS_KEY)) || [];
      COL_HIDDEN = new Set((arr||[]).filter(x=>typeof x === "string"));
    }
    function saveHiddenCols(){
      localStorage.setItem(COLS_KEY, JSON.stringify([...COL_HIDDEN]));
    }
    function syncHiddenColsToHeaders(){
      const set = new Set((HEADERS||[]).map(h=>String(h||"")));
      COL_HIDDEN = new Set([...COL_HIDDEN].filter(n=>set.has(n)));
      saveHiddenCols();
    }
    function isHiddenCol(i){
      const name = String((HEADERS||[])[i] || "");
      return COL_HIDDEN.has(name);
    }
    function getVisibleCols(){
      const out = [];
      for(let i=0;i<(HEADERS||[]).length;i++){
        if(!isHiddenCol(i)) out.push(i);
      }
      return out;
    }
    function ensureAtLeastOneCol(){
      const vis = getVisibleCols();
      if(vis.length > 0) return;
      COL_HIDDEN.clear();
      saveHiddenCols();
    }
    function buildColsUI(){
      if(!colsList || !hiddenColsBar) return;

      const q = normLower(colSearch?.value || "");
      const hidden = [];
      for(let i=0;i<HEADERS.length;i++){
        if(isHiddenCol(i)) hidden.push(String(HEADERS[i]||""));
      }

      hiddenColsBar.innerHTML = hidden.length
        ? hidden.map(n=>`<button class="chipBtn" type="button" data-colname="${escapeHtml(n)}" title="KoвЂrsatish">${escapeHtml(n)}</button>`).join("")
        : `<span class="muted">Yashirilgan ustun yoвЂq</span>`;

      let html = "";
      for(let i=0;i<HEADERS.length;i++){
        const name = String(HEADERS[i]||"");
        if(q && !normLower(name).includes(q)) continue;
        const checked = !COL_HIDDEN.has(name);
        html += `<label class="colItem" title="${escapeHtml(name)}">
          <input type="checkbox" data-col-idx="${i}" ${checked ? "checked" : ""}>
          <span>${escapeHtml(name || ("Ustun " + (i+1)))}</span>
        </label>`;
      }
      colsList.innerHTML = html || `<div class="muted">Topilmadi</div>`;
    }
    function rebuildAfterColsChange(keepScroll=true){
      ensureAtLeastOneCol();
      buildThead();
      buildColsUI();
      renderPage(CURRENT_PAGE, keepScroll);
    }

    /************ pagination ************/
    function getTotalPages(){
      const total = (FILTERED || []).length;
      return Math.max(1, Math.ceil(total / PAGE_SIZE));
    }
    function getPageItems(cur, totalPages){
      const items = [];
      if(totalPages <= 9){
        for(let i=1;i<=totalPages;i++) items.push(i);
        return items;
      }
      items.push(1);
      let left = Math.max(2, cur - 2);
      let right = Math.min(totalPages - 1, cur + 2);

      if(left > 2) items.push("...");
      for(let p=left; p<=right; p++) items.push(p);
      if(right < totalPages - 1) items.push("...");
      items.push(totalPages);
      return items;
    }
    function renderPager(){
      if(!pager) return;

      const total = (FILTERED || []).length;
      const totalPages = getTotalPages();

      if(total === 0){
        pager.innerHTML = `<div class="pagerInfo">MaвЂ™lumot yoвЂq</div>`;
        return;
      }

      const start = (CURRENT_PAGE - 1) * PAGE_SIZE;
      const end = Math.min(start + PAGE_SIZE, total);

      const items = getPageItems(CURRENT_PAGE, totalPages);

      pager.innerHTML = `
        <div class="pagerInfo">${start+1}вЂ“${end} / ${total} вЂў Sahifa ${CURRENT_PAGE}/${totalPages}</div>
        <div class="pagerBtns">
          <button class="pageBtn" type="button" data-page="prev" ${CURRENT_PAGE<=1 ? "disabled" : ""}>вЂ№ Oldingi 100 ta</button>
          ${items.map(it => it === "..."
            ? `<span class="pageDots">вЂ¦</span>`
            : `<button class="pageBtn ${it===CURRENT_PAGE ? "active" : ""}" type="button" data-page="${it}">${it}</button>`
          ).join("")}
          <button class="pageBtn" type="button" data-page="next" ${CURRENT_PAGE>=totalPages ? "disabled" : ""}>Keyingi 100 ta вЂє</button>
        </div>
      `;
    }

    function renderPage(page, keepScroll=false){
      const total = (FILTERED || []).length;
      const totalPages = getTotalPages();

      const p = Math.min(Math.max(1, Number(page)||1), totalPages);
      CURRENT_PAGE = p;

      const start = (p - 1) * PAGE_SIZE;
      const end = Math.min(start + PAGE_SIZE, total);

      const slice = (FILTERED || []).slice(start, end);
      renderBody(slice);

      if(total){
        metaEl.textContent = `KoвЂrsatildi: ${start+1}вЂ“${end} / ${total.toLocaleString("ru-RU")} вЂў Jami: ${ROWS.length.toLocaleString("ru-RU")}`;
      }else{
        metaEl.textContent = `KoвЂrsatildi: 0 / 0 вЂў Jami: ${ROWS.length.toLocaleString("ru-RU")}`;
      }

      renderPager();

      if(!keepScroll){
        const sc = document.getElementById("tableScroll");
        if(sc) sc.scrollTo({top:0, behavior:"smooth"});
      }
    }

    /************ session ************/
    function clearSession(){
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(USER_KEY);
      localStorage.removeItem(LAST_KEY);
      TOKEN=""; USER=null;
    }
    function lockToLogin(){
      clearSession();
      location.replace(LOGIN_URL);
    }

    /************ JSONP ************/
    function loadJSONP(url){
      return new Promise((resolve,reject)=>{
        const cb="__az_cb_"+Math.random().toString(36).slice(2);
        const sc=document.createElement("script");
        window[cb]=(data)=>{ cleanup(); resolve(data); };
        function cleanup(){ try{delete window[cb];}catch(e){window[cb]=undefined;} sc.remove(); }
        sc.onerror=()=>{ cleanup(); reject(new Error("jsonp error")); };
        const sep = url.includes("?") ? "&" : "?";
        sc.src = url + sep + "callback=" + cb + "&_=" + Date.now();
        document.body.appendChild(sc);
      });
    }
    function apiUrl(params){
      const u=new URL(ENDPOINT);
      Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
      u.searchParams.set("api_secret", API_SECRET);
      return u.toString();
    }
    async function apiRefresh(){ return await loadJSONP(apiUrl({action:"refresh", token:TOKEN})); }
    async function apiTouch(){ return await loadJSONP(apiUrl({action:"touch", token:TOKEN})); }
    async function apiLogout(){ return await loadJSONP(apiUrl({action:"logout", token:TOKEN})); }

    /************ idle ************/
    function markActivity(){
      localStorage.setItem(LAST_KEY, String(Date.now()));
      maybeTouch();
    }
    function getLastActivity(){
      const x=Number(localStorage.getItem(LAST_KEY)||"0");
      return isFinite(x)?x:0;
    }
    function startIdleWatch(){
      if(!getLastActivity()) localStorage.setItem(LAST_KEY, String(Date.now()));
      setInterval(()=>{
        const idle = Date.now() - getLastActivity();
        if(idle >= IDLE_MS) lockToLogin();
      }, 2000);
    }
    async function maybeTouch(){
      const now=Date.now();
      if(now - lastTouchSentAt < TOUCH_DEBOUNCE_MS) return;
      lastTouchSentAt = now;
      try{
        const res = await apiTouch();
        if(!res || !res.ok) lockToLogin();
      }catch(e){}
    }
    function bindActivityEvents(){
      const evs=["mousemove","keydown","wheel","touchstart","scroll","click"];
      evs.forEach(ev=>window.addEventListener(ev, markActivity, {passive:true}));
      document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) markActivity(); });
    }

    /************ Filters dock open/close ************/
    let closeT=null;
    function openDock(){ document.body.classList.add("filtersOpen"); }
    function closeDock(){ document.body.classList.remove("filtersOpen"); }
    edgeHotspot.addEventListener("mouseenter", ()=>{ if(closeT) clearTimeout(closeT); openDock(); });
    filtersDock.addEventListener("mouseenter", ()=>{ if(closeT) clearTimeout(closeT); openDock(); });
    edgeHotspot.addEventListener("mouseleave", ()=>{ closeT=setTimeout(closeDock, 220); });
    filtersDock.addEventListener("mouseleave", ()=>{ closeT=setTimeout(closeDock, 220); });

    burger.addEventListener("click", ()=>{
      openDock();
      mOverlay.style.display="block";
    });
    mOverlay.addEventListener("click", ()=>{
      mOverlay.style.display="none";
      closeDock();
    });

    btnCols.addEventListener("click", ()=>{
      openDock();
      if(window.matchMedia("(max-width: 980px)").matches){
        mOverlay.style.display="block";
      }
      // scroll & focus
      colsSection?.scrollIntoView({behavior:"smooth", block:"start"});
      setTimeout(()=>colSearch?.focus(), 250);
    });

    /************ Build header (groups row1 + columns row2) ************/
    function buildThead(){
      const vis = getVisibleCols();
      const grp = GROUPS.length ? GROUPS : HEADERS.map(()=> "");

      // row 1: groups (merge same consecutive for visible columns)
      const cells = [];
      let k=0;
      while(k < vis.length){
        const i = vis[k];
        const label = String(grp[i] || "");
        let k2 = k + 1;
        while(k2 < vis.length && String(grp[vis[k2]] || "") === label) k2++;
        cells.push({label, colspan: k2 - k});
        k = k2;
      }

      const grpHtml = `
        <tr class="grp">
          ${cells.map(c=>`<th colspan="${c.colspan}">${escapeHtml(c.label)}</th>`).join("")}
        </tr>
      `;

      const colsHtml = `
        <tr class="cols">
          ${vis.map(i=>`
            <th data-col-idx="${i}">
              <div class="thWrap">
                <span class="thTxt">${escapeHtml(HEADERS[i] || "")}</span>
                <button class="thHideBtn" type="button" data-hide-col="${i}" title="Yashirish">Г—</button>
              </div>
            </th>
          `).join("")}
        </tr>
      `;

      thead.innerHTML = grpHtml + colsHtml;
    }

    /************ Options ************/
    function fillSelect(selectEl, list){
      const cur = selectEl.value || "all";
      const base = selectEl.querySelector('option[value="all"]') ? '<option value="all">Barchasi</option>' : "";
      selectEl.innerHTML = base + (list||[]).map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
      selectEl.value = (list||[]).includes(cur) ? cur : "all";
    }

    /************ Row logic ************/
    function idx(name){ return (INDEX && name in INDEX) ? INDEX[name] : null; }
    function cell(row, name){
      const i = idx(name);
      return i==null ? "" : row[i];
    }
    function isSoldRow(row){
      const v = cell(row, "РЎРѕС‚РёР»РіР°РЅ");
      const s = normLower(v);
      if(s === "") return false;
      if(["РґР°","ha","yes","true","1","sotilgan","sold"].some(x=>s===x)) return true;
      if(s.includes("РґР°")) return true;
      if(s.includes("ha")) return true;
      return false;
    }
    function inStockRow(row){
      const q = toNum(cell(row, "РќРµС‡С‚Р° РєРѕР»РіР°РЅР»РёРіРё"));
      if(q > 0) return true;
      const s = toNum(cell(row, "РљРѕР»РіР°РЅ СЃСѓРјРјР°СЃРё")) || toNum(cell(row, "USD РєРѕР»РіР°РЅР»РёРіРё"));
      return s > 0;
    }
    function matchQuery(row, q){
      if(!q) return true;
      const code = normLower(cell(row, "РљРѕРґРё"));
      const art  = normLower(cell(row, "РђСЂС‚РёРєСѓР» РЅРѕРјРё"));
      return (code.includes(q) || art.includes(q));
    }

    function applyFilters(){
      const sup = fSupplier.value;
      const sold = fSold.value;
      const cat = fCategory.value;
      const sez = fSeason.value;
      const st  = fStock.value;
      const q   = normLower(qText.value);

      const out = [];
      for(const r of ROWS){
        if(sup !== "all" && normStr(cell(r,"РџРѕСЃС‚Р°РІС‰РёРє")) !== sup) continue;
        if(cat !== "all" && normStr(cell(r,"РљР°С‚РµРіРѕСЂРёСЏ")) !== cat) continue;
        if(sez !== "all" && normStr(cell(r,"РЎРµР·РѕРЅ")) !== sez) continue;

        if(sold === "sold" && !isSoldRow(r)) continue;
        if(sold === "unsold" && isSoldRow(r)) continue;

        const stockYes = inStockRow(r);
        if(st === "yes" && !stockYes) continue;
        if(st === "no" && stockYes) continue;

        if(!matchQuery(r, q)) continue;
        out.push(r);
      }

      FILTERED = out;
      CURRENT_PAGE = 1;
      renderPage(1);
    }

    /************ Render body (chunked) ************/
    function makeImgUrl(u){
      const s = normStr(u);
      if(!s) return "";
      const m = s.match(/\/d\/([a-zA-Z0-9_-]+)/) || s.match(/id=([a-zA-Z0-9_-]+)/);
      if(m && m[1]) return "https://drive.google.com/uc?export=view&id=" + m[1];
      return s;
    }

    function renderBody(list){
      const vis = getVisibleCols();

      if(!vis || vis.length === 0){
        tbody.innerHTML = `<tr><td class="empty" colspan="1">Ustunlar yashirilgan</td></tr>`;
        return;
      }

      if(!list || list.length===0){
        tbody.innerHTML = `<tr><td class="empty" colspan="${vis.length}">MaвЂ™lumot yoвЂq</td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      const COL_IMG = idx("РўРѕРІР°СЂ СЂР°СЃРјРё");

      let i=0;
      const chunk = 180;

      function step(){
        const end = Math.min(i+chunk, list.length);
        let html = "";
        for(; i<end; i++){
          const row = list[i];
          html += "<tr>";
          for(const c of vis){
            const v = row[c];
            if(COL_IMG!=null && c===COL_IMG){
              const url = makeImgUrl(v);
              html += `<td class="imgCell">${url ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener"><img loading="lazy" src="${escapeHtml(url)}" alt="img"></a>` : "-"}</td>`;
            } else {
              const txt = (v==null || v==="") ? "-" : String(v);
              const cls = (typeof v==="number") ? "mono" : "";
              html += `<td class="${cls}" title="${escapeHtml(txt)}">${escapeHtml(txt)}</td>`;
            }
          }
          html += "</tr>";
        }
        tbody.insertAdjacentHTML("beforeend", html);
        if(i < list.length) requestAnimationFrame(step);
      }

      requestAnimationFrame(step);
    }

    /************ UI events ************/
    function resetFilters(){
      fSupplier.value="all";
      fSold.value="all";
      qText.value="";
      fCategory.value="all";
      fSeason.value="all";
      fStock.value="all";
      applyFilters();
    }

    [fSupplier,fSold,qText,fCategory,fSeason,fStock].forEach(el=>{
      el.addEventListener(el.tagName==="INPUT" ? "input" : "change", ()=>{
        markActivity();
        applyFilters();
      });
    });
    btnReset.addEventListener("click", ()=>{
      markActivity();
      resetFilters();
    });

    btnReload.addEventListener("click", async ()=>{
      markActivity();
      setStatus("", "Yangilanmoqda...", true);
      btnReload.disabled=true;
      try{
        const res = await apiRefresh();
        if(!res || !res.ok) return lockToLogin();
        setData(res);
        setStatus("ok","Tayyor");
      }catch(e){
        setStatus("err","Xatolik");
      }finally{
        btnReload.disabled=false;
      }
    });

    btnLogout.addEventListener("click", async ()=>{
      try{ await apiLogout(); }catch(e){}
      lockToLogin();
    });

    // column hide from header (Г—)
    thead.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-hide-col]");
      if(!btn) return;
      const colIdx = Number(btn.dataset.hideCol);
      if(!Number.isFinite(colIdx)) return;

      const name = String(HEADERS[colIdx] || "");
      if(!name) return;

      COL_HIDDEN.add(name);
      saveHiddenCols();
      rebuildAfterColsChange(true);
    });

    // chips: show hidden column back
    hiddenColsBar.addEventListener("click", (e)=>{
      const b = e.target.closest("[data-colname]");
      if(!b) return;
      const name = String(b.dataset.colname || "");
      if(!name) return;

      COL_HIDDEN.delete(name);
      saveHiddenCols();
      rebuildAfterColsChange(true);
    });

    // checkbox list: show/hide
    colsList.addEventListener("change", (e)=>{
      const cb = e.target;
      if(!(cb instanceof HTMLInputElement)) return;
      if(!cb.matches('input[type="checkbox"][data-col-idx]')) return;

      const i = Number(cb.dataset.colIdx);
      const name = String(HEADERS[i] || "");
      if(!name) return;

      if(cb.checked){
        COL_HIDDEN.delete(name);
      }else{
        COL_HIDDEN.add(name);
      }
      saveHiddenCols();
      rebuildAfterColsChange(true);
    });

    colSearch.addEventListener("input", ()=>buildColsUI());

    btnColsAll.addEventListener("click", ()=>{
      COL_HIDDEN.clear();
      saveHiddenCols();
      rebuildAfterColsChange(true);
    });

    // pager clicks
    pager.addEventListener("click", (e)=>{
      const b = e.target.closest("[data-page]");
      if(!b) return;

      const totalPages = getTotalPages();
      const val = b.dataset.page;

      if(val === "prev") return renderPage(CURRENT_PAGE - 1);
      if(val === "next") return renderPage(CURRENT_PAGE + 1);

      const p = Number(val);
      if(Number.isFinite(p)) return renderPage(Math.min(Math.max(1,p), totalPages));
    });

    function setData(res){
      GROUPS  = res.groupHeaders || [];
      HEADERS = res.headers || [];
      ROWS    = res.rows || [];
      INDEX   = res.index || {};
      OPTIONS = res.options || OPTIONS;

      if(res.user){
        USER = res.user;
        localStorage.setItem(USER_KEY, JSON.stringify(USER));
      }
      userPill.textContent = `рџ‘¤ ${USER?.login || "-"}`;

      fillSelect(fSupplier, OPTIONS.suppliers);
      fillSelect(fCategory, OPTIONS.categories);
      fillSelect(fSeason, OPTIONS.seasons);

      loadHiddenCols();
      syncHiddenColsToHeaders();
      ensureAtLeastOneCol();
      buildColsUI();

      buildThead();
      applyFilters();
    }

    /************ BOOT ************/
    (async function boot(){
      bindActivityEvents();
      startIdleWatch();

      setStatus("", "Yuklanmoqda...", true);
      try{
        const res = await apiRefresh();
        if(!res || !res.ok) return lockToLogin();
        setData(res);
        setStatus("ok","Tayyor");
        if(!localStorage.getItem(LAST_KEY)) localStorage.setItem(LAST_KEY, String(Date.now()));
      }catch(e){
        lockToLogin();
      }
    })();
  </script>
</body>
</html>


<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tests — Cash Tracker</title>

  <style>
    :root{
      --bg:#07121b;
      --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --ok:#10b981;
      --bad:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --r: 16px;
    }
    *{ box-sizing:border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      padding: 16px;
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1000px 520px at 18% 12%, rgba(16,185,129,.18), transparent 60%),
        radial-gradient(900px 520px at 88% 38%, rgba(59,130,246,.14), transparent 55%),
        var(--bg);
      overflow: hidden; /* чтобы всё помещалось в окно */
    }
    .wrap{
      height: calc(100vh - 32px);
      display:flex;
      flex-direction:column;
      gap: 12px;
      max-width: 1400px;
      margin: 0 auto;
      min-height: 0;
    }

    /* top header */
    .top{
      display:flex; gap:12px; flex-wrap:wrap;
      align-items:flex-end; justify-content:space-between;
    }
    h1{ margin:0; font-size: 20px; letter-spacing:.2px; }
    .sub{ margin:6px 0 0; color:var(--muted); font-size: 13px; }

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:flex-end;
    }

    /* small UI */
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }
    .pill.ok{ color: rgba(16,185,129,.95); border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.10); }
    .pill.err{ color: rgba(239,68,68,.95); border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }

    .spinner{
      width: 16px; height: 16px; border-radius: 50%;
      border: 2px solid rgba(255,255,255,.18);
      border-top-color: rgba(255,255,255,.75);
      animation: spin .8s linear infinite;
      flex: 0 0 16px;
    }
    @keyframes spin { to { transform: rotate(360deg);} }

    .btn{
      border:0;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 800;
      cursor:pointer;
      background: var(--ok);
      color:#062a1b;
      box-shadow: var(--shadow);
      white-space: nowrap;
    }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.9);
      border: 1px solid var(--line);
      box-shadow: none;
    }
    .btn:disabled{ opacity:.7; cursor:not-allowed; pointer-events:none; }

    .field{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      min-height: 40px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .field input, .field select{
      width: 100%;
      border:0;
      outline: none;
      background: transparent;
      color: rgba(255,255,255,.92);
      font-size: 13px;
      padding: 0;
      appearance: none;
    }
    .field input::placeholder{ color: rgba(255,255,255,.45); }
    .field small{
      color: rgba(255,255,255,.55);
      font-size: 12px;
      white-space: nowrap;
    }

    /* balances */
    .grid4{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 12px;
    }
    @media (max-width: 1100px){ .grid4{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 560px){
      body{ overflow:auto; }
      .wrap{ height:auto; }
      .grid4{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r);
      padding: 14px;
      min-height: 0;
    }
    .card h3{
      margin:0;
      font-size: 12px;
      letter-spacing:.3px;
      text-transform: uppercase;
      color: rgba(255,255,255,.75);
    }
    .balance{
      margin-top: 8px;
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .balance .cur{
      font-size: 12px;
      font-weight: 800;
      color: rgba(255,255,255,.65);
      margin-left: 6px;
    }
    .hint{
      margin-top: 6px;
      color: rgba(255,255,255,.55);
      font-size: 12px;
    }

    /* horizontal entry form */
    .entryHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }
    .toggle{
      display:flex; gap:8px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 6px;
      width: fit-content;
    }
    .tbtn{
      border:0;
      border-radius: 10px;
      padding: 9px 12px;
      cursor:pointer;
      font-weight: 900;
      background: transparent;
      color: rgba(255,255,255,.75);
      white-space: nowrap;
    }
    .tbtn.in.active{ background: rgba(16,185,129,.15); color: rgba(16,185,129,.95); }
    .tbtn.out.active{ background: rgba(239,68,68,.15); color: rgba(239,68,68,.95); }

    .entryGrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 200px 200px 240px 1fr 1fr auto;
      gap: 10px;
      align-items: end;
    }
    @media (max-width: 1200px){
      .entryGrid{ grid-template-columns: 1fr 1fr 1fr; }
    }
    @media (max-width: 820px){
      body{ overflow:auto; }
      .wrap{ height:auto; }
      .entryGrid{ grid-template-columns: 1fr; }
    }

    .amountwrap{
      display:flex; gap:10px; align-items:center;
      width:100%;
    }
    .amountwrap input{
      font-size: 14px;
      font-weight: 800;
      letter-spacing:.2px;
    }
    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,.75);
      white-space: nowrap;
    }

    /* bottom: filters left + table right */
    .bottom{
      flex: 1;
      min-height: 0; /* важно для скролла внутри */
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 12px;
      align-items: stretch;
    }
    @media (max-width: 980px){
      body{ overflow:auto; }
      .wrap{ height:auto; }
      .bottom{ grid-template-columns: 1fr; }
    }

    /* filters */
    .filtersGrid{ display:grid; gap:10px; margin-top: 10px; }
    .divider{ height:1px; background: rgba(255,255,255,.10); margin: 12px 0; }
    .totRow{
      display:flex; justify-content:space-between; align-items:center;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(255,255,255,.10);
    }
    .totRow:last-child{ border-bottom:0; }
    .totLbl{ color: rgba(255,255,255,.70); font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing:.25px; }
    .totVal{ font-size: 14px; font-weight: 900; }
    .tiny{ font-size: 12px; color: rgba(255,255,255,.65); }

    /* table with scroll */
    .table-wrap{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r);
      overflow: hidden;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }
    .table-scroll{
      min-height: 0;
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-gutter: stable;
      /* Firefox */
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.12) transparent;
    }
    .table-scroll:hover{
      scrollbar-color: rgba(255,255,255,.38) transparent;
    }

    /* Webkit scrollbar */
    .table-scroll::-webkit-scrollbar{ width: 10px; }
    .table-scroll::-webkit-scrollbar-track{ background: transparent; }
    .table-scroll::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      border: 2px solid transparent;
      background-clip: content-box;
    }
    .table-scroll:hover::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.32);
      border: 2px solid transparent;
      background-clip: content-box;
    }

    table{ width:100%; border-collapse: collapse; }
    thead th{
      position: sticky;
      top: 0;
      z-index: 2;
      text-align:left;
      font-size: 12px;
      letter-spacing:.3px;
      text-transform: uppercase;
      color: rgba(255,255,255,.70);
      padding: 11px 12px;
      background: rgba(10,18,26,.96);
      border-bottom: 1px solid var(--line);
      white-space: nowrap;
    }
    tbody td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
      color: rgba(255,255,255,.90);
      vertical-align: top;
    }
    tbody tr:hover td{ background: rgba(255,255,255,.03); }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      color: rgba(255,255,255,.78);
      white-space: nowrap;
    }
    .sum-in{ color: rgba(16,185,129,.95); font-weight: 900; }
    .sum-out{ color: rgba(239,68,68,.95); font-weight: 900; }
    .empty{ padding: 16px 14px; color: var(--muted); font-size: 13px; }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- header -->
    <div class="top">
      <div>
        <h1>Tests — Cash Tracker</h1>
        <div class="sub">Ma’lumotlar Google Sheets → <b>Tests</b> listidan olinadi va JS ichida hisoblanadi.</div>
      </div>

      <div class="toolbar">
        <div class="field" style="min-width:220px">
          <label>Kurs (USD→UZS)</label>
          <input id="rateTop" type="number" step="1" min="1" placeholder="12050" />
          <small>UZS</small>
        </div>

        <button id="btnRefresh" class="btn secondary" type="button">Yangilash</button>
        <span id="status" class="pill"><span>Guruh</span></span>
      </div>
    </div>

    <!-- balances -->
    <div class="grid4">
      <div class="card">
        <h3>Банк</h3>
        <div class="balance"><span id="balBank">0</span><span class="cur">UZS</span></div>
        <div class="hint">Prihod − Rashod</div>
      </div>

      <div class="card">
        <h3>Наличные UZS</h3>
        <div class="balance"><span id="balCashUzs">0</span><span class="cur">UZS</span></div>
        <div class="hint">Naqd UZS</div>
      </div>

      <div class="card">
        <h3>Наличные USD</h3>
        <div class="balance"><span id="balCashUsd">0</span><span class="cur">USD</span></div>
        <div class="hint">Naqd USD</div>
      </div>

      <div class="card">
        <h3>Карта</h3>
        <div class="balance"><span id="balCard">0</span><span class="cur">UZS</span></div>
        <div class="hint">Prihod − Rashod</div>
      </div>
    </div>

    <!-- horizontal entry -->
    <div class="card">
      <div class="entryHead">
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <h3 style="margin:0;">Yangi operatsiya</h3>

          <div class="toggle" aria-label="operation type">
            <button id="tIn" class="tbtn in active" type="button">Приход</button>
            <button id="tOut" class="tbtn out" type="button">Расход</button>
          </div>

          <span id="formMsg" class="pill" style="display:none;"></span>
        </div>

        <button id="btnAdd" class="btn" type="button">OK</button>
      </div>

      <div class="entryGrid">
        <div class="field">
          <label>Кошелек</label>
          <select id="wallet">
            <option value="Банк">Банк</option>
            <option value="Наличные">Наличные</option>
            <option value="Карта">Карта</option>
          </select>
        </div>

        <div class="field" id="currencyBox" style="display:none;">
          <label>Тип валюты</label>
          <select id="currency">
            <option value="UZS">UZS</option>
            <option value="USD">USD</option>
          </select>
        </div>

        <div class="field">
          <label>Сумма</label>
          <div class="amountwrap">
            <input id="amount" type="text" inputmode="decimal" placeholder="0" />
            <span id="amountCur" class="badge">UZS</span>
          </div>
        </div>

        <div class="field">
          <label>Статья</label>
          <input id="article" type="text" placeholder="Masalan: Reklama, Oylik, Xarid..." />
        </div>

        <div class="field">
          <label>Контрагент</label>
          <input id="counterparty" type="text" placeholder="Masalan: Yetkazib beruvchi / Mijoz..." />
        </div>

        <div class="pill" style="justify-content:center;">
          <span class="mono">Дата: avtomatik</span>
        </div>
      </div>
    </div>

    <!-- bottom: filters left + list right -->
    <div class="bottom">
      <div class="card">
        <h3>Filtrlar</h3>

        <div class="filtersGrid">
          <div class="field">
            <label>Дата</label>
            <input id="fDate" type="date" />
          </div>

          <div class="field">
            <label>Кошелек</label>
            <select id="fWallet">
              <option value="all">Barchasi</option>
              <option value="Банк">Банк</option>
              <option value="Наличные">Наличные</option>
              <option value="Карта">Карта</option>
            </select>
          </div>

          <div class="field">
            <label>Контрагент</label>
            <select id="fCounterparty">
              <option value="all">Barchasi</option>
            </select>
          </div>

          <div class="field">
            <label>Тип</label>
            <select id="fType">
              <option value="all">Barchasi</option>
              <option value="IN">Приход</option>
              <option value="OUT">Расход</option>
            </select>
          </div>

          <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button id="btnClearFilters" class="btn secondary" type="button">Tozalash</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="totRow">
          <div>
            <div class="totLbl">Итого Приход</div>
            <div class="tiny">filtr bo‘yicha</div>
          </div>
          <div id="totIn" class="totVal sum-in">0</div>
        </div>

        <div class="totRow">
          <div>
            <div class="totLbl">Итого Расход</div>
            <div class="tiny">filtr bo‘yicha</div>
          </div>
          <div id="totOut" class="totVal sum-out">0</div>
        </div>
      </div>

      <div class="table-wrap">
        <div class="table-scroll" id="tableScroll">
          <table>
            <thead>
              <tr>
                <th>Дата</th>
                <th>Кошелек</th>
                <th>Валюта</th>
                <th>Статья</th>
                <th>Контрагент</th>
                <th>Приход</th>
                <th>Расход</th>
                <th>Курс</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="8" class="empty">Yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <script>
    // === CONFIG ===
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbzTaq3om6frUJHzbbh_3KYYgW0B0KQCDC8ZDNzkBaF9D8bcoRlr7zyuApY4K2AnNX85/exec";
    const SECRET = "mySecret123";
    const SHEET = "Tests";
    const DEFAULT_RATE = 12050;

    // === DOM ===
    const statusEl = document.getElementById("status");
    const tbody = document.getElementById("tbody");
    const tableScroll = document.getElementById("tableScroll");

    const rateTop = document.getElementById("rateTop");
    const btnRefresh = document.getElementById("btnRefresh");

    const balBank = document.getElementById("balBank");
    const balCashUzs = document.getElementById("balCashUzs");
    const balCashUsd = document.getElementById("balCashUsd");
    const balCard = document.getElementById("balCard");

    const tIn = document.getElementById("tIn");
    const tOut = document.getElementById("tOut");
    const walletEl = document.getElementById("wallet");
    const currencyBox = document.getElementById("currencyBox");
    const currencyEl = document.getElementById("currency");
    const amountEl = document.getElementById("amount");
    const amountCur = document.getElementById("amountCur");
    const articleEl = document.getElementById("article");
    const counterpartyEl = document.getElementById("counterparty");
    const btnAdd = document.getElementById("btnAdd");
    const formMsg = document.getElementById("formMsg");

    // filters
    const fDate = document.getElementById("fDate");
    const fWallet = document.getElementById("fWallet");
    const fCounterparty = document.getElementById("fCounterparty");
    const fType = document.getElementById("fType");
    const btnClearFilters = document.getElementById("btnClearFilters");
    const totIn = document.getElementById("totIn");
    const totOut = document.getElementById("totOut");

    // === STATE ===
    let opType = "IN"; // IN | OUT
    let rows = [];     // normalized rows

    // === UI helpers ===
    function setStatus(type, text, loading=false){
      statusEl.className = "pill";
      statusEl.innerHTML = "";
      if (loading) statusEl.innerHTML = '<span class="spinner"></span>';
      statusEl.innerHTML += `<span>${text}</span>`;
      if (type === "ok") statusEl.classList.add("ok");
      if (type === "err") statusEl.classList.add("err");
    }

    function showFormMsg(type, text){
      formMsg.style.display = "inline-flex";
      formMsg.className = "pill";
      if (type === "ok") formMsg.classList.add("ok");
      if (type === "err") formMsg.classList.add("err");
      if (type === "load") {
        formMsg.innerHTML = '<span class="spinner"></span><span>' + text + '</span>';
      } else {
        formMsg.textContent = text;
      }
      if (type === "hide") formMsg.style.display = "none";
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function formatNum(n){
      const x = Number(n);
      if (!isFinite(x)) return "0";
      return x.toLocaleString("ru-RU", { maximumFractionDigits: 2 });
    }

    function parseAmount(s){
      const v = String(s || "")
        .replace(/\s/g, "")
        .replace(/,/g, ".")
        .replace(/[^\d.]/g, "");
      const num = Number(v);
      return isFinite(num) ? num : 0;
    }

    function nowISO(){
      const d = new Date();
      const pad = (x) => String(x).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function dateOnly(isoLike){
      const s = String(isoLike || "");
      const m = s.match(/^(\d{4}-\d{2}-\d{2})/);
      if (m) return m[1];
      const d = new Date(s);
      if (!isNaN(d.getTime())) {
        const pad = (x) => String(x).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      }
      return "";
    }

    // JSONP loader (CORS bypass)
    function loadJSONP(url){
      return new Promise((resolve, reject) => {
        const cbName = "__cb_" + Math.random().toString(36).slice(2);
        const script = document.createElement("script");

        window[cbName] = (data) => {
          cleanup();
          resolve(data);
        };

        function cleanup(){
          try { delete window[cbName]; } catch(e){ window[cbName] = undefined; }
          if (script.parentNode) script.parentNode.removeChild(script);
        }

        script.onerror = () => {
          cleanup();
          reject(new Error("JSONP load error"));
        };

        const sep = url.includes("?") ? "&" : "?";
        script.src = url + sep + "callback=" + cbName + "&_=" + Date.now();
        document.body.appendChild(script);
      });
    }

    // === Data logic ===
    function getTopRate(){
      const r = Number(rateTop.value || DEFAULT_RATE);
      return (isFinite(r) && r > 0) ? r : DEFAULT_RATE;
    }

    function normalizeRow(r){
      return {
        date: String(r.date || r.ts || ""),
        wallet: String(r.wallet || ""),
        currency: String(r.currency || "UZS").toUpperCase(),
        article: String(r.article || ""),
        counterparty: String(r.counterparty || ""),
        income: Number(r.income || 0) || 0,
        expense: Number(r.expense || 0) || 0,
        rate: Number(r.rate || 0) || 0
      };
    }

    function computeBalances(list){
      const topRate = getTopRate();
      let bankUZS = 0, cardUZS = 0, cashUZS = 0, cashUSD = 0;

      for (const rr of list){
        const r = normalizeRow(rr);
        const net = (r.income - r.expense);
        const rate = r.rate > 0 ? r.rate : topRate;

        if (r.wallet === "Наличные"){
          if (r.currency === "USD") cashUSD += net;
          else cashUZS += net;
        } else if (r.wallet === "Банк"){
          bankUZS += (r.currency === "USD") ? net * rate : net;
        } else if (r.wallet === "Карта"){
          cardUZS += (r.currency === "USD") ? net * rate : net;
        }
      }
      return { bankUZS, cardUZS, cashUZS, cashUSD };
    }

    function renderBalances(){
      const b = computeBalances(rows);
      balBank.textContent = formatNum(b.bankUZS);
      balCard.textContent = formatNum(b.cardUZS);
      balCashUzs.textContent = formatNum(b.cashUZS);
      balCashUsd.textContent = formatNum(b.cashUSD);
    }

    function renderTable(list){
      if (!list || list.length === 0){
        tbody.innerHTML = `<tr><td colspan="8" class="empty">Operatsiyalar yoq</td></tr>`;
        return;
      }

      const sorted = [...list].reverse();

      tbody.innerHTML = sorted.map(r0 => {
        const r = normalizeRow(r0);
        const inc = r.income ? `<span class="sum-in">${formatNum(r.income)}</span>` : `<span class="mono">-</span>`;
        const exp = r.expense ? `<span class="sum-out">${formatNum(r.expense)}</span>` : `<span class="mono">-</span>`;
        const rate = (r.currency === "USD") ? (r.rate || getTopRate()) : "-";

        return `
          <tr>
            <td class="mono">${escapeHtml(dateOnly(r.date) || "-")}</td>
            <td>${escapeHtml(r.wallet || "-")}</td>
            <td class="mono">${escapeHtml(r.currency || "UZS")}</td>
            <td>${escapeHtml(r.article || "-")}</td>
            <td>${escapeHtml(r.counterparty || "-")}</td>
            <td>${inc}</td>
            <td>${exp}</td>
            <td class="mono">${escapeHtml(String(rate))}</td>
          </tr>
        `;
      }).join("");

      // чтобы “10 строк” визуально было стабильно — всегда сверху
      tableScroll.scrollTop = 0;
    }

    function buildCounterpartyOptions(keepValue){
      const set = new Set();
      for (const r0 of rows){
        const c = (normalizeRow(r0).counterparty || "").trim();
        if (c) set.add(c);
      }
      const list = Array.from(set).sort((a,b)=>a.localeCompare(b,"ru"));
      const prev = keepValue ?? fCounterparty.value;

      fCounterparty.innerHTML = `<option value="all">Barchasi</option>` + list.map(x =>
        `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`
      ).join("");

      if (prev && (prev === "all" || list.includes(prev))) fCounterparty.value = prev;
      else fCounterparty.value = "all";
    }

    function renderTotals(list){
      let inUZS=0, inUSD=0, outUZS=0, outUSD=0;

      for (const r0 of list){
        const r = normalizeRow(r0);
        if (r.currency === "USD") {
          inUSD += r.income;
          outUSD += r.expense;
        } else {
          inUZS += r.income;
          outUZS += r.expense;
        }
      }

      const inParts = [];
      const outParts = [];

      if (inUZS) inParts.push(`${formatNum(inUZS)} UZS`);
      if (inUSD) inParts.push(`${formatNum(inUSD)} USD`);
      if (!inParts.length) inParts.push("0");

      if (outUZS) outParts.push(`${formatNum(outUZS)} UZS`);
      if (outUSD) outParts.push(`${formatNum(outUSD)} USD`);
      if (!outParts.length) outParts.push("0");

      totIn.textContent = inParts.join(" · ");
      totOut.textContent = outParts.join(" · ");
    }

    function applyFilters(){
      const d = fDate.value;
      const w = fWallet.value;
      const c = fCounterparty.value;
      const t = fType.value;

      const filtered = rows.filter(r0 => {
        const r = normalizeRow(r0);

        if (d && dateOnly(r.date) !== d) return false;
        if (w !== "all" && r.wallet !== w) return false;
        if (c !== "all" && r.counterparty !== c) return false;

        if (t === "IN" && !(r.income > 0)) return false;
        if (t === "OUT" && !(r.expense > 0)) return false;

        return true;
      });

      renderTable(filtered);
      renderTotals(filtered);
      return filtered;
    }

    async function refresh(){
      setStatus("", "Yuklanmoqda...", true);
      btnRefresh.disabled = true;

      try {
        const url = `${ENDPOINT}?secret=${encodeURIComponent(SECRET)}&sheet=${encodeURIComponent(SHEET)}&limit=5000`;
        const data = await loadJSONP(url);
        if (!data || data.ok !== true) throw new Error(data?.error || "unknown_error");

        rows = Array.isArray(data.rows) ? data.rows.map(normalizeRow) : [];
        renderBalances();

        buildCounterpartyOptions();
        applyFilters();

        setStatus("ok", `Yuklandi: ${rows.length} ta`);
      } catch (e){
        console.error(e);
        setStatus("err", "Xatolik: ma'lumot olinmadi");
        tbody.innerHTML = `<tr><td colspan="8" class="empty">Operatsiyalar yoq</td></tr>`;
        totIn.textContent = "0";
        totOut.textContent = "0";
      } finally {
        btnRefresh.disabled = false;
      }
    }

    // === Form logic ===
    function setOpType(type){
      opType = type;
      tIn.classList.toggle("active", type==="IN");
      tOut.classList.toggle("active", type==="OUT");
    }

    function updateWalletUI(){
      const w = walletEl.value;
      if (w === "Наличные"){
        currencyBox.style.display = "";
      } else {
        currencyBox.style.display = "none";
        currencyEl.value = "UZS";
      }
      amountCur.textContent = currencyEl.value;
    }

    amountEl.addEventListener("input", () => {
      amountEl.value = amountEl.value.replace(/[^\d.,\s]/g, "");
    });

    tIn.addEventListener("click", () => setOpType("IN"));
    tOut.addEventListener("click", () => setOpType("OUT"));
    walletEl.addEventListener("change", updateWalletUI);
    currencyEl.addEventListener("change", () => amountCur.textContent = currencyEl.value);

    btnRefresh.addEventListener("click", refresh);

    // filters events
    fDate.addEventListener("change", applyFilters);
    fWallet.addEventListener("change", applyFilters);
    fCounterparty.addEventListener("change", applyFilters);
    fType.addEventListener("change", applyFilters);

    btnClearFilters.addEventListener("click", () => {
      fDate.value = "";
      fWallet.value = "all";
      fCounterparty.value = "all";
      fType.value = "all";
      applyFilters();
    });

    rateTop.addEventListener("input", () => {
      renderBalances();
      applyFilters();
    });

    async function addOperation(){
      const wallet = walletEl.value;
      const currency = (wallet === "Наличные") ? currencyEl.value : "UZS";

      const amount = parseAmount(amountEl.value);
      if (!amount || amount <= 0){
        showFormMsg("err", "Summa 0 bo‘lishi mumkin emas");
        return;
      }

      const article = (articleEl.value || "").trim();
      const counterparty = (counterpartyEl.value || "").trim();
      const rate = (currency === "USD") ? getTopRate() : "";

      const payload = {
        secret: SECRET,
        action: "add",
        sheet: SHEET,
        date: nowISO(),
        wallet,
        currency,
        article,
        counterparty,
        income: (opType === "IN") ? amount : 0,
        expense: (opType === "OUT") ? amount : 0,
        rate: (currency === "USD") ? Number(rate) : ""
      };

      btnAdd.disabled = true;
      showFormMsg("load", "Yuborilmoqda...");

      try {
        await fetch(ENDPOINT, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        amountEl.value = "";
        articleEl.value = "";
        counterpartyEl.value = "";

        showFormMsg("ok", "Qabul qilindi ✅");
        setTimeout(() => showFormMsg("hide",""), 1400);

        await new Promise(r => setTimeout(r, 500));
        await refresh();
      } catch (e){
        console.error(e);
        showFormMsg("err", "Xatolik. Qayta urinib ko‘ring.");
      } finally {
        btnAdd.disabled = false;
      }
    }

    btnAdd.addEventListener("click", addOperation);

    // init
    rateTop.value = DEFAULT_RATE;
    setOpType("IN");
    updateWalletUI();
    refresh();
  </script>
</body>
</html>

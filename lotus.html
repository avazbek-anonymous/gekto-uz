<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lotus</title>
  <style>
    :root{--bg:#0b1220;--card:#0f1930;--text:#e9eefc;--muted:#a9b4d0;--accent:#48d1a5;--danger:#ff5a6b;--warn:#ffd05a;--line:rgba(255,255,255,.08);--shadow:0 12px 30px rgba(0,0,0,.35);--radius:18px}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1000px 700px at 20% 10%, rgba(72,209,165,.18), transparent 60%),radial-gradient(900px 700px at 90% 30%, rgba(120,140,255,.16), transparent 55%),var(--bg);color:var(--text);min-height:100vh}
    .top{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:rgba(11,18,32,.75);border-bottom:1px solid var(--line)}
    .topIn{max-width:1200px;margin:0 auto;padding:12px 14px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px;min-width:220px}
    .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px rgba(72,209,165,.7)}
    .brandTitle{display:flex;flex-direction:column;line-height:1.1}
    .brandTitle b{font-size:14px}
    .brandTitle span{font-size:12px;color:var(--muted)}
    .actions{display:flex;flex-wrap:wrap;gap:10px;align-items:center;flex:1;justify-content:flex-end}
    .control{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:14px;padding:8px 10px}
    .control label{font-size:12px;color:var(--muted)}
    select,input[type="date"]{background:transparent;border:none;outline:none;color:var(--text);font-size:13px;min-width:140px}
    select option{background:#0b1220;color:var(--text)}
    .btn{border-radius:14px;padding:10px 12px;border:1px solid rgba(72,209,165,.55);background:rgba(72,209,165,.14);color:var(--text);font-weight:900;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btnGhost{border:1px solid var(--line);background:rgba(255,255,255,.04);font-weight:800}
    .spin{display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,.35);border-top-color:var(--text);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .container{max-width:1200px;margin:0 auto;padding:14px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top}
    th{font-size:12px;color:var(--muted);text-align:left;position:sticky;top:68px;background:rgba(11,18,32,.65);backdrop-filter:blur(8px)}
    td{font-size:13px}
    .muted{color:var(--muted)}
    .mono{font-variant-numeric:tabular-nums}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);font-size:12px}
    .right{text-align:right}
    .row2{display:flex;gap:8px;flex-wrap:wrap}
    .mobileList{display:none}
    .mItem{padding:12px;border-bottom:1px solid rgba(255,255,255,.06)}
    .mTop{display:flex;justify-content:space-between;gap:10px}
    .mTitle{font-weight:900}
    .mSub{color:var(--muted);font-size:12px;margin-top:4px}
    .mPay{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    @media (max-width:860px){th{top:116px}.brand{min-width:auto}select,input[type="date"]{min-width:120px}}
    @media (max-width:720px){table{display:none}.mobileList{display:block}.control{width:100%;justify-content:space-between}.actions{justify-content:stretch}.btn{width:100%;justify-content:center}}
    .overlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);z-index:50;padding:14px}
    .overlay.show{display:flex;align-items:flex-end;justify-content:center}
    .modal{width:min(720px,100%);
    background: linear-gradient(180deg, rgb(0 0 0), rgb(0 0 0));
    border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden;max-height:92vh;display:flex;flex-direction:column}
    .mHead{padding:14px 14px 10px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.06)}
    .x{width:36px;height:36px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text);cursor:pointer}
    .mBody{padding:14px;overflow:auto}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.modal{border-radius:22px 22px 0 0;width:100%}.grid{grid-template-columns:1fr}}
    .field label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    .field input,.field select,.field textarea{width:100%;padding:11px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.18);color:var(--text);outline:none;font-size:14px}
    textarea{min-height:76px;resize:vertical}
    .hint{font-size:11px;color:var(--muted);margin-top:6px}
    .danger{color:var(--danger)}
    .mFoot{padding:12px 14px;border-top:1px solid rgba(255,255,255,.06);display:flex;gap:10px}
    .mFoot .btn{flex:1}
    .payBox{margin-top:12px;border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:12px;background:rgba(0,0,0,.12)}
    .payTitle{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .sumLine{margin-top:10px;display:flex;justify-content:space-between;align-items:center;font-size:13px}
  </style>
</head>
<body>

<div class="top">
  <div class="topIn">
    <div class="brand">
      <div class="dot"></div>
      <div class="brandTitle">
        <b>LOTUS • Usluga baza</b>
        <span id="userLine">Загрузка...</span>
      </div>
    </div>

    <div class="actions">
      <div class="control"><label>Услуга</label><select id="fService"></select></div>
      <div class="control"><label>Мастер</label><select id="fMaster"></select></div>
      <div class="control"><label>Дата</label><input id="fDate" type="date"/></div>
      <button class="btn" id="btnCreate" onclick="openModal()"><span>＋</span> Создать</button>
      <button class="btn btnGhost" id="btnLogout" onclick="logout()">Выйти</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="card">
    <div id="listLoading" style="padding:14px; display:none;">
      <span class="spin"></span> <span class="muted">Загрузка списка...</span>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:165px;">Sana</th>
          <th>Услуга / Мастер</th>
          <th class="right" style="width:120px;">Summa</th>
          <th style="width:260px;">Оплата</th>
          <th style="width:220px;">Комментарий</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="mobileList" id="mobileList"></div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="overlayClose(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mHead">
      <b>Создать запись</b>
      <button class="x" onclick="closeModal()">✕</button>
    </div>
    <div class="mBody">
      <div class="grid">
        <div class="field"><label>Sana (дата и время)</label><input id="mSana" type="datetime-local"/></div>
        <div class="field"><label>Xizmat (Massage kodi)</label><select id="mService"></select></div>
        <div class="field"><label>Master (Texnik kodi)</label><select id="mMaster"></select></div>
        <div class="field"><label>Narx (Daromad)</label><input id="mNarx" type="text" readonly/><div class="hint">Подтягивается из Info.</div></div>
        <div class="field"><label>Skidka % (Foiz)</label><input id="mFoiz" type="number" min="0" max="100" step="0.01" value="0"/></div>
        <div class="field">
          <label>Sertifikat</label>
          <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
            <label class="pill" style="cursor:pointer;"><input type="radio" name="certMode" value="sum" checked/> сумма</label>
            <label class="pill" style="cursor:pointer;"><input type="radio" name="certMode" value="pct"/> %</label>
          </div>
          <input id="mCertVal" type="number" min="0" step="0.01" value="0"/>
        </div>
        <div class="field"><label>Summa (итог)</label><input id="mSumma" type="text"/><div class="hint" id="autoHint"></div></div>
        <div class="field" style="grid-column:1/-1;"><label>Izoh</label><textarea id="mIzoh" placeholder="Комментарий..."></textarea></div>
      </div>

      <div class="payBox">
        <div class="payTitle"><b>Оплата</b><span class="muted mono" id="payCheckLine"></span></div>
        <div class="grid">
          <div class="field"><label>Click</label><input id="pClick" type="text" inputmode="numeric" placeholder="0"/></div>
          <div class="field"><label>Payme</label><input id="pPayme" type="text" inputmode="numeric" placeholder="0"/></div>
          <div class="field"><label>Карта 8037</label><input id="pCard" type="text" inputmode="numeric" placeholder="0"/></div>
          <div class="field"><label>Наличные</label><input id="pCash" type="text" inputmode="numeric" placeholder="0"/><div class="hint">### ### ### (в базу без пробелов)</div></div>
          <div class="field" style="grid-column:1/-1;"><label>Uzcard/Humo Term.</label><input id="pUz" type="text" inputmode="numeric" placeholder="0"/></div>
        </div>
        <div class="sumLine"><span class="muted">Итого оплаты</span><b class="mono" id="payTotal">0</b></div>
      </div>

      <div class="hint danger" id="formError" style="margin-top:10px;"></div>
    </div>

    <div class="mFoot">
      <button class="btn btnGhost" id="btnCancel" onclick="closeModal()">Закрыть</button>
      <button class="btn" id="btnOk" onclick="submitCreate()">OK</button>
    </div>
  </div>
</div>

<script>
  // === ВСТАВЬ СЮДА Web App URL ===
  const API_URL = "https://script.google.com/macros/s/AKfycbwAhWboyZuVAE9RtcRMye39XKygcQBWRrXKjiWRd681cayTk_HEYeiDYV0iGy1oJ60VGA/exec";
  // ===============================
  const SECRET = "mySecret123";
  const STORAGE_KEY = "lotus_token";

  function jsonp(action, params){
    params = params || {};
    return new Promise((resolve, reject) => {
      const cbName = "__lotus_cb_" + Date.now() + "_" + Math.floor(Math.random()*1e9);
      window[cbName] = (data) => { cleanup(); resolve(data); };

      function cleanup(){
        try { delete window[cbName]; } catch(e){ window[cbName]=undefined; }
        if (script && script.parentNode) script.parentNode.removeChild(script);
        clearTimeout(timer);
      }

      const u = new URL(API_URL);
      u.searchParams.set("callback", cbName);
      u.searchParams.set("secret", SECRET);
      u.searchParams.set("action", action);
      Object.keys(params).forEach(k => {
        if (params[k] == null) return;
        u.searchParams.set(k, String(params[k]));
      });

      const script = document.createElement("script");
      script.src = u.toString();
      script.onerror = () => { cleanup(); reject(new Error("JSONP_ERROR")); };
      document.head.appendChild(script);

      const timer = setTimeout(() => { cleanup(); reject(new Error("TIMEOUT")); }, 25000);
    });
  }

  let STATE = { token:"", user:null, services:[], masters:[], priceByService:{}, rows:[], loading:false, modalBusy:false, autoSum:0 };

  function setUserLine(text){ document.getElementById("userLine").textContent = text; }
  function setListLoading(on){ document.getElementById("listLoading").style.display = on ? "block" : "none"; }
  function disableTop(on){
    ["btnCreate","btnLogout","fService","fMaster","fDate"].forEach(id=>document.getElementById(id).disabled = on);
  }

  function todayTashkentYMD(){
    return new Intl.DateTimeFormat("en-CA",{timeZone:"Asia/Tashkent",year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date());
  }
  function nowTashkentDatetimeLocal(){
    const parts = new Intl.DateTimeFormat("en-GB",{timeZone:"Asia/Tashkent",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:false}).formatToParts(new Date());
    const g = (t)=> parts.find(p=>p.type===t)?.value || "";
    return `${g("year")}-${g("month")}-${g("day")}T${g("hour")}:${g("minute")}`;
  }

  function numFromUi(v){
    if (v == null) return 0;
    let s = String(v).trim();
    if (!s) return 0;
    s = s.replace(/\s+/g, "").replace(/,/g, ".").replace(/[^\d\.\-]/g, "");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }
  function fmtMoney(n){
    n = numFromUi(n);
    const s = Math.round(n*100)/100;
    return s.toLocaleString("ru-RU");
  }
  function fmtCashSpaces(raw){
    const digits = String(raw || "").replace(/\D+/g, "");
    if (!digits) return "";
    return digits.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }
  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
  }

  function getFilters(){
    return {
      service: document.getElementById("fService").value || "all",
      master: document.getElementById("fMaster").value || "all",
      date: document.getElementById("fDate").value || ""
    };
  }

  function fillSelect(el, items, allLabel){
    el.innerHTML = "";
    if (allLabel){
      const o = document.createElement("option"); o.value="all"; o.textContent=allLabel;
      el.appendChild(o);
    }
    for (const it of items){
      const o = document.createElement("option");
      if (typeof it === "string"){ o.value = it; o.textContent = it; }
      else { o.value = it.code; o.textContent = it.code; }
      el.appendChild(o);
    }
  }

  function payPills(pay, small){
    pay = pay || {};
    const parts = [];
    const add = (k, v)=>{ const n = numFromUi(v); if (n>0) parts.push(`<span class="pill mono">${k}: <b>${fmtMoney(n)}</b></span>`); };
    add("Click", pay.click); add("Payme", pay.payme); add("8037", pay.card8037); add("Cash", pay.cash); add("Term", pay.uzterm);
    if (parts.length===0) return `<span class="muted">${small ? "Оплата: 0" : "Нет оплат"}</span>`;
    return parts.join(" ");
  }

  function renderList(rows){
    const tb = document.getElementById("tbody");
    const ml = document.getElementById("mobileList");
    tb.innerHTML = ""; ml.innerHTML = "";

    if (!rows || rows.length===0){
      const empty = document.createElement("div");
      empty.style.padding="14px";
      empty.innerHTML = `<span class="muted">Нет данных по фильтрам.</span>`;
      ml.appendChild(empty);
      return;
    }

    for (const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">
          <div><b>${(r.sana||"").replace("T"," ").slice(0,16)}</b></div>
          <div class="muted" style="font-size:12px;margin-top:4px;">внесено: ${(r.kiritilgan||"").replace("T"," ").slice(0,16)}</div>
        </td>
        <td>
          <div class="row2">
            <span class="pill"><b>${escapeHtml(r.service||"")}</b></span>
            <span class="pill">${escapeHtml(r.master||"")}</span>
          </div>
          <div class="muted" style="font-size:12px;margin-top:6px;">
            Narx: <b class="mono" style="color:var(--text)">${fmtMoney(r.narx)}</b>
            • Skidka%: <b class="mono" style="color:var(--text)">${numFromUi(r.foiz)}</b>
            • Sert: <b class="mono" style="color:var(--text)">${fmtMoney((r.cert?.sum||0))}</b>
          </div>
        </td>
        <td class="right mono"><b>${fmtMoney(r.summa)}</b></td>
        <td>${payPills(r.pay)}</td>
        <td><span class="muted">${escapeHtml(r.izoh||"")}</span></td>
      `;
      tb.appendChild(tr);

      const item = document.createElement("div");
      item.className="mItem";
      item.innerHTML = `
        <div class="mTop">
          <div>
            <div class="mTitle">${escapeHtml(r.service||"")} • ${escapeHtml(r.master||"")}</div>
            <div class="mSub mono">${(r.sana||"").replace("T"," ").slice(0,16)} • Summa: <b>${fmtMoney(r.summa)}</b></div>
            <div class="mSub">Narx: <b class="mono" style="color:var(--text)">${fmtMoney(r.narx)}</b> • Skidka%: <b class="mono" style="color:var(--text)">${numFromUi(r.foiz)}</b></div>
          </div>
        </div>
        <div class="mPay">${payPills(r.pay,true)}</div>
        ${r.izoh ? `<div class="mSub" style="margin-top:10px;">${escapeHtml(r.izoh)}</div>` : ``}
      `;
      ml.appendChild(item);
    }
  }

  async function boot(){
    STATE.token = localStorage.getItem(STORAGE_KEY) || "";
    if (!STATE.token){ window.location.replace("/lotuslogin.html"); return; }

    const chk = await jsonp("check", { token: STATE.token }).catch(()=>null);
    if (!chk || !chk.ok){
      localStorage.removeItem(STORAGE_KEY);
      window.location.replace("/lotuslogin.html");
      return;
    }
    STATE.user = chk.user;
    setUserLine(`${STATE.user.name || STATE.user.login} • сессия до конца дня`);

    document.getElementById("fDate").value = todayTashkentYMD();
    ["fService","fMaster","fDate"].forEach(id=>document.getElementById(id).addEventListener("change", refreshList));

    await loadMeta();
    await refreshList();
  }

  async function loadMeta(){
    disableTop(true); setListLoading(true);
    const r = await jsonp("meta", { token: STATE.token }).catch(()=>null);
    if (!r || !r.ok){ alert("Не удалось загрузить справочники (Info)."); disableTop(false); setListLoading(false); return; }

    STATE.services = r.services || [];
    STATE.masters = r.masters || [];
    STATE.priceByService = r.priceByService || {};

    fillSelect(document.getElementById("fService"), STATE.services, "Все услуги");
    fillSelect(document.getElementById("fMaster"), STATE.masters.map(x=>x), "Все мастера");
    fillSelect(document.getElementById("mService"), STATE.services, null);
    fillSelect(document.getElementById("mMaster"), STATE.masters.map(x=>x), null);

    disableTop(false); setListLoading(false);
  }

  async function refreshList(){
    if (STATE.loading) return;
    STATE.loading = true;
    disableTop(true); setListLoading(true);

    const f = getFilters();
    const r = await jsonp("list", { token: STATE.token, service: f.service, master: f.master, date: f.date }).catch(()=>null);
    if (r && r.ok) { STATE.rows = r.rows || []; renderList(STATE.rows); }
    else alert("Не удалось загрузить список.");

    setListLoading(false); disableTop(false); STATE.loading = false;
  }

  function logout(){
    const token = STATE.token;
    localStorage.removeItem(STORAGE_KEY);
    jsonp("logout", { token }).catch(()=>{});
    window.location.replace("/lotuslogin.html");
  }

  // MODAL
  function overlayClose(e){ if (e.target && e.target.id==="overlay") closeModal(); }
  function openModal(){
    if (STATE.loading) return;
    document.getElementById("overlay").classList.add("show");
    document.getElementById("formError").textContent="";

    document.getElementById("mIzoh").value="";
    document.getElementById("mFoiz").value="0";
    document.getElementById("mCertVal").value="0";

    document.getElementById("mSana").value=nowTashkentDatetimeLocal();
    if (STATE.services.length) document.getElementById("mService").value=STATE.services[0].code;
    if (STATE.masters.length) document.getElementById("mMaster").value=STATE.masters[0];

    hookModalEvents_();
    // очистим Summa, чтобы пересчиталась авто
    document.getElementById("mSumma").value="";
    ["pClick","pPayme","pCard","pCash","pUz"].forEach(id=>document.getElementById(id).value="");

    recomputeModal();
    recomputePayTotal();
  }
  function closeModal(){ if (STATE.modalBusy) return; document.getElementById("overlay").classList.remove("show"); }

  let MODAL_HOOKED=false;
  function hookModalEvents_(){
    if (MODAL_HOOKED) return; MODAL_HOOKED=true;
    document.getElementById("mService").addEventListener("change",recomputeModal);
    document.getElementById("mFoiz").addEventListener("input",recomputeModal);
    document.querySelectorAll('input[name="certMode"]').forEach(r=>r.addEventListener("change",recomputeModal));
    document.getElementById("mCertVal").addEventListener("input",recomputeModal);
    document.getElementById("mSumma").addEventListener("input",recomputePayTotal);

    ["pClick","pPayme","pCard","pUz"].forEach(id=>document.getElementById(id).addEventListener("input",recomputePayTotal));
    const cash=document.getElementById("pCash");
    cash.addEventListener("input",()=>{ cash.value=fmtCashSpaces(cash.value); recomputePayTotal(); });
  }

  function recomputeModal(){
    const service=document.getElementById("mService").value||"";
    const narx=Number(STATE.priceByService[service]||0);
    document.getElementById("mNarx").value=fmtMoney(narx);

    const foiz=numFromUi(document.getElementById("mFoiz").value);
    const certMode=document.querySelector('input[name="certMode"]:checked')?.value||"sum";
    const certVal=numFromUi(document.getElementById("mCertVal").value);

    const skidkaAmt=narx*(foiz/100);
    let certSum=0;
    if (certVal>0) certSum=(certMode==="pct")?(narx*(certVal/100)):certVal;

    let auto=narx-skidkaAmt-certSum;
    auto=Math.round(auto*100)/100;
    STATE.autoSum=auto;

    const sumEl=document.getElementById("mSumma");
    if (!sumEl.value.trim()) sumEl.value=fmtMoney(auto);

    document.getElementById("autoHint").innerHTML=`Auto: <b class="mono" style="color:var(--text)">${fmtMoney(auto)}</b>`;
    recomputePayTotal();
  }

  function recomputePayTotal(){
    const sum=numFromUi(document.getElementById("mSumma").value);
    const click=numFromUi(document.getElementById("pClick").value);
    const payme=numFromUi(document.getElementById("pPayme").value);
    const card=numFromUi(document.getElementById("pCard").value);
    const cash=numFromUi(String(document.getElementById("pCash").value).replace(/\s+/g,""));
    const uz=numFromUi(document.getElementById("pUz").value);

    const total=Math.round((click+payme+card+cash+uz)*100)/100;
    document.getElementById("payTotal").textContent=fmtMoney(total);

    const line=document.getElementById("payCheckLine");
    if (Math.abs(total-sum)<=0.01){ line.textContent="OK"; line.style.color="var(--accent)"; }
    else { line.textContent="Должно быть равно Summa"; line.style.color="var(--warn)"; }
  }

  function formErr(s){ document.getElementById("formError").textContent=s||""; }

  function setModalBusy(b, text){
    STATE.modalBusy=b;
    const ok=document.getElementById("btnOk");
    const cancel=document.getElementById("btnCancel");
    ok.disabled=b; cancel.disabled=b;

    const ids=["mSana","mService","mMaster","mFoiz","mCertVal","mSumma","mIzoh","pClick","pPayme","pCard","pCash","pUz"];
    ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.disabled=b; });
    document.querySelectorAll('input[name="certMode"]').forEach(r=>r.disabled=b);

    ok.innerHTML=b?`<span class="spin"></span>${text||"Отправка..."}`:"OK";
  }

  async function submitCreate(){
    if (STATE.modalBusy) return;
    formErr("");

    const sana=document.getElementById("mSana").value.trim();
    const service=document.getElementById("mService").value.trim();
    const master=document.getElementById("mMaster").value.trim();
    const foiz=numFromUi(document.getElementById("mFoiz").value);
    const certMode=document.querySelector('input[name="certMode"]:checked')?.value||"sum";
    const certVal=numFromUi(document.getElementById("mCertVal").value);
    const summa=numFromUi(document.getElementById("mSumma").value);
    const izoh=document.getElementById("mIzoh").value.trim();

    const payClick=numFromUi(document.getElementById("pClick").value);
    const payPayme=numFromUi(document.getElementById("pPayme").value);
    const payCard8037=numFromUi(document.getElementById("pCard").value);
    const payCash=numFromUi(String(document.getElementById("pCash").value).replace(/\s+/g,""));
    const payUzterm=numFromUi(document.getElementById("pUz").value);

    if (!sana) return formErr("Поле Sana обязательно.");
    if (!service) return formErr("Выбери Xizmat.");
    if (!master) return formErr("Выбери Master.");
    if (foiz<0 || foiz>100) return formErr("Skidka% должна быть 0–100.");

    const payTotal=Math.round((payClick+payPayme+payCard8037+payCash+payUzterm)*100)/100;
    if (Math.abs(payTotal-summa)>0.01) return formErr(`Оплата (${fmtMoney(payTotal)}) должна быть равна Summa (${fmtMoney(summa)}).`);

    setModalBusy(true,"Отправка...");
    disableTop(true);

    const f = getFilters();
    const r = await jsonp("create", {
      token: STATE.token,
      // поля
      sana, service, master, foiz, certMode, certVal, summa, izoh,
      payClick, payPayme, payCard8037, payCash, payUzterm,
      // чтобы сервер вернул список уже с текущими фильтрами
      f_service: f.service,
      f_master:  f.master,
      f_date:    f.date
    }).catch(()=>null);

    if (!r || !r.ok){
      if (r && r.error==="PAY_SUM_MISMATCH") formErr("Оплата не равна Summa (проверь суммы).");
      else formErr("Ошибка сохранения.");
      setModalBusy(false); disableTop(false);
      return;
    }

    STATE.rows=r.rows||[];
    renderList(STATE.rows);
    closeModal();
    setModalBusy(false); disableTop(false);
  }

  boot();
</script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lotus</title>
  <style>
    :root{
      --bg:#0b1220;--card:#0f1930;--text:#e9eefc;--muted:#a9b4d0;
      --accent:#48d1a5;--danger:#ff5a6b;--warn:#ffd05a;
      --line:rgba(255,255,255,.08);--shadow:0 12px 30px rgba(0,0,0,.35);--radius:18px
    }
    *{box-sizing:border-box}
    html,body{max-width:100%;overflow-x:hidden}
    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(1000px 700px at 20% 10%, rgba(72,209,165,.18), transparent 60%),
                 radial-gradient(900px 700px at 90% 30%, rgba(120,140,255,.16), transparent 55%),
                 var(--bg);
      color:var(--text);min-height:100vh;
    }

    .top{
      position:sticky;top:0;z-index:10;
      backdrop-filter:blur(10px);
      background:rgba(11,18,32,.75);
      border-bottom:1px solid var(--line);
    }
    .topIn{
      max-width:1200px;margin:0 auto;
      padding:12px 14px;
      display:flex;flex-wrap:wrap;gap:10px;
      align-items:center;justify-content:space-between;
    }

    .brand{display:flex;align-items:center;gap:10px;min-width:220px;max-width:100%}
    .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px rgba(72,209,165,.7)}
    .brandTitle{display:flex;flex-direction:column;line-height:1.1}
    .brandTitle b{font-size:14px}
    .brandTitle span{font-size:12px;color:var(--muted);word-break:break-word}

    .actions{
      display:flex;flex-wrap:wrap;gap:10px;
      align-items:center;flex:1;
      justify-content:flex-end;max-width:100%;
    }
    .control{
      display:flex;align-items:center;gap:8px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:14px;padding:8px 10px;
      max-width:100%;
    }
    .control label{font-size:12px;color:var(--muted);white-space:nowrap}
    select,input[type="date"]{
      background:transparent;border:none;outline:none;color:var(--text);
      font-size:13px;min-width:140px;max-width:100%;
    }
    select{appearance:none}
    select option{background:#0b1220;color:var(--text)}

    .btn{
      border-radius:14px;padding:10px 12px;
      border:1px solid rgba(72,209,165,.55);
      background:rgba(72,209,165,.14);
      color:var(--text);font-weight:900;
      cursor:pointer;display:inline-flex;align-items:center;gap:8px;
      max-width:100%;
    }
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btnGhost{border:1px solid var(--line);background:rgba(255,255,255,.04);font-weight:800}
    .spin{display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,.35);border-top-color:var(--text);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .container{max-width:1200px;margin:0 auto;padding:14px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);overflow:hidden;max-width:100%;
    }

    .muted{color:var(--muted)}
    .mono{font-variant-numeric:tabular-nums}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      font-size:12px;max-width:100%;
    }
    .row2{display:flex;gap:8px;flex-wrap:wrap;max-width:100%}
    .right{text-align:right}
    .clamp2{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    /* === NEW: DESKTOP LIST LIKE YOUR SCREEN (card rows) === */
    .dHead{
      display:grid;
      grid-template-columns: 150px minmax(220px, 1.4fr) 120px minmax(220px, 1fr) minmax(180px, 1fr);
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      position:sticky;
      top:68px;
      z-index:2;
      background:rgba(11,18,32,.65);
      backdrop-filter:blur(10px);
    }
    .dHead div{
      font-size:12px;
      color:var(--muted);
      letter-spacing:.2px;
    }

    .dList{padding:12px 14px; display:flex; flex-direction:column; gap:10px}
    .dRow{
      display:grid;
      grid-template-columns: 150px minmax(220px, 1.4fr) 120px minmax(220px, 1fr) minmax(180px, 1fr);
      gap:12px;
      align-items:center;
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.025));
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      max-width:100%;
    }
    .dCell{min-width:0}
    .dTitle{font-weight:900; line-height:1.2; word-break:break-word}
    .dSub{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35}
    .dMoney{font-weight:900; font-size:15px}
    .dPay{display:flex; gap:8px; flex-wrap:wrap}
    .dDate b{font-weight:900}

    /* mobile list */
    .mobileList{display:none; padding:12px 14px}
    .mItem{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.025));
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      padding:12px;
      margin-bottom:10px;
      max-width:100%;
    }
    .mTop{display:flex;justify-content:space-between;gap:10px}
    .mTitle{font-weight:900;word-break:break-word}
    .mSub{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.35}
    .mPay{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;max-width:100%}

    @media (max-width:860px){
      .brand{min-width:auto}
      select,input[type="date"]{min-width:120px}
      .dHead{top:118px}
    }

    /* MOBILE FIX: никаких выездов вправо */
    @media (max-width:720px){
      .topIn{flex-direction:column;align-items:stretch;justify-content:flex-start}
      .brand{width:100%}
      .actions{width:100%;justify-content:stretch}
      .control{width:100%;justify-content:space-between}
      .control label{min-width:60px}
      .control select,.control input[type="date"]{min-width:0;width:100%;text-align:right}
      .btn{width:100%;justify-content:center}

      /* hide desktop list, show mobile cards */
      .dHead,.dList{display:none}
      .mobileList{display:block}
    }

    .overlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);z-index:50;padding:14px}
    .overlay.show{display:flex;align-items:flex-end;justify-content:center}
    @media (max-width:720px){ .overlay{padding:0} }

    .modal{
      width:min(720px,100%);
      background: linear-gradient(180deg, rgb(0 0 0), rgb(0 0 0));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
      max-height:92vh;
      display:flex;flex-direction:column;
      max-width:100%;
    }
    .mHead{padding:14px 14px 10px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.06)}
    .x{width:36px;height:36px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text);cursor:pointer}
    .mBody{padding:14px;overflow:auto}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:100%}
    @media (max-width:720px){
      .modal{border-radius:22px 22px 0 0;width:100%}
      .grid{grid-template-columns:1fr}
    }

    .field label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    .field input,.field select,.field textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);outline:none;font-size:14px;
      max-width:100%;
    }
    textarea{min-height:76px;resize:vertical}
    .hint{font-size:11px;color:var(--muted);margin-top:6px}
    .danger{color:var(--danger)}
    .mFoot{padding:12px 14px;border-top:1px solid rgba(255,255,255,.06);display:flex;gap:10px}
    .mFoot .btn{flex:1}

    .payBox{margin-top:12px;border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:12px;background:rgba(0,0,0,.12)}
    .payTitle{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px}
    .sumLine{margin-top:10px;display:flex;justify-content:space-between;align-items:center;font-size:13px;gap:10px}

    /* Красивые “чекбоксы” (на деле radio-сегменты) */
    .seg{display:flex;gap:10px}
    .seg input{position:absolute;opacity:0;pointer-events:none}
    .seg label{
      flex:1;
      text-align:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
    }
    .seg label:active{transform:scale(.99)}
    .seg input:checked + label{
      border-color:rgba(72,209,165,.55);
      background:rgba(72,209,165,.14);
      color:var(--text);
      box-shadow:0 0 0 4px rgba(72,209,165,.08) inset;
    }
  </style>
</head>
<body>

<div class="top">
  <div class="topIn">
    <div class="brand">
      <div class="dot"></div>
      <div class="brandTitle">
        <b>LOTUS • Usluga baza</b>
        <span id="userLine">Загрузка...</span>
      </div>
    </div>

    <div class="actions">
      <div class="control"><label>Услуга</label><select id="fService"></select></div>
      <div class="control"><label>Мастер</label><select id="fMaster"></select></div>
      <div class="control"><label>Дата</label><input id="fDate" type="date"/></div>
      <button class="btn" id="btnCreate" onclick="openModal()"><span>＋</span> Создать</button>
      <button class="btn btnGhost" id="btnLogout" onclick="logout()">Выйти</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="card">
    <div id="listLoading" style="padding:14px; display:none;">
      <span class="spin"></span> <span class="muted">Загрузка списка...</span>
    </div>

    <!-- desktop header like your screen -->
    <div class="dHead">
      <div>Sana</div>
      <div>Usluga / Master</div>
      <div class="right">Summa</div>
      <div>To'lov</div>
      <div>Izoh</div>
    </div>

    <!-- desktop cards list -->
    <div class="dList" id="desktopList"></div>

    <!-- mobile cards list -->
    <div class="mobileList" id="mobileList"></div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="overlayClose(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="mHead">
      <b>Создать запись</b>
      <button class="x" onclick="closeModal()">✕</button>
    </div>
    <div class="mBody">
      <div class="grid">
        <div class="field"><label>Sana (только дата)</label><input id="mSana" type="date"/></div>

        <div class="field"><label>Xizmat (Massage kodi)</label><select id="mService"></select></div>
        <div class="field"><label>Master (Texnik kodi)</label><select id="mMaster"></select></div>

        <div class="field">
          <label>Narx (Daromad)</label>
          <input id="mNarx" type="text" readonly/>
          <div class="hint">Подтягивается из Info.</div>
        </div>

        <div class="field">
          <label>Skidka % (Foiz)</label>
          <input id="mFoiz" type="number" min="0" max="100" step="0.01" value="0"/>
        </div>

        <div class="field">
          <label>Sertifikat</label>
          <div class="seg" style="margin-bottom:8px">
            <input id="certSum" type="radio" name="certMode" value="sum" checked>
            <label for="certSum">summa</label>
            <input id="certPct" type="radio" name="certMode" value="pct">
            <label for="certPct">%</label>
          </div>
          <input id="mCertVal" type="number" min="0" step="0.01" value="0"/>
        </div>

        <div class="field">
          <label>Summa (итог)</label>
          <input id="mSumma" type="text"/>
          <div class="hint" id="autoHint"></div>
        </div>

        <div class="field" style="grid-column:1/-1;">
          <label>Izoh</label>
          <textarea id="mIzoh" placeholder="Комментарий..."></textarea>
        </div>
      </div>

      <div class="payBox">
        <div class="payTitle">
          <b>Оплата</b>
          <span class="muted mono" id="payCheckLine"></span>
        </div>

        <div class="grid">
          <div class="field"><label>Click</label><input id="pClick" type="text" inputmode="numeric" placeholder="0"/></div>
          <div class="field"><label>Payme</label><input id="pPayme" type="text" inputmode="numeric" placeholder="0"/></div>
          <div class="field"><label>Карта 8037</label><input id="pCard" type="text" inputmode="numeric" placeholder="0"/></div>
          <div class="field">
            <label>Наличные</label>
            <input id="pCash" type="text" inputmode="numeric" placeholder="0"/>
            <div class="hint">### ### ### (в базу без пробелов)</div>
          </div>
          <div class="field" style="grid-column:1/-1;"><label>Uzcard/Humo Term.</label><input id="pUz" type="text" inputmode="numeric" placeholder="0"/></div>
        </div>

        <div class="sumLine">
          <span class="muted">Итого оплаты</span>
          <b class="mono" id="payTotal">0</b>
        </div>
      </div>

      <div class="hint danger" id="formError" style="margin-top:10px;"></div>
    </div>

    <div class="mFoot">
      <button class="btn btnGhost" id="btnCancel" onclick="closeModal()">Закрыть</button>
      <button class="btn" id="btnOk" onclick="submitCreate()">OK</button>
    </div>
  </div>
</div>

<script>
  // === ВСТАВЬ СЮДА Web App URL ===
  const API_URL = "https://script.google.com/macros/s/AKfycbwAhWboyZuVAE9RtcRMye39XKygcQBWRrXKjiWRd681cayTk_HEYeiDYV0iGy1oJ60VGA/exec";
  // ===============================
  const SECRET = "mySecret123";
  const STORAGE_KEY = "lotus_token";

  function jsonp(action, params){
    params = params || {};
    return new Promise((resolve, reject) => {
      const cbName = "__lotus_cb_" + Date.now() + "_" + Math.floor(Math.random()*1e9);
      window[cbName] = (data) => { cleanup(); resolve(data); };

      function cleanup(){
        try { delete window[cbName]; } catch(e){ window[cbName]=undefined; }
        if (script && script.parentNode) script.parentNode.removeChild(script);
        clearTimeout(timer);
      }

      const u = new URL(API_URL);
      u.searchParams.set("callback", cbName);
      u.searchParams.set("secret", SECRET);
      u.searchParams.set("action", action);
      Object.keys(params).forEach(k => {
        if (params[k] == null) return;
        u.searchParams.set(k, String(params[k]));
      });

      const script = document.createElement("script");
      script.src = u.toString();
      script.onerror = () => { cleanup(); reject(new Error("JSONP_ERROR")); };
      document.head.appendChild(script);

      const timer = setTimeout(() => { cleanup(); reject(new Error("TIMEOUT")); }, 25000);
    });
  }

  let STATE = {
    token:"", user:null, services:[], masters:[], priceByService:{},
    rows:[], loading:false, modalBusy:false,
    autoSum:0, sumManual:false
  };

  function setUserLine(text){ document.getElementById("userLine").textContent = text; }
  function setListLoading(on){ document.getElementById("listLoading").style.display = on ? "block" : "none"; }
  function disableTop(on){
    ["btnCreate","btnLogout","fService","fMaster","fDate"].forEach(id=>document.getElementById(id).disabled = on);
  }

  function todayTashkentYMD(){
    return new Intl.DateTimeFormat("en-CA",{timeZone:"Asia/Tashkent",year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date());
  }

  function numFromUi(v){
    if (v == null) return 0;
    let s = String(v).trim();
    if (!s) return 0;
    s = s.replace(/\s+/g, "").replace(/,/g, ".").replace(/[^\d\.\-]/g, "");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }
  function fmtMoney(n){
    n = numFromUi(n);
    const s = Math.round(n*100)/100;
    return s.toLocaleString("ru-RU");
  }
  function fmtCashSpaces(raw){
    const digits = String(raw || "").replace(/\D+/g, "");
    if (!digits) return "";
    return digits.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }
  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
  }
  function onlyDate(s){
    s = String(s||"");
    return s.length >= 10 ? s.slice(0,10) : s;
  }

  function getFilters(){
    return {
      service: document.getElementById("fService").value || "all",
      master: document.getElementById("fMaster").value || "all",
      date: document.getElementById("fDate").value || ""
    };
  }

  function fillSelect(el, items, allLabel){
    el.innerHTML = "";
    if (allLabel){
      const o = document.createElement("option"); o.value="all"; o.textContent=allLabel;
      el.appendChild(o);
    }
    for (const it of items){
      const o = document.createElement("option");
      if (typeof it === "string"){ o.value = it; o.textContent = it; }
      else { o.value = it.code; o.textContent = it.code; }
      el.appendChild(o);
    }
  }

  function payPills(pay, small){
    pay = pay || {};
    const parts = [];
    const add = (k, v)=>{ const n = numFromUi(v); if (n>0) parts.push(`<span class="pill mono">${k}: <b>${fmtMoney(n)}</b></span>`); };
    add("Click", pay.click);
    add("Payme", pay.payme);
    add("8037", pay.card8037);
    add("Cash", pay.cash);
    add("Term", pay.uzterm);
    if (parts.length===0) return `<span class="muted">${small ? "Оплата: 0" : "Нет оплат"}</span>`;
    return parts.join(" ");
  }

  /* === UPDATED LIST RENDER (desktop + mobile like your screenshot) === */
  function renderList(rows){
    const dl = document.getElementById("desktopList");
    const ml = document.getElementById("mobileList");
    dl.innerHTML = "";
    ml.innerHTML = "";

    if (!rows || rows.length===0){
      const emptyD = document.createElement("div");
      emptyD.className = "dRow";
      emptyD.innerHTML = `<div class="dCell" style="grid-column:1/-1"><span class="muted">Нет данных по фильтрам.</span></div>`;
      dl.appendChild(emptyD);

      const emptyM = document.createElement("div");
      emptyM.className = "mItem";
      emptyM.innerHTML = `<span class="muted">Нет данных по фильтрам.</span>`;
      ml.appendChild(emptyM);
      return;
    }

    for (const r of rows){
      const foiz = numFromUi(r.foiz);
      const certPct = numFromUi(r.cert?.pct || 0);
      const skidkaTotal = Math.round((foiz + certPct)*100)/100;

      // DESKTOP ROW (card-style grid)
      const d = document.createElement("div");
      d.className = "dRow";
      d.innerHTML = `
        <div class="dCell dDate">
          <div class="mono"><b>${escapeHtml(onlyDate(r.sana||""))}</b></div>
          <div class="dSub">kiritilgan: <span class="mono">${(r.kiritilgan||"").replace("T"," ").slice(0,16)}</span></div>
        </div>

        <div class="dCell">
          <div class="dTitle">${escapeHtml(r.service||"")}</div>
          <div class="dSub">
            Master: <b class="mono" style="color:var(--text)">${escapeHtml(r.master||"")}</b>
            • Narx: <b class="mono" style="color:var(--text)">${fmtMoney(r.narx)}</b>
          </div>
          <div class="dSub">
            Skidka: <b class="mono" style="color:var(--text)">${foiz}</b> + <b class="mono" style="color:var(--text)">${certPct}</b> = <b class="mono" style="color:var(--text)">${skidkaTotal}%</b>
            • Sert: <b class="mono" style="color:var(--text)">${fmtMoney((r.cert?.sum||0))}</b>
          </div>
        </div>

        <div class="dCell right">
          <div class="dMoney mono">${fmtMoney(r.summa)}</div>
        </div>

        <div class="dCell">
          <div class="dPay">${payPills(r.pay)}</div>
        </div>

        <div class="dCell">
          <div class="clamp2 muted">${r.izoh ? escapeHtml(r.izoh) : ""}</div>
        </div>
      `;
      dl.appendChild(d);

      // MOBILE CARD
      const item = document.createElement("div");
      item.className="mItem";
      item.innerHTML = `
        <div class="mTop">
          <div style="min-width:0">
            <div class="mTitle">${escapeHtml(r.service||"")}</div>
            <div class="mSub">
              Master: <b class="mono" style="color:var(--text)">${escapeHtml(r.master||"")}</b>
              • Sana: <b class="mono" style="color:var(--text)">${escapeHtml(onlyDate(r.sana||""))}</b>
            </div>
            <div class="mSub">
              Summa: <b class="mono" style="color:var(--text)">${fmtMoney(r.summa)}</b>
              • Narx: <b class="mono" style="color:var(--text)">${fmtMoney(r.narx)}</b>
            </div>
            <div class="mSub">
              Skidka: <b class="mono" style="color:var(--text)">${foiz}</b> + <b class="mono" style="color:var(--text)">${certPct}</b> = <b class="mono" style="color:var(--text)">${skidkaTotal}%</b>
            </div>
          </div>
        </div>
        <div class="mPay">${payPills(r.pay,true)}</div>
        ${r.izoh ? `<div class="mSub" style="margin-top:10px;word-break:break-word">${escapeHtml(r.izoh)}</div>` : ``}
      `;
      ml.appendChild(item);
    }
  }

  async function boot(){
    STATE.token = localStorage.getItem(STORAGE_KEY) || "";
    if (!STATE.token){ window.location.replace("/lotuslogin.html"); return; }

    const chk = await jsonp("check", { token: STATE.token }).catch(()=>null);
    if (!chk || !chk.ok){
      localStorage.removeItem(STORAGE_KEY);
      window.location.replace("/lotuslogin.html");
      return;
    }
    STATE.user = chk.user;
    setUserLine(`${STATE.user.name || STATE.user.login} • сессия до конца дня`);

    document.getElementById("fDate").value = todayTashkentYMD();
    ["fService","fMaster","fDate"].forEach(id=>document.getElementById(id).addEventListener("change", refreshList));

    await loadMeta();
    await refreshList();
  }

  async function loadMeta(){
    disableTop(true); setListLoading(true);
    const r = await jsonp("meta", { token: STATE.token }).catch(()=>null);
    if (!r || !r.ok){ alert("Не удалось загрузить справочники (Info)."); disableTop(false); setListLoading(false); return; }

    STATE.services = r.services || [];
    STATE.masters = r.masters || [];
    STATE.priceByService = r.priceByService || {};

    fillSelect(document.getElementById("fService"), STATE.services, "Все услуги");
    fillSelect(document.getElementById("fMaster"), STATE.masters.map(x=>x), "Все мастера");
    fillSelect(document.getElementById("mService"), STATE.services, null);
    fillSelect(document.getElementById("mMaster"), STATE.masters.map(x=>x), null);

    disableTop(false); setListLoading(false);
  }

  async function refreshList(){
    if (STATE.loading) return;
    STATE.loading = true;
    disableTop(true); setListLoading(true);

    const f = getFilters();
    const r = await jsonp("list", { token: STATE.token, service: f.service, master: f.master, date: f.date }).catch(()=>null);
    if (r && r.ok) { STATE.rows = r.rows || []; renderList(STATE.rows); }
    else alert("Не удалось загрузить список.");

    setListLoading(false); disableTop(false); STATE.loading = false;
  }

  function logout(){
    const token = STATE.token;
    localStorage.removeItem(STORAGE_KEY);
    jsonp("logout", { token }).catch(()=>{});
    window.location.replace("/lotuslogin.html");
  }

  // MODAL
  function overlayClose(e){ if (e.target && e.target.id==="overlay") closeModal(); }
  function openModal(){
    if (STATE.loading) return;
    document.getElementById("overlay").classList.add("show");
    document.getElementById("formError").textContent="";

    STATE.sumManual = false;

    document.getElementById("mIzoh").value="";
    document.getElementById("mFoiz").value="0";
    document.getElementById("mCertVal").value="0";

    document.getElementById("mSana").value = todayTashkentYMD();

    if (STATE.services.length) document.getElementById("mService").value=STATE.services[0].code;
    if (STATE.masters.length)  document.getElementById("mMaster").value=STATE.masters[0];

    hookModalEvents_();

    document.getElementById("mSumma").value="";
    ["pClick","pPayme","pCard","pCash","pUz"].forEach(id=>document.getElementById(id).value="");

    recomputeModal(true);
    recomputePayTotal();
  }
  function closeModal(){
    if (STATE.modalBusy) return;
    document.getElementById("overlay").classList.remove("show");
  }

  let MODAL_HOOKED=false;
  function hookModalEvents_(){
    if (MODAL_HOOKED) return;
    MODAL_HOOKED=true;

    document.getElementById("mService").addEventListener("change",()=>{
      STATE.sumManual=false;
      recomputeModal(true);
    });

    document.getElementById("mFoiz").addEventListener("input",()=>recomputeModal(false));
    document.getElementById("mCertVal").addEventListener("input",()=>recomputeModal(false));
    document.querySelectorAll('input[name="certMode"]').forEach(r=>r.addEventListener("change",()=>recomputeModal(false)));

    document.getElementById("mSumma").addEventListener("input",()=>{
      const v = document.getElementById("mSumma").value.trim();
      STATE.sumManual = v !== "";
      recomputePayTotal();
    });

    ["pClick","pPayme","pCard","pUz"].forEach(id=>document.getElementById(id).addEventListener("input",recomputePayTotal));
    const cash=document.getElementById("pCash");
    cash.addEventListener("input",()=>{ cash.value=fmtCashSpaces(cash.value); recomputePayTotal(); });
  }

  function recomputeModal(forceAuto){
    const service=document.getElementById("mService").value||"";
    const narx=Number(STATE.priceByService[service]||0);
    document.getElementById("mNarx").value=fmtMoney(narx);

    const foiz=numFromUi(document.getElementById("mFoiz").value);
    const certMode=document.querySelector('input[name="certMode"]:checked')?.value||"sum";
    const certVal=numFromUi(document.getElementById("mCertVal").value);

    const skidkaAmt=narx*(foiz/100);
    let certSum=0;
    if (certVal>0) certSum=(certMode==="pct")?(narx*(certVal/100)):certVal;

    let auto=narx-skidkaAmt-certSum;
    auto=Math.round(auto*100)/100;
    STATE.autoSum=auto;

    const sumEl=document.getElementById("mSumma");
    if (forceAuto || !STATE.sumManual){
      sumEl.value = fmtMoney(auto);
      STATE.sumManual = false;
    }

    document.getElementById("autoHint").innerHTML =
      `Auto: <b class="mono" style="color:var(--text)">${fmtMoney(auto)}</b>`;

    recomputePayTotal();
  }

  function diffText(sum, total){
    const diff = Math.round((sum - total)*100)/100;
    if (Math.abs(diff) <= 0.01) return { ok:true, text:"OK" };
    if (diff > 0) return { ok:false, text:`${fmtMoney(diff)} sumga kam` };
    return { ok:false, text:`${fmtMoney(-diff)} sumga ko'p` };
  }

  function recomputePayTotal(){
    const sum=numFromUi(document.getElementById("mSumma").value);
    const click=numFromUi(document.getElementById("pClick").value);
    const payme=numFromUi(document.getElementById("pPayme").value);
    const card=numFromUi(document.getElementById("pCard").value);
    const cash=numFromUi(String(document.getElementById("pCash").value).replace(/\s+/g,""));
    const uz=numFromUi(document.getElementById("pUz").value);

    const total=Math.round((click+payme+card+cash+uz)*100)/100;
    document.getElementById("payTotal").textContent=fmtMoney(total);

    const line=document.getElementById("payCheckLine");
    const d = diffText(sum, total);
    line.textContent = d.text;
    line.style.color = d.ok ? "var(--accent)" : "var(--warn)";
  }

  function formErr(s){ document.getElementById("formError").textContent=s||""; }

  function setModalBusy(b, text){
    STATE.modalBusy=b;
    const ok=document.getElementById("btnOk");
    const cancel=document.getElementById("btnCancel");
    ok.disabled=b; cancel.disabled=b;

    const ids=["mSana","mService","mMaster","mFoiz","mCertVal","mSumma","mIzoh","pClick","pPayme","pCard","pCash","pUz"];
    ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.disabled=b; });
    document.querySelectorAll('input[name="certMode"]').forEach(r=>r.disabled=b);

    ok.innerHTML=b?`<span class="spin"></span>${text||"Отправка..."}`:"OK";
  }

  async function submitCreate(){
    if (STATE.modalBusy) return;
    formErr("");

    const sana=document.getElementById("mSana").value.trim();

    const service=document.getElementById("mService").value.trim();
    const master=document.getElementById("mMaster").value.trim();
    const foiz=numFromUi(document.getElementById("mFoiz").value);
    const certMode=document.querySelector('input[name="certMode"]:checked')?.value||"sum";
    const certVal=numFromUi(document.getElementById("mCertVal").value);
    const summa=numFromUi(document.getElementById("mSumma").value);
    const izoh=document.getElementById("mIzoh").value.trim();

    const payClick=numFromUi(document.getElementById("pClick").value);
    const payPayme=numFromUi(document.getElementById("pPayme").value);
    const payCard8037=numFromUi(document.getElementById("pCard").value);
    const payCash=numFromUi(String(document.getElementById("pCash").value).replace(/\s+/g,""));
    const payUzterm=numFromUi(document.getElementById("pUz").value);

    if (!sana) return formErr("Поле Sana обязательно.");
    if (!service) return formErr("Выбери Xizmat.");
    if (!master)  return formErr("Выбери Master.");
    if (foiz<0 || foiz>100) return formErr("Skidka% должна быть 0–100.");

    const payTotal=Math.round((payClick+payPayme+payCard8037+payCash+payUzterm)*100)/100;
    const d = diffText(summa, payTotal);
    if (!d.ok) return formErr(d.text);

    setModalBusy(true,"Отправка...");
    disableTop(true);

    const f = getFilters();
    const r = await jsonp("create", {
      token: STATE.token,
      sana, service, master, foiz, certMode, certVal, summa, izoh,
      payClick, payPayme, payCard8037, payCash, payUzterm,
      f_service: f.service,
      f_master:  f.master,
      f_date:    f.date
    }).catch(()=>null);

    if (!r || !r.ok){
      if (r && r.error==="PAY_SUM_MISMATCH"){
        const dd = diffText(numFromUi(r.summa||summa), numFromUi(r.payTotal||payTotal));
        formErr(dd.ok ? "OK" : dd.text);
      } else {
        formErr("Ошибка сохранения.");
      }
      setModalBusy(false); disableTop(false);
      return;
    }

    STATE.rows=r.rows||[];
    renderList(STATE.rows);

    setModalBusy(false);
    disableTop(false);
    closeModal();
  }

  boot();
</script>
</body>
</html>

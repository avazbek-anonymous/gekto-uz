<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>G-SOFT | Login</title>
  <style>
    :root{
      --bg1:#061a14;
      --bg2:#0b2b23;
      --card:rgba(255,255,255,.07);
      --line:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --brand:#ffd15c;
      --ok:#10b981;
      --bad:#f16262;
      --r:18px;
      --shadow:0 18px 55px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 20% 20%, rgba(255,209,92,.14), transparent 60%),
        radial-gradient(900px 520px at 80% 40%, rgba(16,185,129,.14), transparent 55%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      display:grid;place-items:center;
      padding:16px;
    }
    .card{
      width:min(420px,100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
      padding:18px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;margin-bottom:12px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      display:grid;place-items:center;
      background:rgba(255,209,92,.18);
      border:1px solid rgba(255,209,92,.30);
      color:var(--brand);
      font-weight:1000;
    }
    .title{font-weight:1000;font-size:18px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}

    .field{margin-top:12px}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    input:focus{border-color:rgba(255,209,92,.45)}
    .row{display:flex;gap:10px;align-items:center;margin-top:14px}
    button{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,209,92,.35);
      background:rgba(255,209,92,.92);
      color:#062018;
      font-weight:1000;
      cursor:pointer;
    }
    button:disabled{opacity:.7;cursor:not-allowed}
    .msg{margin-top:12px;color:var(--muted);font-size:13px;min-height:18px}
    .msg.ok{color:rgba(16,185,129,.95)}
    .msg.bad{color:rgba(241,98,98,.95)}
    .spinner{
      width:16px;height:16px;border-radius:50%;
      border:2px solid rgba(255,255,255,.18);
      border-top-color:rgba(0,0,0,.55);
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="card">
    <div class="brand">
      <div class="logo">G</div>
      <div>
        <div class="title">G-SOFT | Managment</div>
        <div class="sub">Login (token 3 min)</div>
      </div>
    </div>

    <div class="field">
      <label>Login</label>
      <input id="login" autocomplete="username" />
    </div>

    <div class="field">
      <label>Parol</label>
      <input id="parol" type="password" autocomplete="current-password" />
    </div>

    <div class="row">
      <button id="btn">Kirish</button>
      <div id="sp" style="display:none" class="spinner"></div>
    </div>

    <div id="msg" class="msg"></div>
  </div>

<script>
  // === CONFIG ===
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbyGW5vwkyYWmsbSP2_wHFMBoSjJcYLGz7r0gR-R-e5al-efv1hchZIYKCxc5HxG0gvR/exec";
  const API_SECRET = "Gekto2022@";
  const OFFICE_URL = "./office.html";

  // === JSONP ===
  function jsonp(params){
    return new Promise((resolve,reject)=>{
      const cb = "__cb_" + Math.random().toString(36).slice(2);
      params.callback = cb;

      const u = new URL(ENDPOINT);
      Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));

      const s = document.createElement("script");
      window[cb] = (data)=>{
        cleanup();
        resolve(data);
      };
      function cleanup(){
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        s.remove();
      }
      s.onerror = ()=>{ cleanup(); reject(new Error("JSONP_ERROR")); };
      s.src = u.toString();
      document.body.appendChild(s);
    });
  }

  function setMsg(text, type=""){
    const el = document.getElementById("msg");
    el.className = "msg " + type;
    el.textContent = text || "";
  }

  function setLoading(on){
    document.getElementById("btn").disabled = on;
    document.getElementById("sp").style.display = on ? "block" : "none";
  }

  document.getElementById("btn").addEventListener("click", login);
  document.getElementById("parol").addEventListener("keydown", (e)=>{ if(e.key==="Enter") login(); });

  async function login(){
    setMsg("");
    const login = document.getElementById("login").value.trim();
    const parol = document.getElementById("parol").value.trim();
    if(!login || !parol){ setMsg("Login va parol kiriting", "bad"); return; }

    setLoading(true);
    try{
      const res = await jsonp({
        action:"login",
        api_secret: API_SECRET,
        login,
        parol
      });

      if(!res || !res.ok){
        setMsg(res?.error || "Xatolik", "bad");
        return;
      }

      const exp = Date.now() + (res.ttlSec || 180) * 1000;
      localStorage.setItem("gsoft_token", res.token);
      localStorage.setItem("gsoft_user", JSON.stringify(res.user || {}));
      localStorage.setItem("gsoft_exp", String(exp));

      location.href = OFFICE_URL + "#/users";
    }catch(e){
      setMsg("Server bilan aloqa yoâ€˜q", "bad");
    }finally{
      setLoading(false);
    }
  }
</script>
</body>
</html>

<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagnostika biznesa - Gekto</title>
  <meta name="theme-color" content="#003a2f">
  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/ionicons.min.css">
  <link rel="stylesheet" href="assets/css/flexslider.css">
  <link rel="stylesheet" href="assets/css/animsition.min.css">
  <link rel="stylesheet" href="assets/css/animate.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.8.1/dist/nouislider.min.css">
  <style>
    .analysis-wrap {
      padding: 40px 0 70px;
      background: linear-gradient(180deg, #f5f9f7 0%, #ffffff 35%)
    }

    .analysis-shell {
      max-width: 980px;
      margin: 0 auto
    }

    .analysis-card {
      background: #fff;
      border: 1px solid #e4eee9;
      border-radius: 14px;
      padding: 24px;
      box-shadow: 0 10px 28px rgba(0, 58, 47, .07);
      margin-bottom: 18px
    }

    .analysis-head {
      margin-bottom: 16px
    }

    .analysis-head h2 {
      margin: 0;
      color: #003a2f;
      font-size: 30px;
      line-height: 1.2
    }

    .analysis-sub {
      color: #4b5a56;
      font-size: 14px;
      margin-top: 8px
    }

    .analysis-hidden {
      display: none
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px
    }

    .field label {
      display: block;
      font-size: 12px;
      color: #5f6d68;
      margin-bottom: 6px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .3px
    }

    .field input,
    .field select {
      width: 100%;
      border: 1px solid #cfe0da;
      border-radius: 10px;
      padding: 12px 12px;
      font-size: 15px;
      background: #fff;
      color: #1f2b28
    }

    .field input:focus,
    .field select:focus {
      outline: none;
      border-color: #0e8067;
      box-shadow: 0 0 0 3px rgba(14, 128, 103, .15)
    }

    .actions {
      margin-top: 16px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap
    }

    .mode-card {
      border: 1px solid #d9e9e3;
      border-radius: 12px;
      padding: 15px;
      cursor: pointer;
      transition: .2s;
      background: #fff
    }

    .mode-card.active {
      border-color: #0e8067;
      box-shadow: 0 0 0 3px rgba(14, 128, 103, .15)
    }

    .mode-title {
      font-size: 18px;
      font-weight: 700;
      color: #003a2f
    }

    .mode-meta {
      font-size: 13px;
      color: #4b5a56;
      margin-top: 6px
    }

    .progress-wrap {
      height: 10px;
      background: #edf2f0;
      border-radius: 999px;
      overflow: hidden;
      margin: 10px 0 18px
    }

    .progress-bar {
      height: 10px;
      background: #003a2f;
      width: 0;
      transition: width .2s ease
    }

    .question {
      font-size: 23px;
      line-height: 1.45;
      color: #1f2b28;
      margin-bottom: 14px
    }

    .block-tag {
      display: inline-block;
      background: #eaf5f1;
      color: #0f6c58;
      font-size: 11px;
      padding: 5px 8px;
      border-radius: 999px;
      margin-bottom: 10px;
      text-transform: uppercase;
      font-weight: 700
    }

    .scale {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      color: #5f6d68;
      margin-top: 8px
    }

    .calc-top {
      border-radius: 14px;
      padding: 22px 14px;
      text-align: center;
      color: #fff
    }

    .calc-caption {
      font-size: 13px;
      opacity: .8
    }

    .calc-level {
      font-size: 16px;
      font-weight: 700;
      margin-top: 8px
    }

    .calc-value {
      font-size: 46px;
      line-height: 1.1;
      font-weight: 800;
      margin-top: 4px
    }

    .calc-slider-wrap {
      padding: 0 18px;
      margin-top: -8px
    }

    .c-50 {
      background-image: linear-gradient(-37deg, #A67F66 0%, #C49A7F 19%, #A2795E 40%, #A47C62 66%, #EBC5A4 100%)
    }

    .c-150 {
      background-image: linear-gradient(-50deg, #9FA6AC 0%, #868C94 40%, #C4CBD1 79%, #B3BBC0 100%)
    }

    .c-250 {
      background-image: linear-gradient(-25deg, #EFDA86 0%, #C69637 40%, #FEF2AE 79%, #D3CC72 100%)
    }

    .c-350 {
      background-image: linear-gradient(-50deg, #70BEFF 0%, #6999DA 40%, #BAE2FF 79%, #D3E9F8 100%)
    }

    .c-500 {
      background-image: linear-gradient(-50deg, #70ffa7 0%, #69daa5 40%, #baffc0 79%, #d3f8d5 100%)
    }

    .noUi-target {
      background: #9AAAC1;
      border: none;
      box-shadow: none
    }

    .noUi-connect {
      background: #0E84FF
    }

    .noUi-horizontal {
      height: 14px;
      border-radius: 10px
    }

    .noUi-horizontal .noUi-handle {
      width: 32px;
      height: 32px;
      top: -10px;
      right: -26px;
      border: none;
      border-radius: 50%;
      background: #0E84FF;
      box-shadow: 0 11px 19px 0 rgba(12, 71, 124, .48)
    }

    .noUi-handle:before {
      content: '';
      display: block;
      position: absolute;
      left: 50%;
      top: 50%;
      width: 20px;
      height: 20px;
      background: #d8e4f5;
      border-radius: 50%;
      transform: translate(-50%, -50%)
    }

    .noUi-handle:after {
      display: none
    }

    .noUi-horizontal .noUi-tooltip {
      display: none;
      font-weight: 700;
      font-size: 13px;
      color: #1a273a;
      background: #fff;
      box-shadow: 0 11px 28px 0 rgba(255, 255, 255, .3);
      padding: 5px 11px;
      border: none;
      border-radius: 20px;
      text-transform: uppercase
    }

    .kpi {
      border: 1px solid #e4eee9;
      border-radius: 12px;
      padding: 16px;
      background: #fff;
      height: 100%
    }

    .score {
      font-size: 42px;
      font-weight: 800;
      color: #003a2f;
      line-height: 1
    }

    .level {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .4px;
      color: #4c5a56;
      margin-top: 8px
    }

    .chart-box {
      border: 1px solid #e4eee9;
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px
    }

    .chart-title {
      font-size: 12px;
      text-transform: uppercase;
      color: #4c5a56;
      font-weight: 700;
      margin-bottom: 8px
    }

    .list-clean {
      padding-left: 18px;
      margin: 0
    }

    .list-clean li {
      margin-bottom: 8px
    }

    .row-item {
      border-bottom: 1px solid #edf2f0;
      padding: 9px 0
    }

    .row-item:last-child {
      border-bottom: none
    }

    .err {
      font-size: 12px;
      color: #b94040;
      margin-top: 8px;
      display: none
    }

    .note {
      font-size: 12px;
      color: #5f6d68;
      margin-top: 10px
    }

    @media (max-width:900px) {
      .analysis-head h2 {
        font-size: 24px
      }

      .question {
        font-size: 20px
      }
    }

    @media (max-width:768px) {
      .analysis-wrap {
        padding: 20px 0 50px
      }

      .analysis-card {
        padding: 16px;
        border-radius: 12px
      }

      .grid {
        grid-template-columns: 1fr
      }

      .scale {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 5px
      }

      .score {
        font-size: 34px
      }

      .calc-value {
        font-size: 34px
      }

      .calc-slider-wrap {
        padding: 0 6px
      }
    }
  </style>
</head>

<body class="animsition">
  <header class="main-header">
    <div class="container">
      <div class="logo"><a href="index.html"><img src="assets/img/logo.png" alt="logo"></a></div>
      <div class="menu">
        <nav class="desktop-nav">
          <ul class="first-level">
            <li><a href="index.html" class="animsition-link">Asosiy</a></li>
            <li><a href="about.html" class="animsition-link">Biz haqimizda</a></li>
            <li><a href="services.html" class="animsition-link">Xizmatlarimiz</a></li>
            <li><a href="contact.html" class="animsition-link">Kontaktlarimiz</a></li>
          </ul>
        </nav>
        <nav class="mobile-nav"></nav>
        <div class="menu-icon">
          <div class="line"></div>
          <div class="line"></div>
          <div class="line"></div>
        </div>
      </div>
    </div>
  </header>

  <section class="analysis-wrap">
    <div class="container">
      <div class="analysis-shell">

        <div id="screen-intro" class="analysis-card">
          <div class="analysis-head">
            <h2>Biznes Diagnostika Testi</h2>
            <div class="analysis-sub">Avval ma'lumotlaringizni kiriting, keyin test turini tanlaysiz.</div>
          </div>
          <div class="grid">
            <div class="field"><label for="fullName">Ismingiz</label><input id="fullName" type="text"
                placeholder="Ism familiya"></div>
            <div class="field"><label for="phone">Raqamingiz</label><input id="phone" type="tel"
                placeholder="+998 XX XXX XX XX"></div>
            <div class="field"><label for="businessName">Biznesingiz nomi</label><input id="businessName" type="text"
                placeholder="Kompaniya nomi"></div>
            <div class="field"><label for="sector">Sohani tanlang</label><select id="sector"></select></div>
          </div>
          <div id="introErr" class="err">Iltimos, barcha maydonlarni to'ldiring.</div>
          <div class="actions"><button id="goMode" class="btn green"><span>Testni boshlash</span></button></div>
        </div>

        <div id="screen-mode" class="analysis-card analysis-hidden">
          <div class="analysis-head">
            <h2>Test turi</h2>
            <div class="analysis-sub">Variantni tanlang. Natijada foiz, zaif nuqtalar, tavsiyalar va hisobotlar chiqadi.
            </div>
          </div>
          <div class="grid">
            <label class="mode-card active" id="modeNormalCard"><input type="radio" name="mode" value="normal" checked
                style="display:none">
              <div class="mode-title">Oddiy test</div>
              <div class="mode-meta">20 ta moliyaviy savol. Tez diagnostika.</div>
            </label>
            <label class="mode-card" id="modeDeepCard"><input type="radio" name="mode" value="deep"
                style="display:none">
              <div class="mode-title">Chuqur tahlil</div>
              <div class="mode-meta">40 ta moliyaviy savol. Chuqur auditga yaqin natija.</div>
            </label>
          </div>
          <div class="actions"><button id="backIntro" class="btn"><span>Orqaga</span></button><button id="startTest"
              class="btn green"><span>Boshlash</span></button></div>
        </div>

        <div id="screen-quiz" class="analysis-card analysis-hidden">
          <div class="analysis-head">
            <h2 id="quizTitle">Savol 1 / 40</h2>
          </div>
          <div class="progress-wrap">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          <div class="block-tag" id="blockTag">Moliyaviy</div>
          <div class="question" id="questionText"></div>
          <div id="sliderTheme" class="calc-top c-250">
            <div class="calc-caption">Baholash darajasi</div>
            <div id="levelValue" class="calc-value">3</div>
            <div id="levelText" class="calc-level">Qisman mos</div>
          </div>
          <div class="calc-slider-wrap">
            <div id="answerSlider"></div>
          </div>
          <div class="actions"><button id="quizBack" class="btn"><span>Orqaga</span></button><button id="quizNext"
              class="btn green"><span>Keyingi</span></button></div>
        </div>

        <div id="screen-result" class="analysis-hidden">
          <div class="analysis-card">
            <div class="analysis-head">
              <h2>Natijalar</h2>
              <div class="analysis-sub">Sizning biznes diagnostika hisobotingiz</div>
            </div>
            <div class="score" id="overallScore">0%</div>
            <div class="level" id="overallLevel">-</div>
            <p id="overallLine" style="margin-top:8px"></p>
          </div>
          <!--div class="row">
            <div class="col-md-12 col-sm-12">
              <div class="kpi">
                <div class="chart-title">Moliyaviy natija</div>
                <div class="score" id="financeScore">0%</div>
                <div class="level" id="financeLevel">-</div>
                <p id="financeLine"></p>
              </div>
            </div>
          </div-->
          <div class="analysis-card">
            <div class="chart-box">
              <div class="chart-title">Finance Radar</div><svg id="financeRadar" viewBox="0 0 360 300"
                style="width:100%"></svg>
            </div>
            <div class="chart-box">
              <div class="chart-title">Eng past kategoriyalar</div><svg id="weakBar" viewBox="0 0 420 260"
                style="width:100%"></svg>
            </div>
            <div class="chart-box">
              <div class="chart-title">Muammo turlari</div><svg id="problemDonut" viewBox="0 0 360 260"
                style="width:100%"></svg>
            </div>
          </div>
          <div class="analysis-card">
            <div class="chart-title">Bosh xulosa</div>
            <p id="mainConclusion"></p>
            <div class="chart-title" style="margin-top:14px">Tavsiyalar</div>
            <ul id="insights" class="list-clean"></ul>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="analysis-card">
                <div class="chart-title">Top-5 zaif savollar</div>
                <div id="weakQuestions"></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="analysis-card">
                <div class="chart-title">Top-5 kuchli savollar</div>
                <div id="strongQuestions"></div>
              </div>
            </div>
          </div>
          <div class="analysis-card">
            <div class="chart-title">7 kunlik tezkor reja</div>
            <ul id="quickPlan" class="list-clean"></ul>
            <div class="chart-title" style="margin-top:14px">Sizga kerak bo'ladigan hisobotlar</div>
            <ul id="neededReports" class="list-clean"></ul>
            <div class="note" style="font-size:14px;color:#1f2b28;margin-top:12px">Agar ushbu masalalarni hal qilish,
              amaliy tavsiya olish yoki biznesingizni tizimlashtirishni xohlasangiz, biz bilan bog'laning</div>
            <div class="actions">
              <button id="pdfAndSend" class="btn green"><span>PDF yuklab olish</span>
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <footer class="main-footer wow fadeInUp">
    <div class="container">
      <div class="col-md-8 col-sm-12">
        <div class="row">
          <nav class="footer-nav">
            <p style="font-weight:bold;">"Murakkab moliyani sodda tilda tushuntiramiz"</p>
            <p style="text-align:center;font-weight:bold;">Fazliddin Davronov</p>
            <ul>
              <li><a href="index.html" class="animsition-link link">Asosiy</a></li>
              <li><a href="about.html" class="animsition-link link">Biz haqimizda</a></li>
              <li><a href="services.html" class="animsition-link link">Xizmatlarimiz</a></li>
              <li><a href="contact.html" class="animsition-link link">Kontaktlarimiz</a></li>
            </ul>
          </nav>
        </div>
      </div>
      <div class="col-md-4 col-sm-12" style="text-align:right">
        <div class="row">
          <div class="gray-text">Gekto &copy;2022. Huquqlar himoyalangan.</div>
        </div>
      </div>
    </div>
  </footer>

  <script src="assets/js/jquery-2.1.4.min.js"></script>
  <script src="assets/js/isotope.pkgd.min.js"></script>
  <script src="assets/js/jquery.flexslider.js"></script>
  <script src="assets/js/smoothScroll.js"></script>
  <script src="assets/js/jquery.animsition.min.js"></script>
  <script src="assets/js/wow.min.js"></script>
  <script src="assets/js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.8.1/dist/nouislider.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    const CONTACTS = {
      tel1: '998930050180',
      tel2: '998770086000',
      telegram: '@gekto_consulting',
      mail: 'info@gekto.uz',
      address: 'Chilonzor, Muqumiy k. 41/3'
    };
    const ENDPOINT =
      "https://api.ofis.gekto.uz/api/analysis/lead";
    const SECRET = "mySecret123";
    const SECTORS = ['Agrobiznes', 'Arxitektura va dizayn', 'Avtoservis', 'Bank va moliya', 'Boshqa', 'Chakana savdo',
      'Dorixona', 'E-commerce', 'Eksport-import', 'Franshiza', 'Gozallik va salomatlik', 'HoReCa (kafe/restoran)',
      'IT va raqamli xizmatlar', 'Ishlab chiqarish', 'Konsalting', 'Logistika', 'Marketing agentligi', 'Qurilish',
      'Sanoat xizmatlari', 'Ta' + 'lim', 'Tekstil', 'Telekommunikatsiya', 'Turizm', 'Ulgurji savdo', 'Xizmat ko' +
      'rsatish', 'Yuridik xizmatlar'
    ];
    const FIN_CATS = ['cashflow', 'profitability', 'forecasting', 'working_capital', 'inventory', 'pricing',
      'tax_legal'];
    const LABELS = {
      cashflow: 'CashFlow',
      profitability: 'Marja/Foyda',
      forecasting: 'Prognoz',
      working_capital: 'Qarz/Aylanma',
      inventory: 'Ombor',
      pricing: 'Narx',
      tax_legal: 'Soliq/Hujjat'
    };
    const NORMAL_FINANCE = ["Men biznesim oldida turgan barcha moliyaviy muammolarni muvaffaqiyatli hal qilaman.",
      "Men keyingi oyda / 3 oy / 6 oy / 12 oyda qancha sof foyda olishimni bilaman",
      "Men bu yil biznes foydasini kamida 50% ga qanday oshirishni aniq bilaman.",
      "So'nggi 12 oy ichida men biznes daromadlarining barqaror o'sishini ko'rdim.",
      "Mening biznesimdagi foyda menga zaxiralarni yaratishga imkon beradi",
      "Ba'zida pulim yo'qligi sababli marketing xarajatlarini kamaytirganim ham bo'ladi.",
      "Men doimiy ravishda o'z biznesimdagi xarajatlarni kamaytirish va optimallashtirish ustida ishlayapman.",
      "Ba'zida mavsumdan tashqari mening biznesimdagi daromadim sezilarli darajada kamayishi ham bo'lib turadi",
      "Barcha pulim oborotda va men uni qanday chiqarib olishni bilmayapman",
      "Mening biznesim o'sib bormoqda, ammo pulda o'zgarish yo'q.",
      "Men vaqti-vaqti bilan biznesdagi resurslarimning ABC tahlilini o'tkazaman.",
      "Mening biznesimning kreditlari va qarzlari meni bezovta qilmoqda",
      "Pul yetishmovchiligiga ko'p uchrayman, deyarli oddiy holday ko'rinadigan bo'lgan",
      "Pullarimni ombordagi tovarlar va asosiy vositalarga ko'p tikaman. Ularda muzlatib yuraman",
      "Men har doim ish haqini o'z vaqtida va kechiktirmasdan to'layman.",
      "Men har doim soliqlarni o'z vaqtida va kechiktirmasdan to'layman.",
      "Men pulni oqilona boshqaraman va barcha biznes xarajatlarini oldindan rejalashtiraman.",
      "Men biznes xarajatlarim nima ekanligini va har bir mahsulot qancha foyda keltirishini aniq bilaman.",
      "Biznesimda ishchilarga motivatsiya sistemasini shakllantirganman",
      "Men savdo, marketing va moliyaviy model orqali biznesdagi foydaga qanday ta'sir qilishni aniq bilaman"
    ];
    const DEEP_FINANCE_BASE = [
      "Men har oy P&L (Daromad-Xarajat-Foyda) hisobotini tuzaman va qarorlarni shunga tayangan holda qilaman.",
      "Men har oy Balansni ko'raman: aktivlar, majburiyatlar va kapital o'zgarishini tushunaman.",
      "Men CashFlow rejani (kirim/chiqim prognoz) kamida 4 hafta oldinga tuzaman.",
      "Men Plan-Fakt tahlilini muntazam qilaman va chetga chiqish sabablarini yozib boraman.",
      "Men har bir mahsulot/xizmat bo'yicha sof marjani (to'liq xarajatlar bilan) aniq bilaman.",
      "Men unit-economicsni bilaman: 1 ta sotuvdan tushadigan foyda, o'zini oqlash nuqtasi.",
      "Men chegirmalar (skidka) foydaga qanday ta'sir qilishini hisoblayman va cheklov qo'yganman.",
      "Men ko'p sotdik, lekin foyda yo'q holatining sababini tez topa olaman (narx, marja, xarajat, qaytarim).",
      "Men debitor qarz bo'yicha limit, muddat, eslatma va undirish tartibini joriy qilganman.",
      "Men kreditor qarz bo'yicha to'lov ustuvorligi (prioritet) va kalendarini yuritaman.",
      "Men cash gap (naqdlik uzilishi) bo'lishidan oldin signal beradigan ko'rsatkichlarga egaman.",
      "Men ombordagi tovarlar bo'yicha ABC/XYZni muntazam qilaman va muzlagan pulni kamaytiraman.",
      "Men zaxiralar (stock) uchun min/max darajalarni belgilaganman.",
      "Men xarajatlarni kategoriyalarga ajratganman va keraksiz xarajatlar uchun limitlar bor.",
      "Men marketing bo'yicha ROIni kuzataman: qaysi kanal foyda beradi, qaysi biri yo'q.",
      "Men soliq va hujjatlar bo'yicha risklarni bilaman va oldindan rejalashtiraman.",
      "Men biznesdan pul yechish (dividend/egaga to'lov) bo'yicha aniq qoida ishlab chiqqanman.",
      "Men asosiy vositalarga investitsiya qilganda qaytish muddatini (payback) hisoblayman.",
      "Men narx siyosatini bozordagi o'zgarishlarga qarab yangilab turaman (kurs, xarid narxi, raqobat).",
      "Men 3-6-12 oyga moliyaviy model qilib, foyda va naqdlik ssenariylarini ko'raman."
    ];
    const DEEP_FINANCE = DEEP_FINANCE_BASE.concat(NORMAL_FINANCE);
    const app = {
      mode: 'normal',
      questions: [],
      current: 0,
      answers: {},
      user: {
        name: '',
        phone: '',
        business: '',
        sector: ''
      },
      result: null,
      rawScore: 3,
      slider: null
    };
    const el = id => document.getElementById(id);
    const SCORE_LABELS = {
      1: 'Umuman mos emas',
      2: 'Kam mos',
      3: 'Qisman mos',
      4: "Ko'p mos",
      5: "To'liq mos"
    };

    function scoreClass(score) {
      if (score <= 1) return 'c-50';
      if (score === 2) return 'c-150';
      if (score === 3) return 'c-250';
      if (score === 4) return 'c-350';
      return 'c-500'
    }

    function nearestScore(raw) {
      return Math.max(1, Math.min(5, Math.round(raw)))
    }

    function updateSliderVisual(raw) {
      const score = nearestScore(raw);
      el('levelValue').textContent = String(score);
      el('levelText').textContent = SCORE_LABELS[score];
      el('sliderTheme').className = 'calc-top ' + scoreClass(score)
    }

    function initAnswerSlider() {
      if (app.slider) return;
      noUiSlider.create(el('answerSlider'), {
        start: [3],
        connect: [true, false],
        step: 0.01,
        range: {
          min: 1,
          max: 5
        },
        tooltips: [{
          to: (v) => SCORE_LABELS[nearestScore(v)].toUpperCase()
        }]
      });
      app.slider = el('answerSlider').noUiSlider;
      app.slider.on('update', (values) => {
        app.rawScore = Number(values[0]);
        updateSliderVisual(app.rawScore)
      });
      app.slider.on('change', (values) => {
        const score = nearestScore(Number(values[0]));
        app.rawScore = score;
        app.slider.set(score);
        saveCurrent()
      });
    }

    function fillSectors() {
      const s = el('sector');
      const sorted = [...SECTORS].sort((a, b) => a.localeCompare(b));
      s.innerHTML = '<option value="">Tanlang...</option>' + sorted.map(x => `<option value="${x}">${x}</option>`).join(
        '');
    }

    function levelByPercent(p) {
      if (p <= 24) return 'Kritk (kritik holat)';
      if (p <= 49) return 'Past (zaif tizim)';
      if (p <= 69) return "O'rtacha (barqaror emas)";
      if (p <= 84) return "Yaxshi (o'sish bor)";
      return "Kuchli (tizim yo'lga qo'yilgan)"
    }

    function catAt(cats, i) {
      return cats[i % cats.length]
    }

    function makeQuestions(list, block, prefix, cats) {
      return list.map((text, i) => ({
        id: prefix + (i + 1),
        text,
        block,
        category: catAt(cats, i),
        weight: 1
      }))
    }

    function interleave(a, b) {
      const out = [];
      const n = Math.max(a.length, b.length);
      for (let i = 0; i < n; i++) {
        if (i < a.length) out.push(a[i]);
        if (i < b.length) out.push(b[i]);
      }
      return out
    }

    function buildQuestions(mode) {
      if (mode === 'normal') return makeQuestions(NORMAL_FINANCE, 'finance', 'fn', FIN_CATS);
      return makeQuestions(DEEP_FINANCE, 'finance', 'fd', FIN_CATS);
    }

    function show(screen) {
      ['screen-intro', 'screen-mode', 'screen-quiz', 'screen-result'].forEach(id => el(id).classList.add(
        'analysis-hidden'));
      el(screen).classList.remove('analysis-hidden')
    }

    function renderModeCards() {
      const m = document.querySelector('input[name="mode"]:checked').value;
      el('modeNormalCard').classList.toggle('active', m === 'normal');
      el('modeDeepCard').classList.toggle('active', m === 'deep')
    }

    function renderQuestion() {
      const q = app.questions[app.current];
      const total = app.questions.length;
      const v = app.answers[q.id] || 3;
      el('quizTitle').textContent = `Savol ${app.current+1} / ${total}`;
      el('progressBar').style.width = ((app.current + 1) / total * 100) + '%';
      el('questionText').textContent = q.text;
      el('blockTag').textContent = 'Moliyaviy';
      initAnswerSlider();
      app.rawScore = v;
      app.slider.set(v);
      updateSliderVisual(v);
      el('quizBack').disabled = app.current === 0;
      el('quizNext').innerHTML = app.current === total - 1 ? '<span>Natijani ko\'rish</span>' : '<span>Keyingi</span>'
    }

    function saveCurrent() {
      const q = app.questions[app.current];
      app.answers[q.id] = nearestScore(app.rawScore)
    }

    function computeBlock(block) {
      const items = app.questions.filter(x => x.block === block);
      let raw = 0,
        min = 0,
        max = 0;
      const cp = {};
      items.forEach(q => {
        const v = app.answers[q.id] || 3;
        raw += v * q.weight;
        min += 1 * q.weight;
        max += 5 * q.weight;
        if (!cp[q.category]) cp[q.category] = {
          raw: 0,
          min: 0,
          max: 0
        };
        cp[q.category].raw += v * q.weight;
        cp[q.category].min += 1 * q.weight;
        cp[q.category].max += 5 * q.weight
      });
      const percent = Math.round(((raw - min) / (max - min)) * 100) || 0;
      const categoryPercent = {};
      Object.keys(cp).forEach(k => categoryPercent[k] = Math.round(((cp[k].raw - cp[k].min) / (cp[k].max - cp[k].min)) *
        100) || 0);
      return {
        percent,
        categoryPercent
      }
    }

    function extremes(desc) {
      const arr = app.questions.map(q => ({
        text: q.text,
        score: app.answers[q.id] || 3,
        category: q.category
      }));
      arr.sort((a, b) => desc ? b.score - a.score : a.score - b.score);
      return arr.slice(0, 5)
    }

    function weakCategories(fin) {
      const arr = [];
      Object.keys(fin.categoryPercent).forEach(k => arr.push({
        category: k,
        value: fin.categoryPercent[k]
      }));
      arr.sort((a, b) => a.value - b.value);
      return arr.slice(0, 5)
    }

    function insightByCategory(c) {
      const map = {
        cashflow: "CashFlow reja + to'lov kalendari sust. Naqdlik uzilishi xavfi bor.",
        profitability: 'Marja va unit-economics nazorati zaif.',
        working_capital: 'Debitor/kreditor boshqaruvi sust.',
        inventory: 'Omborda muzlagan pul yuqori.',
        pricing: 'Narx va chegirma nazorati zaif.',
        tax_legal: 'Soliq-hujjat intizomi bo`yicha risklar bor.',
        forecasting: 'Plan-fakt va prognoz sust.'
      };
      return map[c] || 'Ushbu yo`nalishda tizimni kuchaytirish kerak.'
    }

    function mainConclusion(f, weak) {
      if (f < 50) return "Moliyaviy tizim zaif: cashflow va foyda nazoratini kuchaytirish kerak.";
      if (f >= 70) return "Moliyaviy tizim yaxshi yo'lga qo'yilgan, endi masshtablash bosqichi.";
      return `Asosiy risk zonasi: ${LABELS[weak]||weak}.`
    }

    function renderList(id, items) {
      const n = el(id);
      n.innerHTML = '';
      items.forEach(text => {
        const li = document.createElement('li');
        li.textContent = text;
        n.appendChild(li)
      })
    }

    function renderQA(id, items, isWeak) {
      const n = el(id);
      n.innerHTML = '';
      items.forEach(x => {
        const d = document.createElement('div');
        d.className = 'row-item';
        d.innerHTML =
          `<div>${x.text}</div><div style="font-size:12px;color:#5f6d68;margin-top:4px">Baho: <b>${x.score}/5</b> ${isWeak?'| Risk zona':'| Kuchli zona'}</div>`;
        n.appendChild(d)
      })
    }

    function planByWeak(weak) {
      const out = [];
      weak.forEach(x => {
        if (x.category === 'cashflow') out.push("To'lov kalendarini 4 haftaga joriy qiling.");
        if (x.category === 'profitability') out.push('Har mahsulot bo`yicha marja jadvalini yarating.');
        if (x.category === 'working_capital') out.push('Debitor bo`yicha limit va eslatma tartibini kiriting.');
        if (x.category === 'inventory') out.push('ABC/XYZ tahlili orqali muzlagan pulni kamaytiring.');
      });
      return [...new Set(out)].slice(0, 6)
    }

    function reportsByWeak(weak) {
      const s = new Set();
      weak.forEach(x => {
        if (['cashflow', 'forecasting'].includes(x.category)) s.add("CashFlow + To'lov kalendari");
        if (['profitability', 'pricing'].includes(x.category)) s.add('P&L va marja nazorati');
        if (x.category === 'working_capital') s.add('Debitor/Kreditor monitoring');
        if (x.category === 'inventory') s.add('ABC/XYZ (ombor)');
      });
      s.add('Balans (oylik)');
      s.add('Plan-Fakt (oylik)');
      return [...s].slice(0, 7)
    }

    function rp(cx, cy, r, val) {
      const n = val.length;
      return val.map((v, i) => {
        const a = -Math.PI / 2 + i * 2 * Math.PI / n;
        const k = r * (v / 100);
        return [cx + Math.cos(a) * k, cy + Math.sin(a) * k]
      })
    }

    function renderRadar(id, keys, vals) {
      const s = el(id);
      s.innerHTML = '';
      const cx = 170,
        cy = 140,
        r = 90;
      for (let l = 1; l <= 5; l++) {
        const p = rp(cx, cy, r * (l / 5), new Array(keys.length).fill(100));
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        g.setAttribute('points', p.map(x => x.join(',')).join(' '));
        g.setAttribute('fill', 'none');
        g.setAttribute('stroke', '#d9e4df');
        s.appendChild(g)
      }
      keys.forEach((k, i) => {
        const a = -Math.PI / 2 + i * 2 * Math.PI / keys.length;
        const x = cx + Math.cos(a) * r,
          y = cy + Math.sin(a) * r;
        const ln = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        ln.setAttribute('x1', cx);
        ln.setAttribute('y1', cy);
        ln.setAttribute('x2', x);
        ln.setAttribute('y2', y);
        ln.setAttribute('stroke', '#e3ebe8');
        s.appendChild(ln);
        const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        t.setAttribute('x', cx + Math.cos(a) * (r + 20));
        t.setAttribute('y', cy + Math.sin(a) * (r + 20));
        t.setAttribute('font-size', '10');
        t.setAttribute('text-anchor', 'middle');
        t.textContent = LABELS[k] || k;
        s.appendChild(t)
      });
      const d = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
      d.setAttribute('points', rp(cx, cy, r, vals).map(x => x.join(',')).join(' '));
      d.setAttribute('fill', 'rgba(0,58,47,.22)');
      d.setAttribute('stroke', '#003a2f');
      d.setAttribute('stroke-width', '2');
      s.appendChild(d)
    }

    function renderBar(arr) {
      const s = el('weakBar');
      s.innerHTML = '';
      arr.forEach((x, i) => {
        const y = 26 + i * 42,
          w = Math.max(8, x.value * 2.2);
        const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        t.setAttribute('x', 6);
        t.setAttribute('y', y + 15);
        t.setAttribute('font-size', '11');
        t.textContent = LABELS[x.category] || x.category;
        s.appendChild(t);
        const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        bg.setAttribute('x', 130);
        bg.setAttribute('y', y);
        bg.setAttribute('width', 230);
        bg.setAttribute('height', 16);
        bg.setAttribute('fill', '#edf2f0');
        s.appendChild(bg);
        const b = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        b.setAttribute('x', 130);
        b.setAttribute('y', y);
        b.setAttribute('width', w);
        b.setAttribute('height', 16);
        b.setAttribute('fill', '#003a2f');
        s.appendChild(b);
        const v = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        v.setAttribute('x', 368);
        v.setAttribute('y', y + 13);
        v.setAttribute('font-size', '11');
        v.textContent = Math.round(x.value) + '%';
        s.appendChild(v)
      })
    }

    function renderDonut(arr) {
      const map = {
        naqdlik: ['cashflow', 'forecasting'],
        marja: ['profitability', 'pricing'],
        qarz: ['working_capital'],
        ombor: ['inventory'],
        nazorat: ['tax_legal']
      };
      const val = {
        naqdlik: 0,
        marja: 0,
        qarz: 0,
        ombor: 0,
        jarayon: 0,
        nazorat: 0
      };
      arr.forEach(x => Object.keys(map).forEach(k => {
        if (map[k].includes(x.category)) val[k] += 100 - x.value
      }));
      const sum = Object.values(val).reduce((a, b) => a + b, 0) || 1,
        clr = ['#003a2f', '#0b6a58', '#1d8b74', '#67b3a3', '#9acfc3', '#d4ece6'];
      const s = el('problemDonut');
      s.innerHTML = '';
      let st = -Math.PI / 2,
        ci = 0,
        li = 0;
      const pol = (cx, cy, r, a) => ({
        x: cx + r * Math.cos(a),
        y: cy + r * Math.sin(a)
      });
      Object.keys(val).forEach(k => {
        const vv = val[k];
        if (vv <= 0) return;
        const en = st + (vv / sum) * Math.PI * 2,
          p1 = pol(120, 120, 80, st),
          p2 = pol(120, 120, 80, en),
          p3 = pol(120, 120, 42, en),
          p4 = pol(120, 120, 42, st),
          lg = en - st > Math.PI ? 1 : 0;
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d',
          `M ${p1.x} ${p1.y} A 80 80 0 ${lg} 1 ${p2.x} ${p2.y} L ${p3.x} ${p3.y} A 42 42 0 ${lg} 0 ${p4.x} ${p4.y} Z`
          );
        path.setAttribute('fill', clr[ci % clr.length]);
        s.appendChild(path);
        const mark = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        mark.setAttribute('x', 200);
        mark.setAttribute('y', 16 + li * 20);
        mark.setAttribute('width', 12);
        mark.setAttribute('height', 12);
        mark.setAttribute('fill', clr[ci % clr.length]);
        s.appendChild(mark);
        const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        t.setAttribute('x', 220);
        t.setAttribute('y', 25 + li * 20);
        t.setAttribute('font-size', '11');
        t.textContent = `${k}: ${Math.round(vv/sum*100)}%`;
        s.appendChild(t);
        st = en;
        ci++;
        li++
      })
    }

    function renderResult() {
      const fin = computeBlock('finance');
      const overall = fin.percent;
      const weakQ = extremes(false),
        strongQ = extremes(true),
        weak = weakCategories(fin);
      const main = mainConclusion(fin.percent, weak[0] ? weak[0].category : 'cashflow');
      el('overallScore').textContent = overall + '%';
      el('overallLevel').textContent = levelByPercent(overall);
      el('overallLine').textContent = main;
      el('financeScore').textContent = fin.percent + '%';
      el('financeLevel').textContent = levelByPercent(fin.percent);
      el('financeLine').textContent = fin.percent < 50 ? "Pul oqimi va foyda nazorati zaif." : fin.percent < 70 ?
        "Asos bor, lekin intizomni kuchaytirish kerak." : "Moliyaviy tizim barqaror.";
      el('mainConclusion').textContent = main;
      const insights = [];
      if (fin.percent < 50) insights.push("Pul oqimi va foyda nazorati zaif. CashGap bosimi bor.");
      weak.slice(0, 4).forEach(x => insights.push(insightByCategory(x.category)));
      const uniq = [...new Set(insights)].slice(0, 7);
      while (uniq.length < 3) uniq.push('1-3 ustuvor yo`nalishni tanlab haftalik nazoratni ishga tushiring.');
      renderList('insights', uniq);
      renderQA('weakQuestions', weakQ, true);
      renderQA('strongQuestions', strongQ, false);
      renderList('quickPlan', planByWeak(weak));
      renderList('neededReports', reportsByWeak(weak));
      const fk = ['cashflow', 'profitability', 'forecasting', 'working_capital', 'inventory', 'pricing', 'tax_legal'];
      renderRadar('financeRadar', fk, fk.map(k => fin.categoryPercent[k] || 0));
      renderBar(weak);
      renderDonut(weak);
      app.result = {
        overall,
        fin,
        weak,
        weakQ,
        strongQ,
        main,
        insights: uniq,
        plan: planByWeak(weak),
        reports: reportsByWeak(weak)
      }
    }

    function validateIntro() {
      const name = el('fullName').value.trim(),
        phone = el('phone').value.trim(),
        business = el('businessName').value.trim(),
        sector = el('sector').value;
      const ok = name && phone && business && sector;
      el('introErr').style.display = ok ? 'none' : 'block';
      if (ok) {
        app.user = {
          name,
          phone,
          business,
          sector
        }
      }
      return ok
    }

    async function loadLogoMeta() {
      return new Promise(resolve => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          const c = document.createElement('canvas');
          c.width = img.width;
          c.height = img.height;
          const x = c.getContext('2d');
          x.drawImage(img, 0, 0);
          resolve({
            dataUrl: c.toDataURL('image/png'),
            width: img.width,
            height: img.height
          });
        };
        img.onerror = () => resolve(null);
        img.src = 'assets/img/logo.png';
      });
    }
    async function svgToPngDataUrl(id) {
      const svg = el(id);
      if (!svg) return null;
      const xml = new XMLSerializer().serializeToString(svg);
      const blob = new Blob([xml], {
        type: 'image/svg+xml;charset=utf-8'
      });
      const url = URL.createObjectURL(blob);
      const vb = svg.viewBox && svg.viewBox.baseVal;
      const width = (vb && vb.width) ? vb.width : (svg.clientWidth || 360);
      const height = (vb && vb.height) ? vb.height : (svg.clientHeight || 220);
      return await new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
          const c = document.createElement('canvas');
          c.width = width;
          c.height = height;
          const ctx = c.getContext('2d');
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, width, height);
          ctx.drawImage(img, 0, 0, width, height);
          URL.revokeObjectURL(url);
          resolve(c.toDataURL('image/png'));
        };
        img.onerror = () => {
          URL.revokeObjectURL(url);
          resolve(null)
        };
        img.src = url;
      });
    }

    function addTextList(doc, title, items, startY, page) {
      const maxW = 515;
      let y = startY;
      const ensure = (h) => {
        if (y + h > page.h - 40) {
          doc.addPage();
          y = 40;
        }
      };
      ensure(20);
      doc.setFontSize(12);
      doc.setTextColor(0, 58, 47);
      doc.text(title, 40, y);
      y += 16;
      doc.setTextColor(20, 35, 30);
      doc.setFontSize(10.5);
      items.forEach(line => {
        const rows = doc.splitTextToSize('- ' + line, maxW);
        ensure(rows.length * 13 + 4);
        doc.text(rows, 40, y);
        y += rows.length * 13 + 4;
      });
      return y + 4;
    }
    async function buildPdfBlob() {
      if (!window.jspdf || !window.jspdf.jsPDF) throw new Error('PDF kutubxonasi yuklanmadi');
      const {
        jsPDF
      } = window.jspdf;
      const doc = new jsPDF({
        unit: 'pt',
        format: 'a4'
      });
      const page = {
        w: 595,
        h: 842
      };
      let y = 0;

      doc.setFillColor(0, 58, 47);
      doc.rect(0, 0, page.w, 96, 'F');

      const logo = await loadLogoMeta();
      if (logo) {
        const maxW = 130,
          maxH = 54;
        const ratio = Math.min(maxW / logo.width, maxH / logo.height);
        const w = logo.width * ratio,
          h = logo.height * ratio;
        doc.addImage(logo.dataUrl, 'PNG', 38, 21, w, h);
      } else {
        doc.setFontSize(18);
        doc.setTextColor(255, 255, 255);
        doc.text('GEKTO', 40, 54);
      }

      doc.setTextColor(255, 255, 255);
      doc.setFontSize(20);
      const title = 'Biznes Diagnostika Hisoboti';
      const tw = doc.getTextWidth(title);
      doc.text(title, (page.w - tw) / 2, 56);

      y = 120;
      doc.setFillColor(244, 250, 247);
      doc.roundedRect(36, y, 523, 96, 10, 10, 'F');
      doc.setDrawColor(212, 231, 223);
      doc.roundedRect(36, y, 523, 96, 10, 10, 'S');
      doc.setTextColor(0, 58, 47);
      doc.setFontSize(11);
      doc.text('Mijoz ma\'lumotlari', 52, y + 22);
      doc.setTextColor(20, 35, 30);
      doc.setFontSize(12);
      doc.text(`Biznes nomi: ${app.user.business}`, 52, y + 44);
      doc.text(`Sohasi: ${app.user.sector}`, 52, y + 64);
      doc.text(`Ism: ${app.user.name}`, 320, y + 44);
      doc.text(`Telefon: ${app.user.phone}`, 320, y + 64);

      y += 118;
      doc.setFontSize(16);
      doc.setTextColor(0, 58, 47);
      doc.text('Natijalar', 40, y);
      y += 12;

      const cards = [{
          label: 'Moliyaviy',
          v: `${app.result.fin.percent}%`,
          lvl: levelByPercent(app.result.fin.percent)
        }
      ];
      let cx = 40;
      cards.forEach(c => {
        doc.setFillColor(250, 253, 252);
        doc.roundedRect(cx, y, 166, 70, 8, 8, 'F');
        doc.setDrawColor(220, 234, 228);
        doc.roundedRect(cx, y, 166, 70, 8, 8, 'S');
        doc.setFontSize(10);
        doc.setTextColor(80, 95, 89);
        doc.text(c.label, cx + 10, y + 16);
        doc.setFontSize(20);
        doc.setTextColor(0, 58, 47);
        doc.text(c.v, cx + 10, y + 40);
        doc.setFontSize(9.5);
        doc.setTextColor(60, 72, 67);
        doc.text(c.lvl, cx + 10, y + 56);
        cx += 178;
      });
      y += 84;

      const chartMeta = [{
          id: 'financeRadar',
          title: 'Finance Radar'
        },
        {
          id: 'weakBar',
          title: 'Eng past kategoriyalar'
        },
        {
          id: 'problemDonut',
          title: 'Muammo turlari'
        }
      ];
      const chartImages = await Promise.all(chartMeta.map(c => svgToPngDataUrl(c.id)));
      const cardX = 40,
        cardW = 515,
        cardH = 190,
        pad = 12;
      chartImages.forEach((img, i) => {
        if (!img) return;
        if (y + cardH + 24 > page.h - 40) {
          doc.addPage();
          y = 40;
        }
        doc.setFillColor(255, 255, 255);
        doc.roundedRect(cardX, y, cardW, cardH, 8, 8, 'F');
        doc.setDrawColor(220, 234, 228);
        doc.roundedRect(cardX, y, cardW, cardH, 8, 8, 'S');
        doc.setFontSize(11);
        doc.setTextColor(0, 58, 47);
        doc.text(chartMeta[i].title, cardX + 12, y + 18);
        doc.addImage(img, 'PNG', cardX + pad, y + 26, cardW - pad * 2, cardH - 38);
        y += cardH + 14;
      });

      y = addTextList(doc, 'Asosiy xulosa', [app.result.main], y, page);
      y = addTextList(doc, 'Tavsiyalar', app.result.insights, y, page);
      y = addTextList(doc, 'Top-5 zaif savollar', app.result.weakQ.map(x => `${x.score}/5 - ${x.text}`), y, page);
      y = addTextList(doc, 'Top-5 kuchli savollar', app.result.strongQ.map(x => `${x.score}/5 - ${x.text}`), y, page);
      y = addTextList(doc, '7 kunlik reja', app.result.plan, y, page);
      y = addTextList(doc, 'Kerak bo`ladigan hisobotlar', app.result.reports, y, page);

      if (y + 90 > page.h - 40) {
        doc.addPage();
        y = 40;
      }
      doc.setTextColor(30, 45, 39);
      doc.setFontSize(11);
      doc.text("Agar ushbu masalalarni hal qilishni xohlasangiz, quyidagi kontaktlar orqali biz bilan bog'laning.",
        40, y);
      y += 20;
      doc.setDrawColor(212, 231, 223);
      doc.line(40, y, page.w - 40, y);
      y += 18;
      doc.setFontSize(12);
      doc.setTextColor(0, 58, 47);
      doc.text('Kontaktlar', 40, y);
      y += 16;
      doc.setFontSize(11);
      doc.setTextColor(20, 35, 30);
      doc.text(`Tel: ${CONTACTS.tel1} / ${CONTACTS.tel2}`, 40, y);
      y += 14;
      doc.text(`Telegram: ${CONTACTS.telegram}`, 40, y);
      y += 14;
      doc.text(`Mail: ${CONTACTS.mail}`, 40, y);
      y += 14;
      doc.text(`Adres: ${CONTACTS.address}`, 40, y);

      return doc.output('blob');
    }
    async function sendViaEndpoint(pdfBase64) {
      const payload = {
        name: app.user.name,
        phone: app.user.phone,
        company: app.user.business,
        sector: app.user.sector,
        page: location.href,
        secret: SECRET,
        summary: `Moliyaviy: ${app.result.fin.percent}%`,
        pdf: pdfBase64 || ''
      };
      try {
        const r = await fetch(ENDPOINT, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        if (!r.ok) return false;
        const j = await r.json().catch(() => null);
        return !!(j && j.ok);
      } catch {
        return false;
      }
    }
    async function sendPdfToTelegram(blob) {
      const pdf64 = await new Promise(res => {
        const fr = new FileReader();
        fr.onload = () => res(String(fr.result).split(',')[1] || '');
        fr.onerror = () => res('');
        fr.readAsDataURL(blob)
      });
      return await sendViaEndpoint(pdf64 || '');
    }
    async function onPdfAndSend() {
      try {
        const blob = await buildPdfBlob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'gekto-diagnostika.pdf';
        a.click();
        URL.revokeObjectURL(url);
        const sent = await sendPdfToTelegram(blob);
        if (sent) {
          alert('PDF yuklandi va so\'rov Telegramga yuborildi.')
        } else {
          alert('PDF yuklandi, lekin yuborishda xatolik bo\'ldi.')
        }
      } catch (e) {
        alert('PDF yaratishda xatolik: ' + e.message)
      }
    }

    function initEvents() {
      el('goMode').addEventListener('click', () => {
        if (!validateIntro()) return;
        show('screen-mode')
      });
      el('backIntro').addEventListener('click', () => show('screen-intro'));
      document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener('change', renderModeCards));
      el('modeNormalCard').addEventListener('click', () => {
        document.querySelector('input[name="mode"][value="normal"]').checked = true;
        renderModeCards()
      });
      el('modeDeepCard').addEventListener('click', () => {
        document.querySelector('input[name="mode"][value="deep"]').checked = true;
        renderModeCards()
      });
      el('startTest').addEventListener('click', () => {
        app.mode = document.querySelector('input[name="mode"]:checked').value;
        app.questions = buildQuestions(app.mode);
        app.current = 0;
        app.answers = {};
        show('screen-quiz');
        renderQuestion()
      });
      el('quizBack').addEventListener('click', () => {
        saveCurrent();
        if (app.current > 0) app.current--;
        renderQuestion()
      });
      el('quizNext').addEventListener('click', () => {
        saveCurrent();
        if (app.current < app.questions.length - 1) {
          app.current++;
          renderQuestion();
          return;
        }
        show('screen-result');
        try {
          renderResult();
        } catch (e) {
          console.error('renderResult error:', e);
          const line = el('overallLine');
          if (line) line.textContent = 'Natijani hisoblashda xatolik yuz berdi. Sahifani yangilab qayta urinib ko`ring.';
        }
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        })
      });
      el('printResult').addEventListener('click', () => window.print());
      el('pdfAndSend').addEventListener('click', onPdfAndSend);
    }
    (function init() {
      fillSectors();
      initEvents();
      const header = document.querySelector('header.main-header');
      if (header) {
        const t = () => header.classList.toggle('scrolled', window.scrollY > 10);
        t();
        window.addEventListener('scroll', t, {
          passive: true
        })
      }
      if (window.jQuery) {
        jQuery(window).on('load', function () {
          new WOW().init();
        });
      } else {
        new WOW().init();
      }
    })();
  </script>
</body>

</html>
